<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MysteryAI - Geocaching</title>
    <script>
        // Définir openImageEditor globalement avant tout
        window.openImageEditor = function(imageId, imageName) {
            console.log('=== DEBUG: Tentative d\'ouverture de l\'éditeur d\'image ===');
            console.log('Params:', { imageId, imageName });
            console.log('Layout actuel:', mainLayout);
            console.log('Root items:', mainLayout.root.contentItems);
            
            // Vérifier si GoldenLayout est initialisé
            if (!window.goldenlayout) {
                console.error('=== DEBUG: GoldenLayout n\'est pas encore initialisé ===');
                return;
            }

            try {
                // Trouver le conteneur principal (row)
                const rootContentItem = mainLayout.root.contentItems[0];
                
                // Configuration du composant
                const componentConfig = {
                    type: 'component',
                    componentName: 'image-editor',
                    componentState: { 
                        imageId: imageId,
                        imageName: imageName
                    },
                    title: `Éditeur - ${imageName || `Image ${imageId}`}`,
                    id: `image-editor-${imageId}`
                };

                // Si c'est un stack, ajouter directement
                if (rootContentItem.isStack) {
                    rootContentItem.addChild(componentConfig);
                } else {
                    // Sinon, trouver ou créer un stack
                    let stack = rootContentItem.contentItems.find(item => item.isStack);
                    if (!stack) {
                        stack = mainLayout.createContentItem({
                            type: 'stack',
                            content: []
                        });
                        rootContentItem.addChild(stack);
                    }
                    stack.addChild(componentConfig);
                }

                console.log('=== DEBUG: Composant éditeur ajouté avec succès ===');
            } catch (error) {
                console.error('=== DEBUG: Erreur lors de l\'ajout de l\'éditeur ===', error);
            }
        };

        console.log('=== DEBUG: Index.html commence à charger ===');
        
        // Fonction pour initialiser le menu contextuel
        function initContextMenu() {
            console.log('=== DEBUG: Initialisation du menu contextuel ===');
            
            // Utiliser la délégation d'événements pour gérer le clic droit sur les images
            document.body.addEventListener('contextmenu', function(e) {
                console.log('=== DEBUG: Événement contextmenu détecté ===');
                console.log('Target:', e.target);
                console.log('Target classList:', e.target.classList);
                
                // Vérifier si l'élément cliqué ou un de ses parents est une image de géocache
                const targetImage = e.target.closest('.geocache-image');
                console.log('Image trouvée:', !!targetImage);
                
                if (targetImage) {
                    console.log('=== DEBUG: Clic droit sur une image de géocache ===');
                    e.preventDefault();
                    e.stopPropagation();

                    // Retirer la sélection de toutes les images
                    document.querySelectorAll('.geocache-image').forEach(img => {
                        img.classList.remove('selected');
                    });

                    // Sélectionner l'image actuelle
                    targetImage.classList.add('selected');

                    // Vérifier si window.electron existe
                    console.log('=== DEBUG: window.electron existe:', !!window.electron);
                    console.log('=== DEBUG: window.electron:', window.electron);

                    // Si nous sommes dans Electron, utiliser le menu contextuel natif
                    if (window.electron) {
                        console.log('=== DEBUG: Utilisation du menu Electron ===');
                        const imageData = {
                            imageId: targetImage.dataset.imageId,
                            imageName: targetImage.dataset.imageName
                        };
                        const position = {
                            x: e.clientX,
                            y: e.clientY
                        };
                        console.log('=== DEBUG: Image data:', imageData);
                        console.log('=== DEBUG: Position:', position);
                        window.electron.showImageContextMenu(imageData, position);
                    } else {
                        console.log('=== DEBUG: Utilisation du menu web ===');
                        // Fallback pour le navigateur web
                        const rect = targetImage.getBoundingClientRect();
                        showWebContextMenu(rect.left, rect.top, targetImage.dataset.imageId, targetImage.dataset.imageName);
                    }
                }
            });
        }

        // Fonction pour afficher le menu contextuel web
        function showWebContextMenu(x, y, imageId, imageName) {
            // Supprimer tout menu contextuel existant
            const existingMenu = document.querySelector('.context-menu');
            if (existingMenu) {
                existingMenu.remove();
            }

            const contextMenu = document.createElement('div');
            contextMenu.className = 'context-menu';
            contextMenu.innerHTML = `
                <div class="context-menu-item edit-image">
                    <i class="fas fa-edit"></i>
                    Éditer l'image
                </div>
            `;

            // Positionner le menu
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            document.body.appendChild(contextMenu);

            // Gérer le clic sur l'option d'édition
            contextMenu.querySelector('.edit-image').addEventListener('click', function() {
                window.openImageEditor(imageId, imageName);
                contextMenu.remove();
            });

            // Fermer le menu au clic en dehors
            function handleClickOutside(e) {
                if (!contextMenu.contains(e.target)) {
                    contextMenu.remove();
                    document.removeEventListener('click', handleClickOutside);
                }
            }

            // Attendre un peu avant d'ajouter le gestionnaire de clic
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 0);
        }

        // Initialiser le menu contextuel au chargement du DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initContextMenu);
        } else {
            initContextMenu();
        }
    </script>
    
    <!-- Styles -->
    <link type="text/css" rel="stylesheet" href="/css/output.css">
    <link type="text/css" rel="stylesheet" href="/vendor/golden-layout/goldenlayout-base.css">
    <link type="text/css" rel="stylesheet" href="/vendor/golden-layout/goldenlayout-dark-theme.css">
    <link rel="stylesheet" href="/vendor/fontawesome/css/all.min.css">
    <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="https://unpkg.com/htmx.org@2.0.4" integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>
    
    <style>
        /* Custom styles for VSCode-like layout */
        .workspace-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            background-color: #1e1e1e;
            position: relative; /* Ajout de position relative */
        }
        
        .sidebar {
            width: 48px;
            flex-shrink: 0;
            z-index: 10;
            background-color: #252526;
            border-right: 1px solid #3c3c3c;
        }

        .sidebar.right-sidebar {
            border-right: none;
            border-left: 1px solid #3c3c3c;
            order: 3;
        }
        
        .panel-container {
            display: flex;
            flex: 1;
            position: relative;
            background-color: #1e1e1e;
            order: 2;
            overflow: hidden;
        }
        
        .side-panel {
            width: 250px;
            height: 100%;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            transform: translateX(-100%);
            transition: transform 0.15s ease-out;
            z-index: 5;
            background-color: #252526;
            border-right: 1px solid #3c3c3c;
            opacity: 0;
        }

        .side-panel.right-panel {
            left: auto;
            right: 0;
            transform: translateX(100%);
            border-right: none;
            border-left: 1px solid #3c3c3c;
            position: fixed;
            top: 0;
            bottom: 22px; /* Hauteur de la barre de statut */
            width: 250px;
        }

        .side-panel.visible {
            transform: translateX(0);
            opacity: 1;
        }

        .resizer {
            position: absolute;
            right: -5px;
            top: 0;
            bottom: 0;
            width: 10px;
            cursor: ew-resize;
            z-index: 15;
            pointer-events: none;
        }

        .right-panel .resizer {
            right: auto;
            left: -5px;
        }

        .side-panel.visible .resizer {
            pointer-events: all;
        }

        .resizer:hover, .resizing {
            background-color: #007fd4;
            opacity: 0.4;
        }
        
        .main-content {
            flex: 1;
            margin-left: 0;
            margin-right: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: margin 0.15s ease-out;
            overflow: hidden;
        }

        .main-content.shifted-left {
            margin-left: 250px;
        }

        .main-content.shifted-right {
            margin-right: 250px;
        }

        .golden-layout-container {
            flex: 1;
            min-height: 0;
            transition: height 0.15s ease-out;
        }

        .bottom-panel-container {
            display: flex;
            flex-direction: column;
            height: 35px;
            min-height: 35px;
            max-height: 800px;
            background-color: #1e1e1e;
            transition: height 0.3s ease;
            overflow: hidden;
            border-top: 1px solid #3c3c3c;
            position: relative;
        }

        .bottom-panel-container.expanded {
            height: 300px;
        }

        .bottom-panel-header {
            flex-shrink: 0;
            background-color: #2d2d2d;
            border-bottom: 1px solid #3c3c3c;
            padding: 4px 0;
            user-select: none;
            z-index: 10;
        }

        .bottom-panel-tabs {
            display: flex;
            gap: 1rem;
            padding: 0 1rem;
        }

        .bottom-panel-content {
            flex: 1;
            overflow: auto;
            background-color: #1e1e1e;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .panel-content {
            display: none;
            padding: 1rem;
            height: 100%;
            color: #e1e1e1;
            background-color: #1e1e1e;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .panel-content.active {
            display: block !important;
        }

        .bottom-panel-tab {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            transition: color 0.2s;
            position: relative;
            outline: none;
        }

        .bottom-panel-tab:hover {
            color: #c9d1d9;
        }

        .bottom-panel-tab.active {
            color: #58a6ff;
        }

        .bottom-panel-tab.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #58a6ff;
        }

        .bottom-panel-tab i {
            margin-right: 0.5rem;
        }

        /* Style pour la poignée de redimensionnement du panneau inférieur */
        .bottom-panel-resizer {
            width: 100%;
            height: 4px;
            cursor: ns-resize;
            position: absolute;
            top: 0;
            left: 0;
            background: transparent;
            z-index: 20;
        }

        .bottom-panel-resizer:hover,
        .bottom-panel-resizer.resizing {
            background: #58a6ff;
        }

        .bottom-panel-container {
            display: flex;
            flex-direction: column;
            height: 35px;
            min-height: 35px;
            max-height: 800px;
            background-color: #1e1e1e;
            transition: height 0.3s ease;
            overflow: hidden;
            border-top: 1px solid #3c3c3c;
            position: relative;
        }

        /* Désactiver les transitions pendant le redimensionnement */
        .resizing .bottom-panel-container,
        .resizing .golden-layout-container {
            transition: none !important;
        }

        /* Styles pour le chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 1rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            background-color: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 0.5rem;
            color: #fff;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: #007fd4;
        }

        .chat-send-button {
            background-color: #007fd4;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            color: white;
            cursor: pointer;
        }

        .chat-send-button:hover {
            background-color: #1a8ad4;
        }
        
        .status-bar {
            height: 22px;
            background-color: #252526;
            border-top: 1px solid #3c3c3c;
            color: #cccccc;
            position: relative;
            z-index: 5; /* Au-dessus du panneau */
        }

        /* Styles pour le panneau inférieur */
        .bottom-panel-resizer {
            position: absolute;
            left: 0;
            right: 0;
            top: -5px;
            height: 10px;
            cursor: ns-resize;
            z-index: 15;
        }

        .bottom-panel-resizer:hover {
            background-color: #007fd4;
            opacity: 0.4;
        }

        /* Ajustement du panneau droit quand le panneau inférieur est ouvert */
        .side-panel.right-panel.with-bottom-panel {
            bottom: 322px; /* 300px + 22px */
        }

        /* Style pour les panneaux de contenu */
        .side-panel-content {
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .panel-content {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
        }

        .panel-content.active {
            display: block;
        }

        .panel-header {
            position: sticky;
            top: 0;
            background-color: #252526;
            z-index: 1;
        }

        .panel-body {
            height: calc(100% - 3rem);
            overflow: auto;
        }

        .bottom-panel-tab {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            transition: color 0.2s;
        }

        .bottom-panel-tab:hover {
            color: #c9d1d9;
        }

        .bottom-panel-tab.active {
            color: #58a6ff;
            border-bottom: 2px solid #58a6ff;
        }

        .bottom-panel-tab i {
            margin-right: 0.5rem;
        }

        /* Style pour les composants GoldenLayout */
        .lm_content {
            position: absolute !important;
            width: 100% !important;
            height: 100% !important;
            overflow: auto !important;
            display: flex !important;
            flex-direction: column !important;
        }

        /* Style pour le contenu des composants */
        .lm_content > div {
            flex: 1 1 auto;
            min-height: 0;
            overflow: auto;
            position: relative;
        }

        /* Style pour les iframes dans GoldenLayout */
        .lm_content iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* Assurer que le contenu des composants remplit l'espace disponible */
        .lm_item {
            overflow: hidden !important;
        }

        /* Style pour la barre de défilement */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: #3c3c3c;
            border-radius: 5px;
            border: 2px solid #1e1e1e;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4c4c4c;
        }

        ::-webkit-scrollbar-corner {
            background: #1e1e1e;
        }

        /* Cacher les barres de défilement par défaut et les montrer au survol */
        .lm_content {
            scrollbar-width: thin;
            scrollbar-color: #3c3c3c #1e1e1e;
        }

        /* Support pour Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: #3c3c3c #1e1e1e;
        }

        /* Styles de base pour GoldenLayout */
        .golden-layout-container {
            flex: 1;
            min-height: 0; /* Important pour que flex fonctionne correctement */
            position: relative;
        }

        /* Conteneur principal de GoldenLayout */
        .lm_goldenlayout {
            width: 100%;
            height: 100%;
            position: absolute !important;
        }

        /* Conteneur des éléments */
        .lm_item_container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Contenu des composants */
        .lm_content {
            width: 100% !important;
            height: 100% !important;
            overflow: hidden !important;
            position: relative !important;
        }

        /* Style pour les composants spécifiques */
        .lm_content > div {
            width: 100%;
            height: 100%;
            overflow: auto;
            padding: 10px;
        }

        /* Style pour les iframes */
        .lm_content iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Styles pour la barre de défilement */
        .lm_content > div::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .lm_content > div::-webkit-scrollbar-track {
            background: #1e1e1e;
            border-radius: 6px;
        }

        .lm_content > div::-webkit-scrollbar-thumb {
            background-color: #3c3c3c;
            border-radius: 6px;
            border: 3px solid #1e1e1e;
        }

        .lm_content > div::-webkit-scrollbar-thumb:hover {
            background-color: #4c4c4c;
        }

        .lm_content > div::-webkit-scrollbar-corner {
            background: #1e1e1e;
        }

        /* Support Firefox */
        .lm_content > div {
            scrollbar-width: thin;
            scrollbar-color: #3c3c3c #1e1e1e;
        }

        /* Styles spécifiques pour les tableaux */
        .tabulator {
            height: 100% !important;
            max-height: none !important;
        }

        .tabulator-tableholder {
            overflow-y: auto !important;
            overflow-x: auto !important;
        }

        /* Ajout de styles pour le menu contextuel */
        .geocache-image {
            cursor: pointer;
        }

        .geocache-image.selected {
            outline: 2px solid #3b82f6;
            outline-offset: -2px;
        }

        .context-menu {
            position: fixed;
            z-index: 10000;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.375rem;
            padding: 0.5rem 0;
            min-width: 160px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .context-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: #e5e7eb;
            transition: background-color 0.2s;
            user-select: none;
        }

        .context-menu-item:hover {
            background-color: #374151;
        }

        .context-menu-item i {
            margin-right: 0.5rem;
            width: 1rem;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300 h-screen flex flex-col overflow-hidden">
    <!-- Main Container -->
    <div class="workspace-container">
        <!-- Left Sidebar -->
        <div class="sidebar bg-gray-800 border-r border-gray-700 flex flex-col">
            <div class="flex-1 flex flex-col items-center py-2 space-y-4">
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="geocaches" data-side="left"
                        hx-get="/api/zones"
                        hx-target="#geocaches-panel-content"
                        hx-swap="innerHTML"
                        hx-trigger="load">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="search" data-side="left">
                    <i class="fas fa-search text-xl"></i>
                </button>
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="git" data-side="left">
                    <i class="fas fa-code-branch text-xl"></i>
                </button>
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="decrypt" data-side="left"
                        hx-get="/api/plugins_list"
                        hx-target="#decrypt-panel .panel-body"
                        hx-trigger="load">
                    <i class="fas fa-key text-xl"></i>
                </button>
            </div>
            <div class="mt-auto flex flex-col items-center py-2 space-y-4">
                <button class="text-gray-400 hover:text-white w-full py-2 flex justify-center sidebar-button" title="Settings" data-panel="settings" data-side="left">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </div>
        </div>

        <div class="panel-container">
            <!-- Left Panel -->
            <div id="left-panel" class="side-panel bg-gray-800 border-r border-gray-700">
                <div class="resizer"></div>
                <div class="side-panel-content">
                    <div id="geocaches-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Géocaches</h2>
                        </div>
                        <div id="geocaches-panel-content" class="panel-body">
                            <!-- Le contenu sera chargé ici par HTMX -->
                        </div>
                    </div>
                    <div id="search-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Recherche</h2>
                        </div>
                        <div class="panel-body">
                            <!-- Contenu du panneau de recherche -->
                        </div>
                    </div>
                    <div id="git-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Source Control</h2>
                        </div>
                        <div class="panel-body">
                            <!-- Contenu du panneau git -->
                        </div>
                    </div>
                    <div id="decrypt-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Décryptage</h2>
                        </div>
                        <div class="panel-body">
                            <!-- Contenu du panneau de décryptage -->
                        </div>
                    </div>
                    <div id="settings-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Paramètres</h2>
                        </div>
                        <div class="panel-body">
                            <!-- Contenu du panneau des paramètres -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div id="main-content" class="main-content bg-gray-900">
                <div id="layoutContainer" class="golden-layout-container"></div>
                
                <!-- Bottom Panel -->
                <div class="bottom-panel-container">
                    <div class="bottom-panel-resizer"></div>
                    <div class="bottom-panel-header">
                        <div class="bottom-panel-tabs">
                            <button class="bottom-panel-tab active" data-panel="map-panel">
                                <i class="fas fa-map-marked-alt"></i>Map
                            </button>
                            <button class="bottom-panel-tab" data-panel="notes-panel">
                                <i class="fas fa-sticky-note"></i>Notes
                            </button>
                            <button class="bottom-panel-tab" data-panel="informations-panel">
                                <i class="fas fa-info-circle"></i>Informations
                            </button>
                        </div>
                    </div>
                    <div class="bottom-panel-content">
                        <div id="map-panel" class="panel-content active">
                            <h3>Panneau de Carte</h3>
                            <p>Ici vous pouvez voir la carte interactive des géocaches. Cliquez sur une géocache pour voir ses détails.</p>
                        </div>
                        <div id="notes-panel" class="panel-content">
                            <h3>Panneau de Notes</h3>
                            <p>Cet espace est dédié à la prise de notes et aux annotations personnelles sur vos géocaches.</p>
                        </div>
                        <div id="informations-panel" class="panel-content">
                            <h3>Panneau d'Informations</h3>
                            <p>Retrouvez ici toutes les informations importantes sur le système et les mises à jour.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="side-panel right-panel bg-gray-800">
                <div class="resizer"></div>
                <div id="chat-panel" class="chat-container">
                    <h2 class="text-sm font-semibold mb-4">CHAT IA</h2>
                    <div class="chat-messages">
                        <!-- Les messages du chat apparaîtront ici -->
                    </div>
                    <div class="chat-input-container">
                        <textarea class="chat-input" rows="3" placeholder="Tapez votre message..."></textarea>
                        <button class="chat-send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="sidebar right-sidebar bg-gray-800 flex flex-col">
            <div class="flex-1 flex flex-col items-center py-2 space-y-4">
                <button class="text-gray-400 hover:text-white w-full py-2 flex justify-center sidebar-button" title="Chat IA" data-panel="chat" data-side="right">
                    <i class="fas fa-comments text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar flex items-center px-2 text-sm">
        <div class="flex-1">Ready</div>
        <div class="flex items-center space-x-4">
            <span>UTF-8</span>
            <span>JavaScript</span>
            <span>Ln 1, Col 1</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/golden-layout/goldenlayout.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script>
        // Variables globales
        let mainContent, leftPanel, rightPanel, bottomPanel, goldenLayoutContainer, bottomPanelResizer;
        let activeLeftButton = null;
        let activeRightButton = null;
        let activeLeftPanelId = null;
        let activeRightPanelId = null;
        let isResizing = false;
        let activePanel = null;
        let isBottomPanelVisible = false;
        let startY, startHeight;
        let mainLayout;

        // Configuration de l'URL de base pour l'API
        window.API_BASE_URL = 'http://127.0.0.1:3000';

        // Fonction pour charger les zones
        function loadZones() {
            const target = document.querySelector('.side-panel-content');
            if (!target) {
                console.error('Conteneur de panneau non trouvé');
                return;
            }

            fetch('/api/zones', {
                method: 'GET',
                headers: {
                    'HX-Request': 'true'
                }
            })
            .then(response => response.text())
            .then(html => {
                target.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                target.innerHTML = '<div class="p-4 text-red-500">Erreur lors du chargement des zones</div>';
            });
        }

        // Gestion des onglets du panneau inférieur
        function showPanel(panelId) {
            // Vérifier que les éléments existent avant de manipuler leurs classes
            const selectedTab = document.querySelector(`.bottom-panel-tab[data-panel="${panelId}"]`);
            const selectedPanel = document.getElementById(panelId);
            const bottomPanelContainer = document.querySelector('.bottom-panel-container');

            if (!selectedTab || !selectedPanel || !bottomPanelContainer) {
                console.error(`Onglet ou panneau introuvable pour l'ID: ${panelId}`);
                return;
            }

            // Si on clique sur l'onglet actif, on bascule la visibilité du panneau
            if (selectedTab.classList.contains('active')) {
                bottomPanelContainer.classList.toggle('expanded');
            } else {
                // Sinon, on active le nouvel onglet et on s'assure que le panneau est ouvert
                // Retirer la classe active de tous les onglets et panneaux
                document.querySelectorAll('.bottom-panel-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.panel-content').forEach(panel => {
                    panel.classList.remove('active');
                });
                
                // Activer l'onglet et le panneau sélectionnés
                selectedTab.classList.add('active');
                selectedPanel.classList.add('active');
                bottomPanelContainer.classList.add('expanded');

                // Si le panneau est réduit, on l'agrandit
                const currentHeight = parseInt(window.getComputedStyle(bottomPanelContainer).height);
                if (currentHeight <= 35) {
                    bottomPanelContainer.style.height = '300px';
                }
            }

            // Mettre à jour la taille de Golden Layout
            if (window.mainLayout) {
                window.mainLayout.updateSize();
            }
        }

        // Gestion des panneaux latéraux
        function showSidePanel(panelId, isRight) {
            const panel = isRight ? rightPanel : leftPanel;
            const button = document.querySelector(`.sidebar-button[data-panel="${panelId}"]`);
            const shiftClass = isRight ? 'shifted-right' : 'shifted-left';
            
            if ((isRight && activeRightButton === button) || (!isRight && activeLeftButton === button)) {
                // Fermeture du panneau actif
                button.classList.remove('active');
                panel.classList.remove('visible');
                mainContent.classList.remove(shiftClass);
                
                panel.style.width = '250px';
                if (isRight) {
                    mainContent.style.marginRight = '0';
                    panel.style.transform = 'translateX(100%)';
                    activeRightButton = null;
                    activeRightPanelId = null;
                } else {
                    mainContent.style.marginLeft = '0';
                    panel.style.transform = 'translateX(-100%)';
                    activeLeftButton = null;
                    activeLeftPanelId = null;
                }
            } else {
                // Fermeture du panneau précédent du même côté s'il existe
                if (isRight && activeRightButton) {
                    activeRightButton.classList.remove('active');
                    rightPanel.classList.remove('visible');
                    mainContent.classList.remove('shifted-right');
                    rightPanel.style.transform = 'translateX(100%)';
                } else if (!isRight && activeLeftButton) {
                    activeLeftButton.classList.remove('active');
                    leftPanel.classList.remove('visible');
                    mainContent.classList.remove('shifted-left');
                    leftPanel.style.transform = 'translateX(-100%)';
                }
                
                // Ouverture du nouveau panneau
                button.classList.add('active');
                panel.classList.add('visible');
                mainContent.classList.add(shiftClass);
                
                panel.style.transform = 'translateX(0)';
                const currentWidth = panel.style.width || '250px';
                if (isRight) {
                    mainContent.style.marginRight = currentWidth;
                    activeRightButton = button;
                    activeRightPanelId = panelId;
                } else {
                    mainContent.style.marginLeft = currentWidth;
                    activeLeftButton = button;
                    activeLeftPanelId = panelId;
                }
                
                // Charger le contenu du panneau si nécessaire
                loadPanelContent(panelId, isRight);
            }

            if (window.mainLayout) {
                setTimeout(() => {
                    window.mainLayout.updateSize();
                }, 300);
            }
        }

        // Chargement du contenu des panneaux latéraux
        function loadPanelContent(panelId, isRight) {
            const panel = isRight ? rightPanel : leftPanel;
            const panelContent = panel.querySelector('.side-panel-content');
            
            if (!panelContent) {
                console.error('Conteneur de contenu non trouvé dans le panneau');
                return;
            }

            // Masquer tous les panneaux de contenu
            panelContent.querySelectorAll('.panel-content').forEach(content => {
                content.classList.remove('active');
            });

            // Afficher le panneau sélectionné
            const selectedPanel = document.getElementById(`${panelId}-panel`);
            if (selectedPanel) {
                selectedPanel.classList.add('active');
                if (panelId === 'geocaches') {
                    // Le contenu est déjà chargé par HTMX au chargement initial
                    console.log('Panneau geocaches activé');
                }
            } else {
                console.warn(`Panneau ${panelId} non trouvé, création d'un panneau par défaut`);
                // Créer un panneau par défaut s'il n'existe pas
                const defaultPanel = document.createElement('div');
                defaultPanel.id = `${panelId}-panel`;
                defaultPanel.className = 'h-full p-4 panel-content active';
                defaultPanel.innerHTML = `
                    <div class="panel-header border-b border-gray-700 p-2">
                        <h2 class="text-lg font-semibold">${panelId.charAt(0).toUpperCase() + panelId.slice(1)}</h2>
                    </div>
                    <div class="panel-body">
                        <p class="text-gray-400 mt-4">Contenu en cours de développement</p>
                    </div>
                `;
                panelContent.appendChild(defaultPanel);
            }
        }

        // Fonction de gestion du redimensionnement
        function handleResize(e, panel, isRight) {
            if (!isResizing) return;

            if (panel === bottomPanel) {
                // Gestion du redimensionnement vertical
                const diff = startY - e.clientY;
                const newHeight = Math.min(800, Math.max(35, startHeight + diff));
                
                // Mettre à jour la hauteur du panneau inférieur
                panel.style.height = newHeight + 'px';
                
                // Mettre à jour la hauteur du conteneur Golden Layout
                const totalHeight = panel.parentElement.clientHeight;
                goldenLayoutContainer.style.height = (totalHeight - newHeight) + 'px';
                
                // Mettre à jour les classes en fonction de la hauteur
                if (newHeight <= 35) {
                    panel.classList.remove('visible');
                } else {
                    panel.classList.add('visible');
                }
            } else {
                // Gestion du redimensionnement horizontal (panneaux latéraux)
                const rect = panel.getBoundingClientRect();
                const width = isRight 
                    ? Math.min(800, Math.max(100, rect.right - e.clientX))
                    : Math.min(800, Math.max(100, e.clientX - rect.left));
                
                panel.style.width = width + 'px';
                if (isRight) {
                    mainContent.style.marginRight = width + 'px';
                } else {
                    mainContent.style.marginLeft = width + 'px';
                }
            }

            // Mettre à jour le layout
            if (window.mainLayout) {
                window.mainLayout.updateSize();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialisation des références DOM
            mainContent = document.getElementById('main-content');
            leftPanel = document.querySelector('.side-panel:not(.right-panel)');
            rightPanel = document.querySelector('.side-panel.right-panel');
            bottomPanel = document.querySelector('.bottom-panel-container');
            goldenLayoutContainer = document.querySelector('.golden-layout-container');
            bottomPanelResizer = document.querySelector('.bottom-panel-resizer');

            // Variables pour le redimensionnement
            let isResizing = false;
            let startY = 0;
            let startHeight = 0;

            // Gestion du redimensionnement du panneau inférieur
            if (bottomPanelResizer) {
                bottomPanelResizer.addEventListener('mousedown', function(e) {
                    isResizing = true;
                    startY = e.clientY;
                    startHeight = bottomPanel.offsetHeight;
                    
                    bottomPanelResizer.classList.add('resizing');
                    document.body.style.cursor = 'ns-resize';
                    
                    // Désactiver la transition pendant le redimensionnement
                    bottomPanel.style.transition = 'none';
                });

                document.addEventListener('mousemove', function(e) {
                    if (!isResizing) return;
                    
                    const delta = startY - e.clientY;
                    const newHeight = Math.min(Math.max(startHeight + delta, 35), 800);
                    bottomPanel.style.height = newHeight + 'px';
                    
                    if (window.mainLayout) {
                        window.mainLayout.updateSize();
                    }
                });

                document.addEventListener('mouseup', function() {
                    if (!isResizing) return;
                    
                    isResizing = false;
                    bottomPanelResizer.classList.remove('resizing');
                    document.body.style.cursor = '';
                    
                    // Réactiver la transition
                    bottomPanel.style.transition = '';
                });
            }

            // Gestion des clics sur les onglets du panneau inférieur
            document.querySelectorAll('.bottom-panel-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const panelId = this.getAttribute('data-panel');
                    showPanel(panelId);
                });
            });

            // Gestion des boutons des panneaux latéraux
            document.querySelectorAll('.sidebar-button').forEach(button => {
                button.addEventListener('click', function() {
                    const panelId = this.dataset.panel;
                    const isRight = this.dataset.side === 'right';
                    showSidePanel(panelId, isRight);
                });
            });

            // Gestionnaires d'événements pour le redimensionnement
            [leftPanel.querySelector('.resizer'), rightPanel.querySelector('.resizer')].forEach(resizer => {
                const isRight = resizer === rightPanel.querySelector('.resizer');
                const panel = isRight ? rightPanel : leftPanel;
                
                resizer.addEventListener('mousedown', function(e) {
                    if (!panel.classList.contains('visible')) return;
                    
                    isResizing = true;
                    activePanel = panel;
                    document.body.classList.add('resizing');
                    
                    panel.style.transition = 'none';
                    mainContent.style.transition = 'none';
                    
                    e.preventDefault();
                });
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing || !activePanel) return;
                handleResize(e, activePanel, activePanel === rightPanel);
            });

            document.addEventListener('mouseup', function() {
                if (!isResizing) return;
                
                isResizing = false;
                document.body.classList.remove('resizing');
                
                if (activePanel) {
                    activePanel.style.transition = '';
                    if (activePanel === bottomPanel) {
                        goldenLayoutContainer.style.transition = '';
                        const currentHeight = parseInt(window.getComputedStyle(bottomPanel).height);
                        isBottomPanelVisible = currentHeight > 35;
                    }
                    activePanel = null;
                }
            });

            // Initialisation du layout
            initializeLayout();
        });

        // Fonction de gestion du redimensionnement
        function handleResize(e, panel, isRight) {
            if (!isResizing) return;

            if (panel === bottomPanel) {
                // Gestion du redimensionnement vertical
                const diff = startY - e.clientY;
                const newHeight = Math.min(800, Math.max(35, startHeight + diff));
                
                // Mettre à jour la hauteur du panneau inférieur
                panel.style.height = newHeight + 'px';
                
                // Mettre à jour la hauteur du conteneur Golden Layout
                const totalHeight = panel.parentElement.clientHeight;
                goldenLayoutContainer.style.height = (totalHeight - newHeight) + 'px';
                
                // Mettre à jour les classes en fonction de la hauteur
                if (newHeight <= 35) {
                    panel.classList.remove('visible');
                } else {
                    panel.classList.add('visible');
                }
            } else {
                // Gestion du redimensionnement horizontal (panneaux latéraux)
                const rect = panel.getBoundingClientRect();
                const width = isRight 
                    ? Math.min(800, Math.max(100, rect.right - e.clientX))
                    : Math.min(800, Math.max(100, e.clientX - rect.left));
                
                panel.style.width = width + 'px';
                if (isRight) {
                    mainContent.style.marginRight = width + 'px';
                } else {
                    mainContent.style.marginLeft = width + 'px';
                }
            }

            // Mettre à jour le layout
            if (window.mainLayout) {
                window.mainLayout.updateSize();
            }
        }

        function initializeLayout() {
            const config = {
                settings: {
                    showPopoutIcon: false,
                    showMaximiseIcon: false,
                    showCloseIcon: false
                },
                content: [{
                    type: 'row',
                    content: [{
                        type: 'component',
                        componentName: 'welcome',
                        title: 'Bienvenue'
                    }]
                }]
            };

            try {
                // S'assurer qu'il n'y a qu'une seule instance
                if (window.mainLayout) {
                    window.mainLayout.destroy();
                }
                
                mainLayout = new GoldenLayout(config, document.getElementById('layoutContainer'));
                window.mainLayout = mainLayout;

                // Enregistrer les composants avant l'initialisation
                mainLayout.registerComponent('welcome', function(container, state) {
                    const welcomeHtml = `
                        <div class="p-8 max-w-4xl mx-auto">
                            <h1 class="text-3xl font-bold mb-6">Bienvenue dans MysteryAI</h1>
                            <!-- ... reste du HTML ... -->
                        </div>
                    `;
                    container.getElement().html(welcomeHtml);
                });

                // Initialiser le layout
                mainLayout.init();

                // Maintenant on peut logger l'état après initialisation
                console.log('=== DEBUG: État du layout après initialisation ===');
                console.log('mainLayout:', mainLayout);
                console.log('Root:', mainLayout.root);
                if (mainLayout.root) {
                    console.log('ContentItems:', mainLayout.root.contentItems);
                } else {
                    console.error('=== DEBUG: Root est null après initialisation ===');
                }

                mainLayout.registerComponent('geocaches-table', function(container, state) {
                    const containerId = container.parent.config.id;
                    container.getElement().attr('data-container-id', containerId);
                    
                    // Utiliser l'URL de base de l'API
                    const apiUrl = `${window.API_BASE_URL}/geocaches/table/${state.zoneId}`;
                    console.log("Chargement du tableau depuis:", apiUrl);
                    
                    fetch(apiUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.text();
                        })
                        .then(html => {
                            container.getElement().html(html);
                            // Stocker l'ID du conteneur et l'URL de base dans des variables globales du tableau
                            const tableScript = document.createElement('script');
                            tableScript.textContent = `
                                window.currentContainerId = "${containerId}";
                                window.API_BASE_URL = "${window.API_BASE_URL}";
                            `;
                            container.getElement().append(tableScript);
                        })
                        .catch(error => {
                            console.error("Erreur lors du chargement du tableau:", error);
                            container.getElement().html(`
                                <div class="flex items-center justify-center h-full">
                                    <div class="text-red-500">
                                        Erreur lors du chargement du tableau: ${error.message}
                                    </div>
                                </div>
                            `);
                        });
                });

                mainLayout.registerComponent('openGeocacheDetails', function(container, state) {
                    console.log("Création du composant openGeocacheDetails pour la zone", state.zoneId);
                    
                    // Charger les détails et ouvrir l'onglet
                    fetch(state.detailsUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.text();
                        })
                        .then(html => {
                            const root = mainLayout.root;
                            const newItemConfig = {
                                type: 'component',
                                componentName: 'geocache-details',
                                title: `Détails GC-${state.geocacheId}`,
                                componentState: { 
                                    html: html,
                                    geocacheId: state.geocacheId
                                }
                            };
                            
                            // Trouver le conteneur parent par son ID
                            const container = mainLayout.root.getItemsById(state.containerId)[0];
                            if (container && container.parent) {
                                // Ajouter le composant au parent du conteneur trouvé
                                container.parent.addChild(newItemConfig);
                            } else {
                                // Fallback : ajouter à la racine si le conteneur n'est pas trouvé
                                root.contentItems[0].addChild(newItemConfig);
                            }
                        })
                        .catch(error => {
                            console.error("Erreur lors du chargement des détails:", error);
                            alert("Erreur lors du chargement des détails de la géocache");
                        });
                });

                mainLayout.registerComponent('geocache-details', function(container, state) {
                    console.log("Création du composant geocache-details", state);
                    
                    const html = `
                        <div class="w-full h-full bg-gray-900 overflow-auto p-4">
                            <div class="flex flex-col h-full">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl text-white">Détails de la Géocache</h2>
                                    <div class="flex space-x-2">
                                        <button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 save-button">
                                            <i class="fas fa-save mr-2"></i>Sauvegarder
                                        </button>
                                    </div>
                                </div>
                                <div class="flex-grow relative">
                                    ${state.html}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.getElement().html(html);
                    
                    // Initialiser les handlers
                    container.getElement().find('.save-button').on('click', function() {
                        console.log('=== DEBUG: Sauvegarde des détails ===', state);
                        // TODO: Implémenter la sauvegarde
                    });
                });

                mainLayout.registerComponent('image-editor', function(container, state) {
                    console.log('=== DEBUG: Création du composant image-editor ===', state);
                    
                    // Récupérer l'image source originale
                    const originalImage = document.querySelector(`img[data-image-id="${state.imageId}"]`);
                    const imageUrl = originalImage ? originalImage.src : '';
                    
                    console.log('=== DEBUG: URL de l\'image source ===', imageUrl);
                    
                    container.getElement().html(`
                        <div class="w-full h-full bg-gray-900 overflow-auto p-4">
                            <div class="flex flex-col h-full">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl text-white">Éditeur d'Image</h2>
                                    <div class="flex space-x-2">
                                        <button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 save-button">
                                            <i class="fas fa-save mr-2"></i>Sauvegarder
                                        </button>
                                    </div>
                                </div>
                                <div class="flex-grow relative">
                                    <img src="${imageUrl}"
                                         class="max-w-full h-auto"
                                         alt="Image à éditer"
                                         data-image-id="${state.imageId}">
                                </div>
                            </div>
                        </div>
                    `);

                    // Gérer le redimensionnement si nécessaire
                    container.on('resize', function() {
                        console.log('=== DEBUG: Redimensionnement de l\'éditeur d\'image ===');
                    });
                });

                // Fonction pour ouvrir l'éditeur d'image
                window.exposeOpenImageEditor = function(imageId, imageName) {
                    console.log('=== DEBUG: Exposition de openImageEditor appelée ===', { imageId, imageName });
                    
                    try {
                        // Trouver le conteneur principal (row)
                        const rootContentItem = mainLayout.root.contentItems[0];
                        
                        // Configuration du composant
                        const componentConfig = {
                            type: 'component',
                            componentName: 'image-editor',
                            componentState: { 
                                imageId: imageId,
                                imageName: imageName
                            },
                            title: `Éditeur - ${imageName || `Image ${imageId}`}`,
                            id: `image-editor-${imageId}`
                        };

                        // Si c'est un stack, ajouter directement
                        if (rootContentItem.isStack) {
                            rootContentItem.addChild(componentConfig);
                        } else {
                            // Sinon, trouver ou créer un stack
                            let stack = rootContentItem.contentItems.find(item => item.isStack);
                            if (!stack) {
                                stack = mainLayout.createContentItem({
                                    type: 'stack',
                                    content: []
                                });
                                rootContentItem.addChild(stack);
                            }
                            stack.addChild(componentConfig);
                        }

                        console.log('=== DEBUG: Composant éditeur ajouté avec succès ===');
                    } catch (error) {
                        console.error('=== DEBUG: Erreur lors de l\'ajout du composant ===', error);
                    }
                };

                // Exposer l'instance Golden Layout globalement
                window.goldenlayout = mainLayout;

                // Écouter l'événement openGeocacheDetails depuis les iframes
                window.addEventListener('message', function(event) {
                    if (event.data && event.data.type === 'openGeocacheDetails') {
                        const geocacheId = event.data.geocacheId;
                        const containerId = event.data.containerId;
                        const detailsUrl = event.data.detailsUrl;
                        console.log("Réception de l'événement openGeocacheDetails pour la géocache", geocacheId);
                        console.log("Container ID:", containerId);
                        console.log("URL des détails:", detailsUrl);
                        
                        // Charger les détails et ouvrir l'onglet
                        fetch(detailsUrl)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.text();
                            })
                            .then(html => {
                                const root = mainLayout.root;
                                const newItemConfig = {
                                    type: 'component',
                                    componentName: 'geocache-details',
                                    title: `Détails GC-${geocacheId}`,
                                    componentState: { 
                                        html: html,
                                        geocacheId: geocacheId
                                    }
                                };
                                
                                // Trouver le conteneur parent par son ID
                                const container = mainLayout.root.getItemsById(containerId)[0];
                                if (container && container.parent) {
                                    // Ajouter le composant au parent du conteneur trouvé
                                    container.parent.addChild(newItemConfig);
                                } else {
                                    // Fallback : ajouter à la racine si le conteneur n'est pas trouvé
                                    root.contentItems[0].addChild(newItemConfig);
                                }
                            })
                            .catch(error => {
                                console.error("Erreur lors du chargement des détails:", error);
                                alert("Erreur lors du chargement des détails de la géocache");
                            });
                    }
                });

                mainLayout.init();
                window.mainLayout = mainLayout;

                window.addEventListener('resize', () => {
                    mainLayout.updateSize();
                });
            } catch (error) {
                console.error('Golden Layout error:', error);
            }
        }

        window.openGeocachesTab = function(zoneId, zoneName) {
            const componentId = `geocaches-${zoneId}`;
            
            let existingComponent = null;
            mainLayout.root.contentItems.forEach(item => {
                item.contentItems.forEach(subItem => {
                    if (subItem.config.id === componentId) {
                        existingComponent = subItem;
                    }
                });
            });

            if (existingComponent) {
                existingComponent.parent.setActiveContentItem(existingComponent);
                return;
            }

            const componentConfig = {
                type: 'component',
                componentName: 'geocaches-table',
                title: `Géocaches - ${zoneName}`,
                id: `geocaches-table-${zoneId}`,
                componentState: { 
                    zoneId: zoneId,
                    zoneName: zoneName
                }
            };

            if (mainLayout.root.contentItems[0].type === 'row') {
                mainLayout.root.contentItems[0].addChild(componentConfig);
            } else {
                mainLayout.root.contentItems[0].addChild({
                    type: 'row',
                    content: [componentConfig]
                });
            }
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeLayout);
        } else {
            initializeLayout();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier que HTMX est chargé
            if (typeof htmx === 'undefined') {
                console.error('HTMX n\'est pas chargé !');
            } else {
                console.log('HTMX est chargé correctement');
            }

            // Logger les événements HTMX
            document.body.addEventListener('htmx:beforeRequest', function(evt) {
                console.log('HTMX - Avant la requête:', evt.detail);
            });
            
            document.body.addEventListener('htmx:afterRequest', function(evt) {
                console.log('HTMX - Après la requête:', evt.detail);
            });
            
            document.body.addEventListener('htmx:error', function(evt) {
                console.error('HTMX - Erreur:', evt.detail);
            });

            const leftPanel = document.querySelector('.side-panel:not(.right-panel)');
            const rightPanel = document.querySelector('.side-panel.right-panel');
            const mainContent = document.getElementById('main-content');
            const leftResizer = leftPanel.querySelector('.resizer');
            const rightResizer = rightPanel.querySelector('.resizer');
            const bottomPanel = document.querySelector('.bottom-panel-container');
            const bottomPanelResizer = bottomPanel.querySelector('.bottom-panel-resizer');
            
            let activeLeftButton = null;
            let activeRightButton = null;
            let activeLeftPanelId = null;
            let activeRightPanelId = null;
            let isResizing = false;
            let activePanel = null;

            function showPanel(panelId, isRight) {
                const targetPanel = isRight ? rightPanel : leftPanel;
                const panels = targetPanel.querySelectorAll('div[id$="-panel"]');
                panels.forEach(panel => {
                    panel.classList.add('hidden');
                });
                const panel = document.getElementById(panelId + '-panel');
                if (panel) {
                    panel.classList.remove('hidden');
                }
            }

            // Fonction générique de redimensionnement
            function handleResize(e, panel, isRight) {
                if (!isResizing) return;

                if (panel === bottomPanel) {
                    // Gestion du redimensionnement vertical
                    const diff = startY - e.clientY;
                    const newHeight = Math.min(800, Math.max(35, startHeight + diff));
                    
                    // Mettre à jour la hauteur du panneau inférieur
                    panel.style.height = newHeight + 'px';
                    
                    // Mettre à jour la hauteur du conteneur Golden Layout
                    const totalHeight = panel.parentElement.clientHeight;
                    goldenLayoutContainer.style.height = (totalHeight - newHeight) + 'px';
                    
                    // Mettre à jour les classes en fonction de la hauteur
                    if (newHeight <= 35) {
                        panel.classList.remove('visible');
                    } else {
                        panel.classList.add('visible');
                    }
                } else {
                    // Gestion du redimensionnement horizontal (panneaux latéraux)
                    const rect = panel.getBoundingClientRect();
                    const width = isRight 
                        ? Math.min(800, Math.max(100, rect.right - e.clientX))
                        : Math.min(800, Math.max(100, e.clientX - rect.left));
                    
                    panel.style.width = width + 'px';
                    if (isRight) {
                        mainContent.style.marginRight = width + 'px';
                    } else {
                        mainContent.style.marginLeft = width + 'px';
                    }
                }

                // Mettre à jour le layout
                if (window.mainLayout) {
                    window.mainLayout.updateSize();
                }
            }

            [leftResizer, rightResizer].forEach(resizer => {
                const isRight = resizer === rightResizer;
                const panel = isRight ? rightPanel : leftPanel;
                
                resizer.addEventListener('mousedown', function(e) {
                    if (!panel.classList.contains('visible')) return;
                    
                    isResizing = true;
                    activePanel = panel;
                    document.body.classList.add('resizing');
                    
                    panel.style.transition = 'none';
                    mainContent.style.transition = 'none';
                    
                    e.preventDefault();
                });
            });

            bottomPanelResizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                activePanel = bottomPanel;
                document.body.classList.add('resizing');
                
                startY = e.clientY;
                startHeight = parseInt(window.getComputedStyle(bottomPanel).height);
                
                bottomPanel.style.transition = 'none';
                goldenLayoutContainer.style.transition = 'none';
                
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing || !activePanel) return;
                handleResize(e, activePanel, activePanel === rightPanel);
            });

            document.addEventListener('mouseup', function() {
                if (!isResizing) return;
                
                isResizing = false;
                document.body.classList.remove('resizing');
                
                if (activePanel) {
                    activePanel.style.transition = '';
                    if (activePanel === bottomPanel) {
                        goldenLayoutContainer.style.transition = '';
                        const currentHeight = parseInt(window.getComputedStyle(bottomPanel).height);
                        isBottomPanelVisible = currentHeight > 35;
                    }
                    activePanel = null;
                }
            });

            // Gestion des onglets du panneau inférieur
            const bottomPanelTabs = document.querySelectorAll('.bottom-panel-tab');
            const bottomPanelContents = document.querySelectorAll('.bottom-panel-content');

            bottomPanelTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const panelId = this.dataset.panel;
                    
                    // Si le panneau est réduit, on l'agrandit
                    const currentHeight = parseInt(window.getComputedStyle(bottomPanel).height);
                    if (currentHeight <= 35) {
                        const newHeight = 300;
                        bottomPanel.style.height = newHeight + 'px';
                        
                        // Ajuster la hauteur du conteneur Golden Layout
                        const totalHeight = bottomPanel.parentElement.clientHeight;
                        goldenLayoutContainer.style.height = (totalHeight - newHeight) + 'px';
                        
                        bottomPanel.classList.add('visible');
                    }

                    // Gestion des onglets
                    bottomPanelTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Affichage du contenu
                    bottomPanelContents.forEach(panel => {
                        if (panel.id === panelId) {
                            panel.classList.add('visible');
                        } else {
                            panel.classList.remove('visible');
                        }
                    });

                    if (window.mainLayout) {
                        window.mainLayout.updateSize();
                    }
                });
            });
        });

        // Gestionnaire de menu contextuel pour les images
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Script de menu contextuel chargé');

            // Utiliser la délégation d'événements pour gérer le clic droit sur les images
            document.body.addEventListener('contextmenu', function(e) {
                console.log('=== DEBUG: Événement contextmenu détecté ===');
                console.log('Target:', e.target);
                console.log('Target classList:', e.target.classList);
                
                // Vérifier si l'élément cliqué ou un de ses parents est une image de géocache
                const targetImage = e.target.closest('.geocache-image');
                console.log('Image trouvée:', !!targetImage);
                
                if (targetImage) {
                    console.log('=== DEBUG: Clic droit sur une image de géocache ===');
                    // Empêcher le menu contextuel par défaut
                    e.preventDefault();
                    e.stopPropagation();

                    // Retirer la sélection de toutes les images
                    document.querySelectorAll('.geocache-image').forEach(img => {
                        img.classList.remove('selected');
                    });

                    // Sélectionner l'image actuelle
                    targetImage.classList.add('selected');

                    // Vérifier si window.electron existe
                    console.log('=== DEBUG: window.electron existe:', !!window.electron);
                    console.log('=== DEBUG: window.electron:', window.electron);

                    // Si nous sommes dans Electron, utiliser le menu contextuel natif
                    if (window.electron) {
                        console.log('=== DEBUG: Utilisation du menu Electron ===');
                        const imageData = {
                            imageId: targetImage.dataset.imageId,
                            imageName: targetImage.dataset.imageName
                        };
                        const position = {
                            x: e.clientX,
                            y: e.clientY
                        };
                        console.log('=== DEBUG: Image data:', imageData);
                        console.log('=== DEBUG: Position:', position);
                        window.electron.showImageContextMenu(imageData, position);
                        return false;
                    } else {
                        console.log('=== DEBUG: Utilisation du menu web ===');
                        // Fallback pour le navigateur web
                        const rect = targetImage.getBoundingClientRect();
                        showWebContextMenu(rect.left, rect.top, targetImage.dataset.imageId, targetImage.dataset.imageName);
                    }
                }
            }, true);  // Capture phase
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Écouter l'événement d'ouverture de l'éditeur
            window.electron.on('execute-open-editor', ({ imageId, imageName }) => {
                console.log('=== DEBUG: Réception de la demande d\'ouverture de l\'éditeur ===', { imageId, imageName });
                
                // Vérifier si GoldenLayout est initialisé
                if (!window.goldenlayout) {
                    console.error('=== DEBUG: GoldenLayout n\'est pas encore initialisé ===');
                    return;
                }

                // Créer un nouveau composant pour l'éditeur d'image
                const componentConfig = {
                    type: 'component',
                    componentName: 'image-editor',
                    id: `image-editor-${imageId}`,
                    title: `Éditeur - ${imageName || `Image ${imageId}`}`,
                    componentState: { 
                        imageId: imageId,
                        imageName: imageName
                    }
                };

                try {
                    // Ajouter le composant à la mise en page
                    window.goldenlayout.root.contentItems[0].addChild(componentConfig);
                    console.log('=== DEBUG: Composant éditeur ajouté ===');
                } catch (error) {
                    console.error('=== DEBUG: Erreur lors de l\'ajout du composant ===', error);
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Écouter les événements d'édition d'image
            window.electron.on('request-open-image-editor', (data) => {
                console.log('=== DEBUG: Événement IPC request-open-image-editor reçu ===', data);
                handleImageEditorRequest(data);
            });

            // Écouter aussi les messages window pour le cas local
            window.addEventListener('message', (event) => {
                if (event.data.type === 'request-open-image-editor') {
                    console.log('=== DEBUG: Message local request-open-image-editor reçu ===', event.data);
                    handleImageEditorRequest(event.data.data);
                }
            });

            // Fonction pour gérer la demande d'édition d'image
            function handleImageEditorRequest(data) {
                console.log('=== DEBUG: Traitement de la demande d\'édition ===', data);
                try {
                    // Trouver le conteneur principal (row)
                    const rootContentItem = mainLayout.root.contentItems[0];
                    console.log('=== DEBUG: Root content items ===', rootContentItem);
                    
                    // Configuration du composant
                    const componentConfig = {
                        type: 'component',
                        componentName: 'image-editor',
                        componentState: { 
                            imageId: data.imageId,
                            imageName: data.imageName
                        },
                        title: `Éditeur - ${data.imageName || `Image ${data.imageId}`}`,
                        id: `image-editor-${data.imageId}`
                    };

                    console.log('=== DEBUG: Configuration du composant ===', componentConfig);

                    // Si c'est un stack, ajouter directement
                    if (rootContentItem.isStack) {
                        rootContentItem.addChild(componentConfig);
                    } else {
                        // Sinon, trouver ou créer un stack
                        let stack = rootContentItem.contentItems.find(item => item.isStack);
                        if (!stack) {
                            stack = mainLayout.createContentItem({
                                type: 'stack',
                                content: []
                            });
                            rootContentItem.addChild(stack);
                        }
                        stack.addChild(componentConfig);
                    }

                    console.log('=== DEBUG: Composant éditeur ajouté avec succès ===');
                } catch (error) {
                    console.error('=== DEBUG: Erreur lors de l\'ajout de l\'éditeur ===', error);
                }
            }
        });
    </script>
</body>
</html>
