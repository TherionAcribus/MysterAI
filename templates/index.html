<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/js/contextual_menu.js"></script>
    <title>MysteryAI - Geocaching</title>
    <script>
        // Définir openImageEditor globalement avant tout
        window.openImageEditor = function(imageId, imageName) {
            console.log('=== DEBUG: Tentative d\'ouverture de l\'éditeur d\'image ===');
            console.log('Params:', { imageId, imageName });
            console.log('Layout actuel:', mainLayout);
            console.log('Root items:', mainLayout.root.contentItems);
            
            // Vérifier si GoldenLayout est initialisé
            if (!window.goldenlayout) {
                console.error('=== DEBUG: GoldenLayout n\'est pas encore initialisé ===');
                return;
            }

            try {
                // Trouver le conteneur principal (row)
                const rootContentItem = mainLayout.root.contentItems[0];
                
                // Configuration du composant
                const componentConfig = {
                    type: 'component',
                    componentName: 'image-editor',
                    componentState: { 
                        imageId: imageId,
                        imageName: imageName
                    },
                    title: `Éditeur - ${imageName || `Image ${imageId}`}`,
                    id: `image-editor-${imageId}`
                };

                // Si c'est un stack, ajouter directement
                if (rootContentItem.isStack) {
                    rootContentItem.addChild(componentConfig);
                } else {
                    // Sinon, trouver ou créer un stack
                    let stack = rootContentItem.contentItems.find(item => item.isStack);
                    if (!stack) {
                        stack = mainLayout.createContentItem({
                            type: 'stack',
                            content: []
                        });
                        rootContentItem.addChild(stack);
                    }
                    stack.addChild(componentConfig);
                }

                console.log('=== DEBUG: Composant éditeur ajouté avec succès ===');
            } catch (error) {
                console.error('=== DEBUG: Erreur lors de l\'ajout de l\'éditeur ===', error);
            }
        };

        console.log('=== DEBUG: Index.html commence à charger ===');  

        // Initialiser le menu contextuel au chargement du DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initContextMenu);
        } else {
            initContextMenu();
        }
    </script>
    
    <!-- Styles -->
    <link type="text/css" rel="stylesheet" href="/css/output.css">
    <link type="text/css" rel="stylesheet" href="/vendor/golden-layout/goldenlayout-base.css">
    <link type="text/css" rel="stylesheet" href="/vendor/golden-layout/goldenlayout-dark-theme.css">
    <link rel="stylesheet" href="/vendor/fontawesome/css/all.min.css">
    <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="/vendor/leaflet/leaflet.css">
    <link type="text/css" rel="stylesheet" href="/css/index.css">
    
    <style>
        /* Styles pour les polices d'alphabet */
        @font-face {
            font-family: 'Aurebesh';
            src: url('/api/alphabets/aurebesh/font') format('truetype');
        }
        
        /* Ajoutez d'autres polices ici */
        
        .lm_goldenlayout {
            width: 100%;
            height: 100vh;
        }
        
        .lm_content {
            background: #1a1a1a;
            color: white;
        }
        
        .sidebar {
            width: 48px;
            background: #1a1a1a;
            border-right: 1px solid #333;
        }
        
        .sidebar-button {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sidebar-button:hover {
            color: white;
            background: #333;
        }
        
        .sidebar-button.active {
            color: white;
            background: #444;
        }
        
        .bottom-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgb(31, 41, 55);
            border-bottom: 1px solid rgb(55, 65, 81);
            padding: 0.5rem;
        }
        
        .bottom-panel-tabs {
            display: flex;
            gap: 0.5rem;
        }
        
        .geocache-code {
            color: rgb(156, 163, 175);
            font-family: monospace;
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            background-color: rgb(17, 24, 39);
            border-radius: 0.25rem;
            margin-right: 0.5rem;
        }
    </style>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/htmx.org@2.0.4" integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>
    
    <!-- Ancien zone avec le CSS -->
    <style>
    </style>
    
    <script src="https://unpkg.com/@hotwired/stimulus@3.2.2/dist/stimulus.umd.js"></script>
    <script src="/js/controllers/alphabet_viewer_controller.js" defer></script>
</head>
<body class="bg-gray-900 text-gray-300 h-screen flex flex-col overflow-hidden">
    <!-- Main Container -->
    <div class="workspace-container">
        <!-- Left Sidebar -->
        <div class="sidebar bg-gray-800 border-r border-gray-700 flex flex-col">
            <div class="flex-1 flex flex-col items-center py-2 space-y-4">
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="geocaches" data-side="left"
                        hx-get="/api/zones"
                        hx-target="#geocaches-panel-content"
                        hx-swap="innerHTML"
                        hx-trigger="load">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="search" data-side="left">
                    <i class="fas fa-search text-xl"></i>
                </button>
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="git" data-side="left">
                    <i class="fas fa-code-branch text-xl"></i>
                </button>
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="decrypt" data-side="left"
                        hx-get="/api/plugins_list"
                        hx-target="#decrypt-panel .panel-body"
                        hx-trigger="load">
                    <i class="fas fa-key text-xl"></i>
                </button>
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="alphabets" data-side="left">
                    <i class="fas fa-font"></i>
                </button>
            </div>
            <div class="mt-auto flex flex-col items-center py-2 space-y-4">
                <button class="text-gray-400 hover:text-white w-full py-2 flex justify-center sidebar-button" title="Settings" data-panel="settings" data-side="left">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </div>
        </div>

        <div class="panel-container">
            <!-- Left Panel -->
            <div id="left-panel" class="side-panel bg-gray-800 border-r border-gray-700">
                <div class="resizer"></div>
                <div class="side-panel-content">
                    <div id="geocaches-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Géocaches</h2>
                        </div>
                        <div id="geocaches-panel-content" class="panel-body">
                            <!-- Le contenu sera chargé ici par HTMX -->
                        </div>
                    </div>
                    <div id="search-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Recherche</h2>
                        </div>
                        <div class="panel-body">
                            <!-- Contenu du panneau de recherche -->
                        </div>
                    </div>
                    <div id="git-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Source Control</h2>
                        </div>
                        <div class="panel-body">
                            <!-- Contenu du panneau git -->
                        </div>
                    </div>
                    <div id="decrypt-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Décryptage</h2>
                        </div>
                        <div class="panel-body">
                            <!-- Contenu du panneau de décryptage -->
                        </div>
                    </div>
                    <div id="alphabets-panel" class="h-full p-4 panel-content"
                         hx-get="/api/alphabets"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Alphabets</h2>
                        </div>
                        <div class="panel-body mt-4 space-y-4">
                            <div class="animate-pulse">Chargement des alphabets...</div>
                        </div>
                    </div>
                    <div id="settings-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Paramètres</h2>
                        </div>
                        <div class="panel-body">
                            <!-- Contenu du panneau des paramètres -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div id="main-content" class="main-content bg-gray-900">
                <div id="layoutContainer" class="golden-layout-container"></div>
                
                <!-- Bottom Panel -->
                <div class="bottom-panel-container expanded" style="height: 300px;">
                    <div class="bottom-panel-resizer"></div>
                    <div class="bottom-panel-header">
                        <div class="bottom-panel-tabs">
                            <button class="bottom-panel-tab active" 
                                    data-panel="map-panel"
                                    onclick="htmx.ajax('GET', '/api/logs/map_panel', {target: '#map-panel', swap: 'innerHTML'})">
                                <i class="fas fa-map-marked-alt"></i>Map
                            </button>
                            <button class="bottom-panel-tab" data-panel="notes-panel">
                                <i class="fas fa-sticky-note"></i>Notes
                            </button>
                            <button class="bottom-panel-tab" data-panel="informations-panel">
                                <i class="fas fa-info-circle"></i>Informations
                            </button>
                        </div>
                        <div class="geocache-code"></div>
                    </div>
                    <div class="bottom-panel-content">
                        <div id="map-panel" 
                             class="panel-content active"
                             hx-get="/api/logs/map_panel"
                             hx-trigger="load"
                             hx-swap="innerHTML">
                        </div>
                        <div id="notes-panel" class="panel-content"
                             data-controller="notes"
                             data-action="tab-activated@window->notes#onActivated">
                            <div id="notes-content">
                                <!-- Le contenu sera chargé dynamiquement -->
                            </div>
                        </div>
                        <div id="informations-panel" class="panel-content">
                            <h3>Panneau d'Informations</h3>
                            <p>Retrouvez ici toutes les informations importantes sur le système et les mises à jour.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="side-panel right-panel bg-gray-800">
                <div class="resizer"></div>
                <div id="chat-panel" class="chat-container">
                    <h2 class="text-sm font-semibold mb-4">CHAT IA</h2>
                    <div class="chat-messages">
                        <!-- Les messages du chat apparaîtront ici -->
                    </div>
                    <div class="chat-input-container">
                        <textarea class="chat-input" rows="3" placeholder="Tapez votre message..."></textarea>
                        <button class="chat-send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="sidebar right-sidebar bg-gray-800 flex flex-col">
            <div class="flex-1 flex flex-col items-center py-2 space-y-4">
                <button class="text-gray-400 hover:text-white w-full py-2 flex justify-center sidebar-button" title="Chat IA" data-panel="chat" data-side="right">
                    <i class="fas fa-comments text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar flex items-center px-2 text-sm">
        <div class="flex-1">Ready</div>
        <div class="flex items-center space-x-4">
            <span>UTF-8</span>
            <span>JavaScript</span>
            <span>Ln 1, Col 1</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/golden-layout/goldenlayout.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script src="/vendor/leaflet/leaflet.js"></script>
    <script src="https://unpkg.com/@hotwired/stimulus@3.2.2/dist/stimulus.umd.js"></script>
    <script src="/js/controllers/map_controller.js"></script>
    
    <!-- Layout State Manager -->
    <script src="/js/layout_state_manager.js"></script>
    
    <!-- Initialisation ET gestion des panneaux -->
    <script src="/js/panels.js"></script>

    <!-- Initialisation du layout et gestion-->
    <script src="/js/layout_initialize.js"></script>

        
    <script>

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeLayout);
        } else {
            initializeLayout();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier que HTMX est chargé
            if (typeof htmx === 'undefined') {
                console.error('HTMX n\'est pas chargé !');
            } else {
                console.log('HTMX est chargé correctement');
            }

            // Logger les événements HTMX
            document.body.addEventListener('htmx:beforeRequest', function(evt) {
                console.log('HTMX - Avant la requête:', evt.detail);
            });
            
            document.body.addEventListener('htmx:afterRequest', function(evt) {
                console.log('HTMX - Après la requête:', evt.detail);
            });
            
            document.body.addEventListener('htmx:error', function(evt) {
                console.error('HTMX - Erreur:', evt.detail);
            });
            
            // Initialize Stimulus application
            const application = Stimulus.Application.start()
            
            // Initialize layout state manager
            const layoutStateManager = new LayoutStateManager();
            
            // Listen for geocache selection changes
            document.addEventListener('geocacheSelected', function(event) {
                const geocacheId = event.detail.geocacheId;
                
                // Update geocache code display
                const geocacheCodeElement = document.querySelector('.geocache-code');
                if (geocacheCodeElement) {
                    geocacheCodeElement.textContent = event.detail.gcCode;
                }
                
                // Update map panel
                const mapPanel = document.getElementById('map-panel');
                if (mapPanel) {
                    htmx.ajax('GET', `/api/logs/map_panel?geocacheId=${geocacheId}`, {
                        target: '#map-panel',
                        swap: 'innerHTML'
                    });
                }
            });
        });
    </script>
    <template id="notes-panel-template">
        <div class="notes-panel h-full"
             data-controller="notes"
             data-geocache-id=""
             data-notes-target="content">
            <!-- Le contenu sera chargé dynamiquement -->
        </div>
    </template>
    <script>
        // Register components with GoldenLayout
        window.registerComponents = function(layout) {
            layout.registerComponent('map-panel', function(container, state) {
                return new MapComponent(container, state);
            });
        };
    </script>
</body>
</html>
