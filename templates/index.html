<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/js/contextual_menu.js"></script>
    <title>MysteryAI - Geocaching</title>
    <script>
        // Définir openImageEditor globalement avant tout
        window.openImageEditor = function(imageId, imageName) {
            console.log('=== DEBUG: Tentative d\'ouverture de l\'éditeur d\'image ===');
            console.log('Params:', { imageId, imageName });
            console.log('Layout actuel:', mainLayout);
            console.log('Root items:', mainLayout.root.contentItems);
            
            // Vérifier si GoldenLayout est initialisé
            if (!window.goldenlayout) {
                console.error('=== DEBUG: GoldenLayout n\'est pas encore initialisé ===');
                return;
            }

            try {
                // Trouver le conteneur principal (row)
                const rootContentItem = mainLayout.root.contentItems[0];
                
                // Configuration du composant
                const componentConfig = {
                    type: 'component',
                    componentName: 'image-editor',
                    componentState: { 
                        imageId: imageId,
                        imageName: imageName
                    },
                    title: `Éditeur - ${imageName || `Image ${imageId}`}`,
                    id: `image-editor-${imageId}`
                };

                // Si c'est un stack, ajouter directement
                if (rootContentItem.isStack) {
                    rootContentItem.addChild(componentConfig);
                } else {
                    // Sinon, trouver ou créer un stack
                    let stack = rootContentItem.contentItems.find(item => item.isStack);
                    if (!stack) {
                        stack = mainLayout.createContentItem({
                            type: 'stack',
                            content: []
                        });
                        rootContentItem.addChild(stack);
                    }
                    stack.addChild(componentConfig);
                }

                console.log('=== DEBUG: Composant éditeur ajouté avec succès ===');
            } catch (error) {
                console.error('=== DEBUG: Erreur lors de l\'ajout de l\'éditeur ===', error);
            }
        };

        console.log('=== DEBUG: Index.html commence à charger ===');  

        // Initialiser le menu contextuel au chargement du DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initContextMenu);
        } else {
            initContextMenu();
        }
    </script>
    
    <!-- Styles -->
    <link type="text/css" rel="stylesheet" href="/css/output.css">
    <link type="text/css" rel="stylesheet" href="/vendor/golden-layout/goldenlayout-base.css">
    <link type="text/css" rel="stylesheet" href="/vendor/golden-layout/goldenlayout-dark-theme.css">
    <link rel="stylesheet" href="/vendor/fontawesome/css/all.min.css">
    <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="/css/index.css">

    <!-- Scripts -->
    <script src="https://unpkg.com/htmx.org@2.0.4" integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>
    
    <!-- Ancien zone avec le CSS -->
    <style>
    </style>
    
</head>
<body class="bg-gray-900 text-gray-300 h-screen flex flex-col overflow-hidden">
    <!-- Main Container -->
    <div class="workspace-container">
        <!-- Left Sidebar -->
        <div class="sidebar bg-gray-800 border-r border-gray-700 flex flex-col">
            <div class="flex-1 flex flex-col items-center py-2 space-y-4">
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="geocaches" data-side="left"
                        hx-get="/api/zones"
                        hx-target="#geocaches-panel-content"
                        hx-swap="innerHTML"
                        hx-trigger="load">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="search" data-side="left">
                    <i class="fas fa-search text-xl"></i>
                </button>
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="git" data-side="left">
                    <i class="fas fa-code-branch text-xl"></i>
                </button>
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="decrypt" data-side="left"
                        hx-get="/api/plugins_list"
                        hx-target="#decrypt-panel .panel-body"
                        hx-trigger="load">
                    <i class="fas fa-key text-xl"></i>
                </button>
            </div>
            <div class="mt-auto flex flex-col items-center py-2 space-y-4">
                <button class="text-gray-400 hover:text-white w-full py-2 flex justify-center sidebar-button" title="Settings" data-panel="settings" data-side="left">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </div>
        </div>

        <div class="panel-container">
            <!-- Left Panel -->
            <div id="left-panel" class="side-panel bg-gray-800 border-r border-gray-700">
                <div class="resizer"></div>
                <div class="side-panel-content">
                    <div id="geocaches-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Géocaches</h2>
                        </div>
                        <div id="geocaches-panel-content" class="panel-body">
                            <!-- Le contenu sera chargé ici par HTMX -->
                        </div>
                    </div>
                    <div id="search-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Recherche</h2>
                        </div>
                        <div class="panel-body">
                            <!-- Contenu du panneau de recherche -->
                        </div>
                    </div>
                    <div id="git-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Source Control</h2>
                        </div>
                        <div class="panel-body">
                            <!-- Contenu du panneau git -->
                        </div>
                    </div>
                    <div id="decrypt-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Décryptage</h2>
                        </div>
                        <div class="panel-body">
                            <!-- Contenu du panneau de décryptage -->
                        </div>
                    </div>
                    <div id="settings-panel" class="h-full p-4 panel-content">
                        <div class="panel-header border-b border-gray-700 p-2">
                            <h2 class="text-lg font-semibold">Paramètres</h2>
                        </div>
                        <div class="panel-body">
                            <!-- Contenu du panneau des paramètres -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div id="main-content" class="main-content bg-gray-900">
                <div id="layoutContainer" class="golden-layout-container"></div>
                
                <!-- Bottom Panel -->
                <div class="bottom-panel-container">
                    <div class="bottom-panel-resizer"></div>
                    <div class="bottom-panel-header">
                        <div class="bottom-panel-tabs">
                            <button class="bottom-panel-tab active" data-panel="map-panel">
                                <i class="fas fa-map-marked-alt"></i>Map
                            </button>
                            <button class="bottom-panel-tab" data-panel="notes-panel">
                                <i class="fas fa-sticky-note"></i>Notes
                            </button>
                            <button class="bottom-panel-tab" data-panel="informations-panel">
                                <i class="fas fa-info-circle"></i>Informations
                            </button>
                        </div>
                    </div>
                    <div class="bottom-panel-content">
                        <div id="map-panel" class="panel-content active">
                            <h3>Panneau de Carte</h3>
                            <p>Ici vous pouvez voir la carte interactive des géocaches. Cliquez sur une géocache pour voir ses détails.</p>
                        </div>
                        <div id="notes-panel" class="panel-content">
                            <h3>Panneau de Notes</h3>
                            <p>Cet espace est dédié à la prise de notes et aux annotations personnelles sur vos géocaches.</p>
                        </div>
                        <div id="informations-panel" class="panel-content">
                            <h3>Panneau d'Informations</h3>
                            <p>Retrouvez ici toutes les informations importantes sur le système et les mises à jour.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="side-panel right-panel bg-gray-800">
                <div class="resizer"></div>
                <div id="chat-panel" class="chat-container">
                    <h2 class="text-sm font-semibold mb-4">CHAT IA</h2>
                    <div class="chat-messages">
                        <!-- Les messages du chat apparaîtront ici -->
                    </div>
                    <div class="chat-input-container">
                        <textarea class="chat-input" rows="3" placeholder="Tapez votre message..."></textarea>
                        <button class="chat-send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="sidebar right-sidebar bg-gray-800 flex flex-col">
            <div class="flex-1 flex flex-col items-center py-2 space-y-4">
                <button class="text-gray-400 hover:text-white w-full py-2 flex justify-center sidebar-button" title="Chat IA" data-panel="chat" data-side="right">
                    <i class="fas fa-comments text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar flex items-center px-2 text-sm">
        <div class="flex-1">Ready</div>
        <div class="flex items-center space-x-4">
            <span>UTF-8</span>
            <span>JavaScript</span>
            <span>Ln 1, Col 1</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/golden-layout/goldenlayout.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script>
        // Variables globales
        let mainContent, leftPanel, rightPanel, bottomPanel, goldenLayoutContainer, bottomPanelResizer;
        let activeLeftButton = null;
        let activeRightButton = null;
        let activeLeftPanelId = null;
        let activeRightPanelId = null;
        let isResizing = false;
        let activePanel = null;
        let isBottomPanelVisible = false;
        let startY, startHeight;
        let mainLayout;

        // Configuration de l'URL de base pour l'API
        window.API_BASE_URL = 'http://127.0.0.1:3000';

        // Fonction pour charger les zones
        function loadZones() {
            const target = document.querySelector('.side-panel-content');
            if (!target) {
                console.error('Conteneur de panneau non trouvé');
                return;
            }

            fetch('/api/zones', {
                method: 'GET',
                headers: {
                    'HX-Request': 'true'
                }
            })
            .then(response => response.text())
            .then(html => {
                target.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                target.innerHTML = '<div class="p-4 text-red-500">Erreur lors du chargement des zones</div>';
            });
        }

        </script>

        <!-- Initialisation ET gestion des panneaux -->
        <script src="/js/panels.js"></script>

        <!-- Initialisation du layout et gestion-->
        <script src="/js/layout_initialize.js"></script>

        
        <script>

        

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeLayout);
        } else {
            initializeLayout();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier que HTMX est chargé
            if (typeof htmx === 'undefined') {
                console.error('HTMX n\'est pas chargé !');
            } else {
                console.log('HTMX est chargé correctement');
            }

            // Logger les événements HTMX
            document.body.addEventListener('htmx:beforeRequest', function(evt) {
                console.log('HTMX - Avant la requête:', evt.detail);
            });
            
            document.body.addEventListener('htmx:afterRequest', function(evt) {
                console.log('HTMX - Après la requête:', evt.detail);
            });
            
            document.body.addEventListener('htmx:error', function(evt) {
                console.error('HTMX - Erreur:', evt.detail);
            });

            const leftPanel = document.querySelector('.side-panel:not(.right-panel)');
            const rightPanel = document.querySelector('.side-panel.right-panel');
            const mainContent = document.getElementById('main-content');
            const leftResizer = leftPanel.querySelector('.resizer');
            const rightResizer = rightPanel.querySelector('.resizer');
            const bottomPanel = document.querySelector('.bottom-panel-container');
            const bottomPanelResizer = bottomPanel.querySelector('.bottom-panel-resizer');
            
            let activeLeftButton = null;
            let activeRightButton = null;
            let activeLeftPanelId = null;
            let activeRightPanelId = null;
            let isResizing = false;
            let activePanel = null;

            function showPanel(panelId, isRight) {
                const targetPanel = isRight ? rightPanel : leftPanel;
                const panels = targetPanel.querySelectorAll('div[id$="-panel"]');
                panels.forEach(panel => {
                    panel.classList.add('hidden');
                });
                const panel = document.getElementById(panelId + '-panel');
                if (panel) {
                    panel.classList.remove('hidden');
                }
            }

            // Fonction générique de redimensionnement
            function handleResize(e, panel, isRight) {
                if (!isResizing) return;

                if (panel === bottomPanel) {
                    // Gestion du redimensionnement vertical
                    const diff = startY - e.clientY;
                    const newHeight = Math.min(800, Math.max(35, startHeight + diff));
                    
                    // Mettre à jour la hauteur du panneau inférieur
                    panel.style.height = newHeight + 'px';
                    
                    // Mettre à jour la hauteur du conteneur Golden Layout
                    const totalHeight = panel.parentElement.clientHeight;
                    goldenLayoutContainer.style.height = (totalHeight - newHeight) + 'px';
                    
                    // Mettre à jour les classes en fonction de la hauteur
                    if (newHeight <= 35) {
                        panel.classList.remove('visible');
                    } else {
                        panel.classList.add('visible');
                    }
                } else {
                    // Gestion du redimensionnement horizontal (panneaux latéraux)
                    const rect = panel.getBoundingClientRect();
                    const width = isRight 
                        ? Math.min(800, Math.max(100, rect.right - e.clientX))
                        : Math.min(800, Math.max(100, e.clientX - rect.left));
                    
                    panel.style.width = width + 'px';
                    if (isRight) {
                        mainContent.style.marginRight = width + 'px';
                    } else {
                        mainContent.style.marginLeft = width + 'px';
                    }
                }

                // Mettre à jour le layout
                if (window.mainLayout) {
                    window.mainLayout.updateSize();
                }
            }

            [leftResizer, rightResizer].forEach(resizer => {
                const isRight = resizer === rightResizer;
                const panel = isRight ? rightPanel : leftPanel;
                
                resizer.addEventListener('mousedown', function(e) {
                    if (!panel.classList.contains('visible')) return;
                    
                    isResizing = true;
                    activePanel = panel;
                    document.body.classList.add('resizing');
                    
                    panel.style.transition = 'none';
                    mainContent.style.transition = 'none';
                    
                    e.preventDefault();
                });
            });

            bottomPanelResizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                activePanel = bottomPanel;
                document.body.classList.add('resizing');
                
                startY = e.clientY;
                startHeight = parseInt(window.getComputedStyle(bottomPanel).height);
                
                bottomPanel.style.transition = 'none';
                goldenLayoutContainer.style.transition = 'none';
                
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing || !activePanel) return;
                handleResize(e, activePanel, activePanel === rightPanel);
            });

            document.addEventListener('mouseup', function() {
                if (!isResizing) return;
                
                isResizing = false;
                document.body.classList.remove('resizing');
                
                if (activePanel) {
                    activePanel.style.transition = '';
                    if (activePanel === bottomPanel) {
                        goldenLayoutContainer.style.transition = '';
                        const currentHeight = parseInt(window.getComputedStyle(bottomPanel).height);
                        isBottomPanelVisible = currentHeight > 35;
                    }
                    activePanel = null;
                }
            });

            // Gestion des onglets du panneau inférieur
            const bottomPanelTabs = document.querySelectorAll('.bottom-panel-tab');
            const bottomPanelContents = document.querySelectorAll('.bottom-panel-content');

            bottomPanelTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const panelId = this.dataset.panel;
                    
                    // Si le panneau est réduit, on l'agrandit
                    const currentHeight = parseInt(window.getComputedStyle(bottomPanel).height);
                    if (currentHeight <= 35) {
                        const newHeight = 300;
                        bottomPanel.style.height = newHeight + 'px';
                        
                        // Ajuster la hauteur du conteneur Golden Layout
                        const totalHeight = bottomPanel.parentElement.clientHeight;
                        goldenLayoutContainer.style.height = (totalHeight - newHeight) + 'px';
                        
                        bottomPanel.classList.add('visible');
                    }

                    // Gestion des onglets
                    bottomPanelTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Affichage du contenu
                    bottomPanelContents.forEach(panel => {
                        if (panel.id === panelId) {
                            panel.classList.add('visible');
                        } else {
                            panel.classList.remove('visible');
                        }
                    });

                    if (window.mainLayout) {
                        window.mainLayout.updateSize();
                    }
                });
            });
        });

        // Gestionnaire de menu contextuel pour les images
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Script de menu contextuel chargé');

            // Utiliser la délégation d'événements pour gérer le clic droit sur les images
            document.body.addEventListener('contextmenu', function(e) {
                console.log('=== DEBUG: Événement contextmenu détecté ===');
                console.log('Target:', e.target);
                console.log('Target classList:', e.target.classList);
                
                // Vérifier si l'élément cliqué ou un de ses parents est une image de géocache
                const targetImage = e.target.closest('.geocache-image');
                console.log('Image trouvée:', !!targetImage);
                
                if (targetImage) {
                    console.log('=== DEBUG: Clic droit sur une image de géocache ===');
                    // Empêcher le menu contextuel par défaut
                    e.preventDefault();
                    e.stopPropagation();

                    // Retirer la sélection de toutes les images
                    document.querySelectorAll('.geocache-image').forEach(img => {
                        img.classList.remove('selected');
                    });

                    // Sélectionner l'image actuelle
                    targetImage.classList.add('selected');

                    // Vérifier si window.electron existe
                    console.log('=== DEBUG: window.electron existe:', !!window.electron);
                    console.log('=== DEBUG: window.electron:', window.electron);

                    // Si nous sommes dans Electron, utiliser le menu contextuel natif
                    if (window.electron) {
                        console.log('=== DEBUG: Utilisation du menu Electron ===');
                        const imageData = {
                            imageId: targetImage.dataset.imageId,
                            imageName: targetImage.dataset.imageName
                        };
                        const position = {
                            x: e.clientX,
                            y: e.clientY
                        };
                        console.log('=== DEBUG: Image data:', imageData);
                        console.log('=== DEBUG: Position:', position);
                        window.electron.showImageContextMenu(imageData, position);
                        return false;
                    } else {
                        console.log('=== DEBUG: Utilisation du menu web ===');
                        // Fallback pour le navigateur web
                        const rect = targetImage.getBoundingClientRect();
                        showWebContextMenu(rect.left, rect.top, targetImage.dataset.imageId, targetImage.dataset.imageName);
                    }
                }
            }, true);  // Capture phase
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Écouter l'événement d'ouverture de l'éditeur
            window.electron.on('execute-open-editor', ({ imageId, imageName }) => {
                console.log('=== DEBUG: Réception de la demande d\'ouverture de l\'éditeur ===', { imageId, imageName });
                
                // Vérifier si GoldenLayout est initialisé
                if (!window.goldenlayout) {
                    console.error('=== DEBUG: GoldenLayout n\'est pas encore initialisé ===');
                    return;
                }

                // Créer un nouveau composant pour l'éditeur d'image
                const componentConfig = {
                    type: 'component',
                    componentName: 'image-editor',
                    id: `image-editor-${imageId}`,
                    title: `Éditeur - ${imageName || `Image ${imageId}`}`,
                    componentState: { 
                        imageId: imageId,
                        imageName: imageName
                    }
                };

                try {
                    // Ajouter le composant à la mise en page
                    window.goldenlayout.root.contentItems[0].addChild(componentConfig);
                    console.log('=== DEBUG: Composant éditeur ajouté ===');
                } catch (error) {
                    console.error('=== DEBUG: Erreur lors de l\'ajout du composant ===', error);
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Écouter les événements d'édition d'image
            window.electron.on('request-open-image-editor', (event) => {
                console.log('=== DEBUG: Événement IPC request-open-image-editor reçu ===', event);
                
                // Éviter les doublons
                const existingEditor = mainLayout.root.getItemsById('image-editor-' + event.imageId)[0];
                if (existingEditor) {
                    console.log('=== DEBUG: Éditeur déjà ouvert, focus sur celui-ci ===');
                    existingEditor.parent.setActiveContentItem(existingEditor);
                    return;
                }

                handleImageEditorRequest(event);
            });

            // Écouter aussi les messages window pour le cas local
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'request-open-image-editor') {
                    console.log('=== DEBUG: Message local request-open-image-editor reçu ===', event);
                    
                    // Éviter les doublons
                    const existingEditor = mainLayout.root.getItemsById('image-editor-' + event.data.data.imageId)[0];
                    if (existingEditor) {
                        console.log('=== DEBUG: Éditeur déjà ouvert, focus sur celui-ci ===');
                        existingEditor.parent.setActiveContentItem(existingEditor);
                        return;
                    }

                    handleImageEditorRequest(event.data.data);
                }
            });

            // Fonction pour gérer la demande d'édition d'image
            function handleImageEditorRequest(data) {
                console.log('=== DEBUG: Traitement de la demande d\'édition ===', data);
                
                // Récupérer la racine du layout
                const rootContentItems = mainLayout.root.contentItems[0];
                console.log('=== DEBUG: Root content items ===', rootContentItems);
                
                // Éviter les doublons
                const existingEditor = mainLayout.root.getItemsById('image-editor-' + data.imageId)[0];
                if (existingEditor) {
                    console.log('=== DEBUG: Éditeur déjà ouvert, focus sur celui-ci ===');
                    existingEditor.parent.setActiveContentItem(existingEditor);
                    return;
                }

                // Configuration du composant
                const config = {
                    type: 'component',
                    componentName: 'image-editor',
                    componentState: {
                        imageId: data.imageId,
                        imageName: data.imageName
                    },
                    title: 'Éditeur - Image ' + data.imageId,
                    id: 'image-editor-' + data.imageId
                };
                console.log('=== DEBUG: Configuration du composant ===', config);

                // Ajouter le composant au layout
                try {
                    rootContentItems.addChild(config);
                    console.log('=== DEBUG: Composant éditeur ajouté avec succès ===');
                } catch (error) {
                    console.error('Erreur lors de l\'ajout du composant:', error);
                }
            }
        });
    </script>
</body>
</html>
