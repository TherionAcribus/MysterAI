<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MysteryAI - Géocaching</title>
    
    <!-- Styles -->
    <link type="text/css" rel="stylesheet" href="/css/output.css">
    <link type="text/css" rel="stylesheet" href="/vendor/golden-layout/goldenlayout-base.css">
    <link type="text/css" rel="stylesheet" href="/vendor/golden-layout/goldenlayout-dark-theme.css">
    <link rel="stylesheet" href="/vendor/fontawesome/css/all.min.css">
    <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="https://unpkg.com/htmx.org@2.0.4" integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>
    
    <style>
        /* Custom styles for VSCode-like layout */
        .workspace-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            background-color: #1e1e1e;
            position: relative; /* Ajout de position relative */
        }
        
        .sidebar {
            width: 48px;
            flex-shrink: 0;
            z-index: 10;
            background-color: #252526;
            border-right: 1px solid #3c3c3c;
        }

        .sidebar.right-sidebar {
            border-right: none;
            border-left: 1px solid #3c3c3c;
            order: 3;
        }
        
        .panel-container {
            display: flex;
            flex: 1;
            position: relative;
            background-color: #1e1e1e;
            order: 2;
            overflow: hidden;
        }
        
        .side-panel {
            width: 250px;
            height: 100%;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            transform: translateX(-100%);
            transition: transform 0.15s ease-out;
            z-index: 5;
            background-color: #252526;
            border-right: 1px solid #3c3c3c;
            opacity: 0;
        }

        .side-panel.right-panel {
            left: auto;
            right: 0;
            transform: translateX(100%);
            border-right: none;
            border-left: 1px solid #3c3c3c;
            position: fixed;
            top: 0;
            bottom: 22px; /* Hauteur de la barre de statut */
            width: 250px;
        }

        .side-panel.visible {
            transform: translateX(0);
            opacity: 1;
        }

        .resizer {
            position: absolute;
            right: -5px;
            top: 0;
            bottom: 0;
            width: 10px;
            cursor: ew-resize;
            z-index: 15;
            pointer-events: none;
        }

        .right-panel .resizer {
            right: auto;
            left: -5px;
        }

        .side-panel.visible .resizer {
            pointer-events: all;
        }

        .resizer:hover, .resizing {
            background-color: #007fd4;
            opacity: 0.4;
        }
        
        .main-content {
            flex: 1;
            margin-left: 0;
            margin-right: 0;
            transition: margin-left 0.15s ease-out, margin-right 0.15s ease-out;
            background-color: #1e1e1e;
            position: relative;
            z-index: 1;
            min-width: 0; /* Important pour éviter le débordement */
        }
        
        .main-content.shifted-left {
            margin-left: 250px;
        }

        .main-content.shifted-right {
            margin-right: 250px;
        }

        .main-content.shifted-bottom {
            margin-bottom: 300px;
        }

        /* Désactiver les transitions pendant le redimensionnement */
        .resizing .side-panel,
        .resizing .main-content {
            transition: none !important;
        }

        /* Styles pour le chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 1rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            background-color: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 0.5rem;
            color: #fff;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: #007fd4;
        }

        .chat-send-button {
            background-color: #007fd4;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            color: white;
            cursor: pointer;
        }

        .chat-send-button:hover {
            background-color: #1a8ad4;
        }
        
        .status-bar {
            height: 22px;
            background-color: #252526;
            border-top: 1px solid #3c3c3c;
            color: #cccccc;
            position: relative;
            z-index: 5; /* Au-dessus du panneau */
        }

        /* Styles pour le panneau inférieur */
        .bottom-panel-container {
            position: absolute;
            left: 48px; /* Largeur de la barre latérale */
            right: 48px;
            bottom: 22px; /* Hauteur de la barre de statut */
            background-color: #252526;
            border-top: 1px solid #3c3c3c;
            transform: translateY(calc(100% - 35px)); /* 35px est la hauteur de l'en-tête des onglets */
            transition: transform 0.15s ease-out;
            z-index: 4; /* En dessous de la barre d'état */
            display: flex;
            flex-direction: column;
            height: 300px;
        }

        .bottom-panel-container.visible {
            transform: translateY(0);
        }

        .bottom-panel-header {
            display: flex;
            align-items: center;
            padding: 0 8px;
            height: 35px;
            background-color: #2d2d2d;
            border-bottom: 1px solid #3c3c3c;
            user-select: none;
        }

        .bottom-panel-tabs {
            display: flex;
            gap: 1px;
            height: 100%;
        }

        .bottom-panel-tab {
            padding: 0 16px;
            display: flex;
            align-items: center;
            height: 100%;
            background-color: #2d2d2d;
            border: none;
            color: #969696;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }

        .bottom-panel-tab:hover {
            background-color: #303030;
        }

        .bottom-panel-tab.active {
            background-color: #252526;
            color: #ffffff;
            border-top: 1px solid #007fd4;
            margin-top: -1px;
        }

        .bottom-panel-tab i {
            margin-right: 8px;
        }

        .bottom-panel-content {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .bottom-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 16px;
            display: none;
        }

        .bottom-panel.visible {
            display: block;
        }

        .bottom-panel-resizer {
            position: absolute;
            left: 0;
            right: 0;
            top: -5px;
            height: 10px;
            cursor: ns-resize;
            z-index: 15;
        }

        .bottom-panel-resizer:hover {
            background-color: #007fd4;
            opacity: 0.4;
        }

        /* Ajustement du panneau droit quand le panneau inférieur est ouvert */
        .side-panel.right-panel.with-bottom-panel {
            bottom: 322px; /* 300px + 22px */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300 h-screen flex flex-col overflow-hidden">
    <!-- Main Container -->
    <div class="workspace-container">
        <!-- Left Sidebar -->
        <div class="sidebar bg-gray-800 border-r border-gray-700 flex flex-col">
            <div class="flex-1 flex flex-col items-center py-2 space-y-4">
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="geocaches" data-side="left"
                        hx-get="/api/zones"
                        hx-target="#geocaches-panel-content"
                        hx-trigger="click"
                        hx-headers='{"HX-Request": "true"}'>
                    <i class="fas fa-map-marker-alt"></i>
                </button>
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="search" data-side="left">
                    <i class="fas fa-search text-xl"></i>
                </button>
                <button class="sidebar-button p-3 hover:bg-gray-700 relative" data-panel="git" data-side="left">
                    <i class="fas fa-code-branch text-xl"></i>
                </button>
            </div>
            <div class="mt-auto flex flex-col items-center py-2 space-y-4">
                <button class="text-gray-400 hover:text-white w-full py-2 flex justify-center sidebar-button" title="Settings" data-panel="settings" data-side="left">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </div>
        </div>

        <div class="panel-container">
            <!-- Left Panel -->
            <div id="left-panel" class="side-panel bg-gray-800 border-r border-gray-700">
                <div class="resizer"></div>
                <div id="geocaches-panel" class="h-full p-4 panel-content">
                    <div class="panel-header border-b border-gray-700 p-2">
                        <h2 class="text-lg font-semibold">Géocaches</h2>
                    </div>
                    <div id="geocaches-panel-content" class="panel-body">
                        <!-- Le contenu sera chargé ici par HTMX -->
                    </div>
                </div>
                <div id="search-panel" class="h-full p-4 hidden">
                    <h2 class="text-sm font-semibold mb-4">SEARCH</h2>
                </div>
                <div id="git-panel" class="h-full p-4 hidden">
                    <h2 class="text-sm font-semibold mb-4">SOURCE CONTROL</h2>
                </div>
                <div id="settings-panel" class="h-full p-4 hidden">
                    <h2 class="text-sm font-semibold mb-4">SETTINGS</h2>
                </div>
            </div>

            <!-- Main Content -->
            <div id="main-content" class="main-content bg-gray-900">
                <!-- Golden Layout will manage this area -->
            </div>

            <!-- Right Panel -->
            <div class="side-panel right-panel bg-gray-800">
                <div class="resizer"></div>
                <div id="chat-panel" class="chat-container">
                    <h2 class="text-sm font-semibold mb-4">CHAT IA</h2>
                    <div class="chat-messages">
                        <!-- Les messages du chat apparaîtront ici -->
                    </div>
                    <div class="chat-input-container">
                        <textarea class="chat-input" rows="3" placeholder="Tapez votre message..."></textarea>
                        <button class="chat-send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="sidebar right-sidebar bg-gray-800 flex flex-col">
            <div class="flex-1 flex flex-col items-center py-2 space-y-4">
                <button class="text-gray-400 hover:text-white w-full py-2 flex justify-center sidebar-button" title="Chat IA" data-panel="chat" data-side="right">
                    <i class="fas fa-comments text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Panel -->
    <div class="bottom-panel-container">
        <div class="bottom-panel-header">
            <div class="bottom-panel-tabs">
                <button class="bottom-panel-tab active" data-panel="map">
                    <i class="fas fa-map"></i>
                    Map
                </button>
                <button class="bottom-panel-tab" data-panel="notes">
                    <i class="fas fa-sticky-note"></i>
                    Notes
                </button>
                <button class="bottom-panel-tab" data-panel="info">
                    <i class="fas fa-info-circle"></i>
                    Informations
                </button>
            </div>
        </div>
        <div class="bottom-panel-content">
            <div id="map-panel" class="bottom-panel visible">
                <div id="map" class="w-full h-full"></div>
            </div>
            <div id="notes-panel" class="bottom-panel">
                <div class="h-full flex flex-col">
                    <textarea class="flex-1 bg-gray-800 text-gray-300 p-4 border border-gray-700 rounded resize-none focus:outline-none focus:border-blue-500" 
                              placeholder="Prenez vos notes ici..."></textarea>
                </div>
            </div>
            <div id="info-panel" class="bottom-panel">
                <div class="space-y-4">
                    <div class="bg-gray-800 p-4 rounded">
                        <h3 class="text-lg font-semibold text-blue-400 mb-2">Détails de la cache</h3>
                        <div class="space-y-2">
                            <p><span class="text-gray-400">Difficulté:</span> <span class="text-yellow-400">★★★☆☆</span></p>
                            <p><span class="text-gray-400">Terrain:</span> <span class="text-green-400">★★☆☆☆</span></p>
                            <p><span class="text-gray-400">Taille:</span> Regular</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded">
                        <h3 class="text-lg font-semibold text-blue-400 mb-2">Indices</h3>
                        <p class="text-gray-300">Aucun indice disponible pour le moment.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="bottom-panel-resizer"></div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar flex items-center px-2 text-sm">
        <div class="flex-1">Ready</div>
        <div class="flex items-center space-x-4">
            <span>UTF-8</span>
            <span>JavaScript</span>
            <span>Ln 1, Col 1</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/golden-layout/goldenlayout.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script>
        function loadZones() {
            const target = document.getElementById('geocaches-panel-content');
            fetch('/api/zones', {
                method: 'GET',
                headers: {
                    'HX-Request': 'true'
                }
            })
            .then(response => response.text())
            .then(html => {
                target.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                target.innerHTML = '<div class="p-4 text-red-500">Erreur lors du chargement des zones</div>';
            });
        }

        function initializeLayout() {
            const config = {
                settings: {
                    showPopoutIcon: false,
                    showMaximiseIcon: true,
                    showCloseIcon: true,
                },
                content: [{
                    type: 'row',
                    content: [{
                        type: 'component',
                        componentName: 'welcome',
                        title: 'Welcome',
                        isClosable: false,
                        componentState: {}
                    }]
                }]
            };

            try {
                const layout = new GoldenLayout(config, document.getElementById('main-content'));

                layout.registerComponent('welcome', function(container, state) {
                    const welcomeHtml = `
                        <div class="p-8 max-w-4xl mx-auto">
                            <div class="text-center mb-8">
                                <h1 class="text-4xl font-bold text-blue-400 mb-4">Welcome to MysteryAI</h1>
                                <p class="text-xl text-gray-400">Your Geocaching Adventure Starts Here</p>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-6 mb-8">
                                <div class="bg-gray-800 rounded-lg p-6 hover:bg-gray-700 transition-colors cursor-pointer">
                                    <h2 class="text-xl font-semibold text-blue-300 mb-3">
                                        <i class="fas fa-map-marked-alt mr-2"></i>
                                        Start New Adventure
                                    </h2>
                                    <p class="text-gray-300">Create a new geocaching challenge or explore existing ones in your area.</p>
                                </div>
                                
                                <div class="bg-gray-800 rounded-lg p-6 hover:bg-gray-700 transition-colors cursor-pointer">
                                    <h2 class="text-xl font-semibold text-green-300 mb-3">
                                        <i class="fas fa-compass mr-2"></i>
                                        Recent Caches
                                    </h2>
                                    <p class="text-gray-300">Continue working on your recent geocaching projects.</p>
                                </div>
                                
                                <div class="bg-gray-800 rounded-lg p-6 hover:bg-gray-700 transition-colors cursor-pointer">
                                    <h2 class="text-xl font-semibold text-purple-300 mb-3">
                                        <i class="fas fa-tools mr-2"></i>
                                        Tools & Resources
                                    </h2>
                                    <p class="text-gray-300">Access helpful tools and resources for creating engaging geocaches.</p>
                                </div>
                                
                                <div class="bg-gray-800 rounded-lg p-6 hover:bg-gray-700 transition-colors cursor-pointer">
                                    <h2 class="text-xl font-semibold text-yellow-300 mb-3">
                                        <i class="fas fa-book mr-2"></i>
                                        Documentation
                                    </h2>
                                    <p class="text-gray-300">Learn how to use MysteryAI and discover best practices.</p>
                                </div>
                            </div>
                        </div>
                    `;
                    container.getElement().html(welcomeHtml);
                });

                layout.registerComponent('geocachesTable', function(container, state) {
                    console.log("Création du composant geocachesTable pour la zone", state.zoneId);
                    
                    // Créer le conteneur pour le tableau
                    const element = container.getElement();
                    const url = `${window.location.origin}/geocaches/table/${state.zoneId}`;
                    console.log("URL de la requête:", url);
                    
                    // Créer l'élément div avec un ID unique
                    const containerId = `geocaches-container-${state.zoneId}`;
                    const div = document.createElement('div');
                    div.id = containerId;
                    div.className = 'w-full h-full';
                    
                    // Ajouter l'indicateur de chargement
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'loading-indicator flex items-center justify-center w-full h-full';
                    const spinner = document.createElement('div');
                    spinner.className = 'animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500';
                    loadingDiv.appendChild(spinner);
                    div.appendChild(loadingDiv);
                    
                    // Vider le conteneur et ajouter le nouvel élément
                    element[0].innerHTML = '';
                    element[0].appendChild(div);
                    
                    // Charger le contenu via fetch
                    console.log("Chargement du contenu via fetch");
                    fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'text/html',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => {
                        console.log("Réponse reçue:", response);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        console.log("HTML reçu, mise à jour du contenu");
                        
                        // Créer un conteneur temporaire pour parser le HTML
                        const temp = document.createElement('div');
                        temp.innerHTML = html;
                        
                        // Extraire les scripts
                        const scripts = temp.getElementsByTagName('script');
                        const scriptsArray = Array.from(scripts);
                        
                        // Supprimer les scripts du HTML
                        scriptsArray.forEach(script => script.remove());
                        
                        // Mettre à jour le contenu sans les scripts
                        div.innerHTML = temp.innerHTML;
                        
                        // Fonction pour exécuter les scripts dans l'ordre
                        const executeScripts = (scripts, index = 0) => {
                            if (index >= scripts.length) {
                                console.log("Tous les scripts ont été exécutés");
                                return;
                            }
                            
                            const script = scripts[index];
                            const newScript = document.createElement('script');
                            newScript.textContent = script.textContent;
                            
                            // Copier les attributs
                            Array.from(script.attributes).forEach(attr => {
                                newScript.setAttribute(attr.name, attr.value);
                            });
                            
                            // Exécuter le script suivant une fois celui-ci chargé
                            newScript.onload = () => executeScripts(scripts, index + 1);
                            newScript.onerror = (error) => console.error("Erreur lors du chargement du script:", error);
                            
                            console.log("Exécution du script", index + 1);
                            document.head.appendChild(newScript);
                        };
                        
                        // Commencer l'exécution des scripts
                        executeScripts(scriptsArray);
                        
                        // Configurer le redimensionnement
                        const tableId = `geocaches-table-${state.zoneId}`;
                        container.on('resize', function() {
                            console.log("Redimensionnement du composant geocachesTable");
                            const table = window[`tabulator_${tableId}`];
                            if (table) {
                                console.log("Redimensionnement du tableau Tabulator");
                                table.redraw(true);
                            }
                        });
                    })
                    .catch(error => {
                        console.error("Erreur lors du chargement:", error);
                        div.innerHTML = `<div class="text-red-500">Erreur lors du chargement: ${error.message}</div>`;
                    });
                });

                layout.registerComponent('openGeocachesTab', function(container, state) {
                    console.log("Création du composant openGeocachesTab pour la zone", state.zoneId);
                    
                    // Créer le conteneur pour le tableau
                    const element = container.getElement();
                    const url = `/geocaches/table/${state.zoneId}`;
                    console.log("URL de la requête HTMX:", url);
                    
                    // Créer l'élément div manuellement
                    const div = document.createElement('div');
                    div.className = 'w-full h-full';
                    div.setAttribute('hx-get', url);
                    div.setAttribute('hx-trigger', 'load');
                    div.setAttribute('hx-swap', 'innerHTML');
                    div.setAttribute('hx-indicator', '.loading-indicator');
                    
                    // Ajouter l'indicateur de chargement
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'loading-indicator flex items-center justify-center w-full h-full';
                    const spinner = document.createElement('div');
                    spinner.className = 'animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500';
                    loadingDiv.appendChild(spinner);
                    div.appendChild(loadingDiv);
                    
                    // Vider le conteneur et ajouter le nouvel élément
                    element[0].innerHTML = '';
                    element[0].appendChild(div);
                    
                    // Forcer HTMX à scanner le nouvel élément
                    console.log("Processing HTMX on element:", div);
                    htmx.process(div);

                    // Gérer le redimensionnement
                    container.on('resize', function() {
                        console.log("Redimensionnement du composant openGeocachesTab");
                        const tableDiv = element.find(`#geocaches-table-${state.zoneId}`);
                        if (tableDiv.length > 0) {
                            const tabulatorInstance = Tabulator.findTable(`#geocaches-table-${state.zoneId}`)[0];
                            if (tabulatorInstance) {
                                console.log("Redimensionnement du tableau Tabulator");
                                tabulatorInstance.redraw(true);
                            }
                        }
                    });
                });

                layout.registerComponent('geocache-details', function(container, state) {
                    console.log("Création du composant geocache-details", state);
                    
                    // Créer le conteneur pour les détails
                    const element = container.getElement();
                    
                    // Injecter le HTML des détails
                    element[0].innerHTML = state.html;
                    
                    // Initialiser Alpine.js sur le contenu si nécessaire
                    if (window.Alpine) {
                        window.Alpine.initTree(element[0]);
                    }
                    
                    // Gérer le redimensionnement si nécessaire
                    container.on('resize', function() {
                        console.log("Redimensionnement du composant geocache-details");
                    });
                });

                // Exposer l'instance Golden Layout globalement
                window.goldenlayout = layout;

                // Écouter l'événement openGeocacheDetails depuis les iframes
                window.addEventListener('message', function(event) {
                    if (event.data && event.data.type === 'openGeocacheDetails') {
                        const geocacheId = event.data.geocacheId;
                        console.log("Réception de l'événement openGeocacheDetails pour la géocache", geocacheId);
                        
                        // Charger les détails et ouvrir l'onglet
                        fetch(`/geocaches/${geocacheId}/details-panel`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.text();
                            })
                            .then(html => {
                                const root = layout.root;
                                const newItemConfig = {
                                    type: 'component',
                                    componentName: 'geocache-details',
                                    title: `Détails GC-${geocacheId}`,
                                    componentState: { 
                                        html: html,
                                        geocacheId: geocacheId
                                    }
                                };
                                
                                // Ajouter le composant à la racine du layout
                                root.contentItems[0].addChild(newItemConfig);
                            })
                            .catch(error => {
                                console.error("Erreur lors du chargement des détails:", error);
                                alert("Erreur lors du chargement des détails de la géocache");
                            });
                    }
                });

                layout.init();
                window.mainLayout = layout;

                window.addEventListener('resize', () => {
                    layout.updateSize();
                });
            } catch (error) {
                console.error('Golden Layout error:', error);
            }
        }

        window.openGeocachesTab = function(zoneId, zoneName) {
            const componentId = `geocaches-${zoneId}`;
            
            let existingComponent = null;
            window.mainLayout.root.contentItems.forEach(item => {
                item.contentItems.forEach(subItem => {
                    if (subItem.config.id === componentId) {
                        existingComponent = subItem;
                    }
                });
            });

            if (existingComponent) {
                existingComponent.parent.setActiveContentItem(existingComponent);
                return;
            }

            const newItemConfig = {
                type: 'component',
                componentName: 'geocachesTable',
                title: `Géocaches - ${zoneName}`,
                id: componentId,
                componentState: { 
                    zoneId: zoneId,
                    zoneName: zoneName
                }
            };

            if (window.mainLayout.root.contentItems[0].type === 'row') {
                window.mainLayout.root.contentItems[0].addChild(newItemConfig);
            } else {
                window.mainLayout.root.contentItems[0].addChild({
                    type: 'row',
                    content: [newItemConfig]
                });
            }
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeLayout);
        } else {
            initializeLayout();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier que HTMX est chargé
            if (typeof htmx === 'undefined') {
                console.error('HTMX n\'est pas chargé !');
            } else {
                console.log('HTMX est chargé correctement');
            }

            // Logger les événements HTMX
            document.body.addEventListener('htmx:beforeRequest', function(evt) {
                console.log('HTMX - Avant la requête:', evt.detail);
            });
            
            document.body.addEventListener('htmx:afterRequest', function(evt) {
                console.log('HTMX - Après la requête:', evt.detail);
            });
            
            document.body.addEventListener('htmx:error', function(evt) {
                console.error('HTMX - Erreur:', evt.detail);
            });

            const leftPanel = document.querySelector('.side-panel:not(.right-panel)');
            const rightPanel = document.querySelector('.side-panel.right-panel');
            const mainContent = document.querySelector('.main-content');
            const leftResizer = leftPanel.querySelector('.resizer');
            const rightResizer = rightPanel.querySelector('.resizer');
            const bottomPanel = document.querySelector('.bottom-panel-container');
            const bottomPanelResizer = bottomPanel.querySelector('.bottom-panel-resizer');
            
            let activeLeftButton = null;
            let activeRightButton = null;
            let activeLeftPanelId = null;
            let activeRightPanelId = null;
            let isResizing = false;
            let activePanel = null;

            function showPanel(panelId, isRight) {
                const targetPanel = isRight ? rightPanel : leftPanel;
                const panels = targetPanel.querySelectorAll('div[id$="-panel"]');
                panels.forEach(panel => {
                    panel.classList.add('hidden');
                });
                const panel = document.getElementById(panelId + '-panel');
                if (panel) {
                    panel.classList.remove('hidden');
                }
            }

            function handleResize(e, panel, isRight) {
                if (!isResizing) return;
                
                if (isRight) {
                    const maxWidth = Math.min(800, window.innerWidth - 100);
                    const width = Math.min(maxWidth, Math.max(250, window.innerWidth - e.clientX));
                    panel.style.width = `${width}px`;
                    mainContent.style.marginRight = `${width}px`;
                } else {
                    const width = Math.min(800, Math.max(250, e.clientX));
                    panel.style.width = `${width}px`;
                    mainContent.style.marginLeft = `${width}px`;
                }
                
                if (window.mainLayout) {
                    window.mainLayout.updateSize();
                }
            }

            [leftResizer, rightResizer].forEach(resizer => {
                const isRight = resizer === rightResizer;
                const panel = isRight ? rightPanel : leftPanel;
                
                resizer.addEventListener('mousedown', function(e) {
                    if (!panel.classList.contains('visible')) return;
                    
                    isResizing = true;
                    activePanel = panel;
                    document.body.classList.add('resizing');
                    
                    panel.style.transition = 'none';
                    mainContent.style.transition = 'none';
                    
                    e.preventDefault();
                });
            });

            bottomPanelResizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                activePanel = bottomPanel;
                document.body.classList.add('resizing');
                
                bottomPanel.style.transition = 'none';
                mainContent.style.transition = 'none';
                
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing || !activePanel) return;
                if (activePanel === bottomPanel) {
                    const HEADER_HEIGHT = 35; 
                    const maxHeight = Math.min(800, window.innerHeight - 100);
                    const newHeight = Math.min(maxHeight, Math.max(HEADER_HEIGHT, window.innerHeight - e.clientY));
                    
                    bottomPanel.style.height = newHeight + 'px';
                    
                    const visibleHeight = Math.max(0, newHeight - HEADER_HEIGHT);
                    mainContent.style.marginBottom = visibleHeight + 'px';
                    
                    if (newHeight <= HEADER_HEIGHT) {
                        bottomPanel.classList.remove('visible');
                        mainContent.classList.remove('shifted-bottom');
                    } else {
                        bottomPanel.classList.add('visible');
                        mainContent.classList.add('shifted-bottom');
                    }
                    
                    if (window.mainLayout) {
                        window.mainLayout.updateSize();
                    }
                } else {
                    handleResize(e, activePanel, activePanel === rightPanel);
                }
            });

            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.classList.remove('resizing');
                    
                    if (activePanel) {
                        activePanel.style.transition = '';
                        mainContent.style.transition = '';
                        
                        activePanel = null;
                    }
                }
            });

            document.querySelectorAll('.sidebar-button').forEach(button => {
                button.addEventListener('click', function() {
                    const panelId = this.dataset.panel;
                    const isRight = this.dataset.side === 'right';
                    const panel = isRight ? rightPanel : leftPanel;
                    const shiftClass = isRight ? 'shifted-right' : 'shifted-left';
                    
                    if ((isRight && activeRightButton === this) || (!isRight && activeLeftButton === this)) {
                        this.classList.remove('active');
                        panel.classList.remove('visible');
                        mainContent.classList.remove(shiftClass);
                        
                        panel.style.width = '250px';
                        if (isRight) {
                            mainContent.style.marginRight = '0';
                            panel.style.transform = 'translateX(100%)';
                            activeRightButton = null;
                            activeRightPanelId = null;
                        } else {
                            mainContent.style.marginLeft = '0';
                            panel.style.transform = 'translateX(-100%)';
                            activeLeftButton = null;
                            activeLeftPanelId = null;
                        }
                    } else {
                        if (isRight && activeRightButton) {
                            activeRightButton.classList.remove('active');
                            rightPanel.classList.remove('visible');
                            mainContent.classList.remove('shifted-right');
                            rightPanel.style.transform = 'translateX(100%)';
                        } else if (!isRight && activeLeftButton) {
                            activeLeftButton.classList.remove('active');
                            leftPanel.classList.remove('visible');
                            mainContent.classList.remove('shifted-left');
                            leftPanel.style.transform = 'translateX(-100%)';
                        }
                        
                        this.classList.add('active');
                        panel.classList.add('visible');
                        mainContent.classList.add(shiftClass);
                        
                        panel.style.transform = 'translateX(0)';
                        const currentWidth = panel.style.width || '250px';
                        if (isRight) {
                            mainContent.style.marginRight = currentWidth;
                            activeRightButton = this;
                            activeRightPanelId = panelId;
                        } else {
                            mainContent.style.marginLeft = currentWidth;
                            activeLeftButton = this;
                            activeLeftPanelId = panelId;
                        }
                        
                        showPanel(panelId, isRight);
                    }

                    if (window.mainLayout) {
                        setTimeout(() => {
                            window.mainLayout.updateSize();
                        }, 300);
                    }
                });
            });

            const chatInput = document.querySelector('.chat-input');
            const chatSendButton = document.querySelector('.chat-send-button');
            const chatMessages = document.querySelector('.chat-messages');

            function sendMessage() {
                const message = chatInput.value.trim();
                if (message) {
                    const messageElement = document.createElement('div');
                    messageElement.className = 'mb-4';
                    messageElement.innerHTML = `
                        <div class="bg-gray-700 rounded p-3 max-w-3/4 ml-auto">
                            ${message}
                        </div>
                    `;
                    chatMessages.appendChild(messageElement);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    chatInput.value = '';
                }
            }

            chatSendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            const bottomPanelTabs = document.querySelectorAll('.bottom-panel-tab');
            const bottomPanelContents = document.querySelectorAll('.bottom-panel');
            let isBottomPanelVisible = false;

            bottomPanelTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    if (!isBottomPanelVisible) {
                        bottomPanel.style.height = '300px';
                        mainContent.style.marginBottom = (300 - 35) + 'px';
                        bottomPanel.classList.add('visible');
                        mainContent.classList.add('shifted-bottom');
                        isBottomPanelVisible = true;
                    }

                    bottomPanelTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    bottomPanelContents.forEach(panel => {
                        if (panel.id === this.dataset.panel + '-panel') {
                            panel.classList.add('visible');
                        } else {
                            panel.classList.remove('visible');
                        }
                    });

                    if (window.mainLayout) {
                        setTimeout(() => {
                            window.mainLayout.updateSize();
                        }, 300);
                    }
                });
            });

            const bottomPanelToggleButton = document.createElement('button');
            bottomPanelToggleButton.className = 'text-gray-400 hover:text-white w-full py-2 flex justify-center sidebar-button';
            bottomPanelToggleButton.title = 'Toggle Bottom Panel';
            bottomPanelToggleButton.innerHTML = '<i class="fas fa-angle-up"></i>';
            
            bottomPanelToggleButton.addEventListener('click', function() {
                if (bottomPanel.classList.contains('visible')) {
                    bottomPanel.classList.remove('visible');
                    mainContent.classList.remove('shifted-bottom');
                    this.innerHTML = '<i class="fas fa-angle-up"></i>';
                    isBottomPanelVisible = false;
                } else {
                    bottomPanel.style.height = '300px';
                    mainContent.style.marginBottom = (300 - 35) + 'px';
                    bottomPanel.classList.add('visible');
                    mainContent.classList.add('shifted-bottom');
                    this.innerHTML = '<i class="fas fa-angle-down"></i>';
                    isBottomPanelVisible = true;
                }

                if (window.mainLayout) {
                    setTimeout(() => {
                        window.mainLayout.updateSize();
                    }, 300);
                }
            });

            const rightSidebar = document.querySelector('.sidebar.right-sidebar .flex-1');
            rightSidebar.appendChild(bottomPanelToggleButton);
        });
    </script>
</body>
</html>
