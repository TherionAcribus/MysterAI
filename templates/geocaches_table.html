<!-- Template pour le tableau des géocaches -->
<div class="w-full h-full bg-gray-900 p-4">
    <!-- Formulaire d'ajout de géocache -->
    <div class="flex gap-4 items-end mb-4">
        <form id="addGeocacheForm" class="flex gap-4 items-end">
            <div>
                <label for="geocacheCode" class="block text-sm font-medium text-gray-300">Code GC</label>
                <input type="text" id="geocacheCode" name="code" required
                       class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                       placeholder="GC12345">
                <input type="hidden" name="zone_id" value="{{ zone_id }}">
            </div>
            <button type="submit" 
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded inline-flex items-center">
                <span>Ajouter</span>
                <div class="loading-indicator hidden ml-2">
                    <div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                </div>
            </button>
        </form>
        <div id="spinner" class="spinner"></div>
        <div id="message" class="mt-2"></div>
    </div>

    <div id="geocaches-table-{{ zone_id }}" class="w-full h-full"
         data-zone-id="{{ zone_id }}"
         data-api-url="{{ url_for('geocaches.get_geocaches', zone_id=zone_id) }}"
    ></div>
</div>

<style>
    .spinner {
        display: none;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 10px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script type="text/javascript">
    // S'assurer que le script s'exécute dans l'iframe
    (function() {
        const form = document.getElementById('addGeocacheForm');
        const loadingIndicator = form.querySelector('.loading-indicator');
        const spinner = document.getElementById('spinner');
        const messageDiv = document.getElementById('message');
        const submitButton = form.querySelector('button[type="submit"]');

        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log('Soumission du formulaire interceptée');
            
            try {
                // Afficher l'indicateur de chargement
                loadingIndicator.classList.remove('hidden');
                spinner.style.display = 'block';
                messageDiv.textContent = '';
                messageDiv.className = 'mt-2';
                submitButton.disabled = true;
                
                // Préparer les données du formulaire
                const formData = new FormData(form);
                
                // Faire la requête
                const response = await fetch('{{ url_for('geocaches.add_geocache') }}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });
                
                // Traiter la réponse
                const data = await response.json();
                console.log('Réponse reçue:', data);
                
                if (!response.ok) {
                    throw new Error(data.error || 'Une erreur est survenue');
                }
                
                if (data.id) {
                    // Rafraîchir le tableau
                    const table = window['tabulator_geocaches-table-{{ zone_id }}'];
                    if (table) {
                        console.log('Rafraîchissement du tableau');
                        table.setData();
                    } else {
                        console.error('Table non trouvée');
                    }
                    
                    // Ouvrir le panneau de détails
                    const detailsUrl = `${window.API_BASE_URL || ''}/geocaches/${data.id}/details-panel`;
                    console.log('Ouverture du panneau', detailsUrl);
                    window.parent.postMessage({
                        type: 'openGeocacheDetails',
                        geocacheId: data.id,
                        containerId: window.currentContainerId,
                        detailsUrl: detailsUrl
                    }, '*');
                    
                    // Réinitialiser le formulaire
                    form.reset();
                    messageDiv.textContent = 'Géocache ajoutée avec succès !';
                    messageDiv.className = 'mt-2 text-green-600';
                }
            } catch (error) {
                console.error('Erreur:', error);
                messageDiv.textContent = 'Une erreur est survenue lors de la communication avec le serveur';
                messageDiv.className = 'mt-2 text-red-600';
            } finally {
                // Cacher l'indicateur de chargement
                loadingIndicator.classList.add('hidden');
                spinner.style.display = 'none';
                submitButton.disabled = false;
            }
        });
    })();
</script>

<script type="text/javascript">
    (function() {
        const tableId = "geocaches-table-{{ zone_id }}";
        console.log("Initialisation du tableau", tableId);
        const tableElement = document.getElementById(tableId);
        
        if (tableElement) {
            try {
                const config = {
                    layout: "fitDataFill",
                    height: "100%",
                    placeholder: "Aucune géocache trouvée",
                    ajaxURL: tableElement.getAttribute('data-api-url'),
                    ajaxLoaderLoading: '<div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>',
                    ajaxRequestHeaders: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    ajaxConfig: {
                        method: "GET",
                        headers: {
                            'Accept': 'application/json'
                        }
                    },
                    columns: [
                        {title: "GC Code", field: "gc_code", headerSort: true},
                        {title: "Nom", field: "name", headerSort: true},
                        {title: "Type", field: "cache_type", headerSort: true},
                        {title: "Difficulté", field: "difficulty", headerSort: true},
                        {title: "Terrain", field: "terrain", headerSort: true},
                        {title: "Taille", field: "size", headerSort: true},
                        {title: "Favoris", field: "favorites_count", headerSort: true},
                        {title: "Logs", field: "logs_count", headerSort: true},
                        {title: "Statut", field: "solved", headerSort: true,
                            formatter: function(cell) {
                                const value = cell.getValue();
                                switch(value) {
                                    case 'solved':
                                        return '<span class="text-green-500">✓ Résolue</span>';
                                    case 'not_solved':
                                        return '<span class="text-red-500">✗ Non résolue</span>';
                                    case 'ongoing':
                                        return '<span class="text-yellow-500">⟳ En cours</span>';
                                    default:
                                        return '<span class="text-gray-500">-</span>';
                                }
                            }
                        },
                        {title: "Actions", field: "id", headerSort: false,
                            formatter: function(cell) {
                                const geocacheId = cell.getValue();
                                const apiUrl = window.API_BASE_URL || '';
                                const detailsUrl = `${apiUrl}/geocaches/${geocacheId}/details-panel`;
                                return `<button 
                                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded"
                                    onclick="window.parent.postMessage({ 
                                        type: 'openGeocacheDetails', 
                                        geocacheId: ${geocacheId},
                                        containerId: window.currentContainerId,
                                        detailsUrl: '${detailsUrl}'
                                    }, '*')"
                                >
                                    Détails
                                </button>`;
                            }
                        }
                    ],
                    rowClick: false,
                    tableBuilt: function() {
                        console.log("Tableau construit avec succès");
                    }
                };
                
                console.log("Création du tableau Tabulator");
                const table = new Tabulator(`#${tableId}`, config);
                
                // Exposer l'instance du tableau pour le redimensionnement
                window[`tabulator_${tableId}`] = table;
                
                console.log("Tabulator initialisé avec succès");
            } catch (error) {
                console.error("Erreur lors de l'initialisation de Tabulator:", error);
            }
        } else {
            console.error(`Élément #${tableId} non trouvé`);
        }
    })();
</script>
