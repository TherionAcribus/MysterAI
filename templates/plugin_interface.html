<!-- Template pour l'interface d'un plugin -->
<div class="w-full h-full bg-gray-900 p-6" 
     data-controller="plugin-interface"
     data-plugin-interface-id-value="{{ plugin.params.get('geocacheId', 'default') }}"
     data-plugin-name="{{ plugin.name }}"
     hx-ext="json-enc">
    <div class="max-w-4xl mx-auto">
        <!-- En-tête du plugin -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-blue-400">{{ plugin.name }}</h1>
                    <p class="text-gray-400">Version {{ plugin.version }}</p>
                </div>
                <div class="text-gray-400">
                    <p>Auteur: {{ plugin.author }}</p>
                </div>
            </div>
            
            <div class="mb-6">
                <p class="text-gray-400">{{ plugin.description }}</p>
            </div>

            <div class="flex flex-wrap gap-2">
                {% for category in plugin.categories %}
                    <span class="px-3 py-1 bg-gray-700 rounded-full text-sm text-gray-300">{{ category }}</span>
                {% endfor %}
            </div>
        </div>

        <!-- Formulaire des inputs -->
        {% if not plugin.params.get('geocacheId') %}
        <form class="bg-gray-800 rounded-lg p-6 mb-6"
              data-plugin-interface-target="form">
            
            {% for input_name, input_config in plugin.input_types.items() %}
                {% if input_name == 'mode' and 'solver' in plugin.categories %}
                    <!-- Mode caché mais toujours présent avec valeur "decode" pour les plugins Solver -->
                    <input type="hidden" id="{{ input_name }}" name="{{ input_name }}" value="decode">
                {% elif (input_name == 'text' or input_name == 'input_text') and 'solver' in plugin.categories %}
                    <!-- Texte à traiter caché mais présent pour les plugins Solver -->
                    <input type="hidden" id="{{ input_name }}" name="{{ input_name }}" data-geocache-solver-target="pluginInputText">
                {% else %}
                    <div class="mb-4">
                        <label for="{{ input_name }}" class="block text-sm font-medium text-gray-300 mb-2">
                            {{ input_config.label }}
                        </label>

                        {% if input_config.type == "string" %}
                            <input type="text" 
                                id="{{ input_name }}"
                                name="{{ input_name }}"
                                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="{{ input_config.placeholder|default('') }}"
                                value="{{ plugin.params.get(input_name, input_config.default|default('')) }}">
                        {% elif input_config.type == "float" or input_config.type == "number" %}
                            <input type="number" 
                                id="{{ input_name }}"
                                name="{{ input_name }}"
                                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="{{ input_config.placeholder|default('') }}"
                                value="{{ plugin.params.get(input_name, input_config.default|default('0')) }}"
                                step="{{ input_config.step|default('any') }}"
                                min="{{ input_config.min|default('') }}"
                                max="{{ input_config.max|default('') }}">
                        {% elif input_config.type == "select" %}
                            <select id="{{ input_name }}"
                                    name="{{ input_name }}"
                                    class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                {% for option in input_config.options %}
                                    <option value="{{ option }}" 
                                            {% if option == input_config.default %}selected{% endif %}>
                                        {{ option }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% elif input_config.type == "checkbox" or input_config.type == "boolean" %}
                            <div class="flex items-center">
                                <input type="checkbox" 
                                        id="{{ input_name }}"
                                        name="{{ input_name }}"
                                        class="h-4 w-4 rounded border-gray-600 text-blue-600 focus:ring-blue-500"
                                        {% if input_config.default %}checked{% endif %}>
                                <span class="ml-2 text-sm text-gray-300">{{ input_config.description|default('') }}</span>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}

            <!-- Option brute-force si disponible -->
            {% if plugin.brute_force %}
                <div class="mb-4 mt-6 border-t border-gray-700 pt-4">
                    <div class="flex items-center">
                        <input type="checkbox" 
                                id="brute_force"
                                name="brute_force"
                                class="h-4 w-4 rounded border-gray-600 text-blue-600 focus:ring-blue-500">
                        <label for="brute_force" class="ml-2 text-sm font-medium text-gray-300">
                            Utiliser le mode force brute
                        </label>
                    </div>
                </div>
            {% endif %}

            <!-- Option enable-scoring si disponible -->
            {% if plugin.enable_scoring %}
                <div class="mb-4 mt-2">
                    <div class="flex items-center">
                        <input type="checkbox" 
                                id="enable_scoring"
                                name="enable_scoring"
                                class="h-4 w-4 rounded border-gray-600 text-blue-600 focus:ring-blue-500"
                                checked>
                        <label for="enable_scoring" class="ml-2 text-sm font-medium text-gray-300">
                            Activer le scoring automatique
                        </label>
                    </div>
                </div>
            {% endif %}

            <div class="mt-6 flex justify-end space-x-4">
                <button type="button" 
                        data-action="click->geocache-solver#cancelPlugin"
                        class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    Annuler
                </button>
                {% if 'solver' in plugin.categories %}
                    <button type="button" 
                            data-action="click->geocache-solver#executePlugin"
                            data-plugin-id="{{ plugin.id }}"
                            data-plugin-name="{{ plugin.name }}"
                            class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        Exécuter
                    </button>
                {% else %}
                    <button type="button" 
                            data-action="plugin-interface#execute"
                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 debug-button">
                        Exécuter
                    </button>
                {% endif %}
            </div>
        </form>
        {% endif %}

        <!-- Zone de résultat -->
        <div data-plugin-interface-target="output" 
             class="bg-gray-800 rounded-lg p-6 {% if not plugin.params.get('geocacheId') %}hidden{% endif %} {% if 'solver' in plugin.categories %}hidden{% endif %}">
            <!-- La zone sera remplie dynamiquement par le JavaScript -->
        </div>
        
        {% if 'solver' in plugin.categories %}
        <div class="plugin-result mt-4 hidden" data-geocache-solver-target="pluginResult">
            <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                <div class="text-sm text-gray-300 whitespace-pre-wrap" data-geocache-solver-target="pluginResultText"></div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Script optimisé pour exécuter les plugins dans GoldenLayout
    (function() {
        // Permettre au DOM de se charger complètement
        setTimeout(function() {
            // Trouver tous les éléments racine de plugin dans la page
            const allPluginRoots = document.querySelectorAll('[data-controller="plugin-interface"]');
            if (!allPluginRoots || allPluginRoots.length === 0) return;
            
            // Identifier notre élément (le dernier ajouté au DOM)
            const rootElement = allPluginRoots[allPluginRoots.length - 1];
            
            // Récupérer le nom du plugin
            const pluginName = rootElement.dataset.pluginName || 
                               rootElement.querySelector('h1.text-2xl.font-bold.text-blue-400')?.textContent.trim() || 
                               'inconnu';
            
            // Identifiant unique pour le débogage
            const uniqueId = 'p-' + Date.now().toString().slice(-4) + '-' + Math.floor(Math.random() * 1000);
            rootElement.dataset.debugId = uniqueId;
            
            console.log(`Plugin [${pluginName}] chargé (${uniqueId})`);
            
            // Chercher le bouton d'exécution
            const executeButton = rootElement.querySelector('.debug-button');
            if (!executeButton) return;
            
            // Ajouter un gestionnaire d'événement directement
            executeButton.addEventListener('click', function(event) {
                event.preventDefault(); // Empêcher toute action par défaut
                
                // Tenter d'utiliser le contrôleur Stimulus si disponible
                if (window.StimulusApp && window.StimulusApp.controllers) {
                    const controller = window.StimulusApp.controllers.find(
                        c => c.context.identifier === 'plugin-interface' && c.element === rootElement
                    );
                    
                    if (controller) {
                        console.log(`Utilisation du contrôleur Stimulus pour [${pluginName}]`);
                        controller.execute(event);
                        return;
                    }
                }
                
                // Si pas de contrôleur Stimulus, utiliser l'appel API direct
                console.log(`Exécution directe pour [${pluginName}]`);
                
                // Préparer l'affichage
                const output = rootElement.querySelector('[data-plugin-interface-target="output"]');
                if (output) {
                    output.classList.remove('hidden');
                    output.innerHTML = '<div class="flex items-center justify-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div>';
                }
                
                // Récupérer les données du formulaire
                let data = {};
                const form = rootElement.querySelector('[data-plugin-interface-target="form"]');
                if (form) {
                    // Collecter tous les champs
                    const formData = new FormData(form);
                    for (let [key, value] of formData.entries()) {
                        data[key] = value;
                    }
                    
                    // Traitement spécial pour certains champs
                    const modeSelect = form.querySelector('#mode');
                    if (modeSelect) data.mode = modeSelect.value;
                    
                    const bruteForceCheckbox = form.querySelector('#brute_force');
                    if (bruteForceCheckbox) data.brute_force = bruteForceCheckbox.checked;
                    
                    const enableScoringCheckbox = form.querySelector('#enable_scoring');
                    if (enableScoringCheckbox) data.enable_scoring = enableScoringCheckbox.checked;
                } else {
                    // Si pas de formulaire, utiliser l'ID géocache
                    const geocacheId = rootElement.dataset.pluginInterfaceIdValue;
                    if (geocacheId && geocacheId !== 'default') {
                        data.geocache_id = geocacheId;
                    }
                }
                
                // Appel API
                fetch(`/api/plugins/${pluginName}/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) throw new Error('Erreur réseau');
                    
                    // Déterminer le type de contenu
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json().then(data => ({
                            isJson: true,
                            content: data
                        }));
                    } else {
                        return response.text().then(text => ({
                            isJson: false,
                            content: text
                        }));
                    }
                })
                .then(result => {
                    if (!output) return;
                    
                    // Traiter les résultats HTML (ancien format)
                    if (!result.isJson) {
                        output.innerHTML = result.content;
                        return;
                    }
                    
                    // Traiter les résultats JSON
                    const data = result.content;
                    let normalizedData = { ...data };
                    
                    // Vérifier la présence de coordonnées GPS dans les résultats
                    let coordinatesFound = false;
                    
                    // Pour le nouveau format standardisé
                    if (data.results && Array.isArray(data.results) && data.results.length > 0) {
                        // Chercher des coordonnées dans le meilleur résultat ou le premier résultat
                        const bestResult = data.summary && data.summary.best_result_id ?
                            data.results.find(r => r.id === data.summary.best_result_id) :
                            data.results[0];
                            
                            // Chercher les coordonnées à plusieurs emplacements possibles dans la structure
                            let coordinates = null;
                            
                            if (bestResult.coordinates && bestResult.coordinates.exist) {
                                coordinates = bestResult.coordinates;
                            } else if (bestResult.scoring && bestResult.scoring.coordinates && bestResult.scoring.coordinates.exist) {
                                coordinates = bestResult.scoring.coordinates;
                            }
                            
                            if (coordinates) {
                                // Émettre un événement avec les coordonnées détectées
                                console.log('Coordonnées GPS trouvées:', coordinates);
                                
                                // Utiliser la nouvelle fonction pour émettre l'événement
                                window.emitCoordinatesDetectedEvent(coordinates);
                                coordinatesFound = true;
                            }
                    } 
                    // Pour l'ancien format
                    else if (data.coordinates && data.coordinates.exist) {
                        // Émettre un événement avec les coordonnées détectées
                        console.log('Coordonnées GPS trouvées (ancien format):', data.coordinates);
                        
                        // Utiliser la nouvelle fonction pour émettre l'événement
                        window.emitCoordinatesDetectedEvent(data.coordinates);
                        coordinatesFound = true;
                        
                        // Rendre visible la section des coordonnées
                        const coordSection = rootElement.querySelector('[data-plugin-interface-target="coordinatesSection"]');
                        if (coordSection) coordSection.classList.remove('hidden');
                    }
                    // Vérifier également dans data.scoring
                    else if (data.scoring && data.scoring.coordinates && data.scoring.coordinates.exist) {
                        console.log('Coordonnées GPS trouvées (format scoring):', data.scoring.coordinates);
                        
                        // Utiliser la nouvelle fonction pour émettre l'événement
                        window.emitCoordinatesDetectedEvent(data.scoring.coordinates);
                        coordinatesFound = true;
                        
                        // Rendre visible la section des coordonnées
                        const coordSection = rootElement.querySelector('[data-plugin-interface-target="coordinatesSection"]');
                        if (coordSection) coordSection.classList.remove('hidden');
                    }
                    
                    // Si aucune coordonnée n'est trouvée, émettre un événement avec exist=false
                    if (!coordinatesFound) {
                        const event = new CustomEvent('coordinatesDetected', {
                            detail: { exist: false },
                            bubbles: true
                        });
                        document.dispatchEvent(event);
                    }

                    // Gérer le nouveau format standardisé
                    if (data.results && Array.isArray(data.results)) {
                        // Nouveau format
                        let resultsHtml = '';
                        
                        // Afficher d'abord le résumé s'il existe
                        if (data.summary) {
                            resultsHtml += `
                            <div class="bg-gray-700 rounded-lg p-4 mb-4">
                                <h3 class="text-lg font-medium text-blue-400 mb-2">Résumé</h3>
                                <div class="bg-gray-800 p-4 rounded">
                                    <p class="text-gray-300">${data.summary.message || `${data.summary.total_results} résultat(s)`}</p>
                                    ${data.status === 'error' ? `<p class="text-red-400 mt-2">Erreur: ${data.summary.message || 'Une erreur est survenue'}</p>` : ''}
                                    ${data.plugin_info ? `<p class="text-gray-400 text-sm mt-2">Temps d'exécution: ${data.plugin_info.execution_time || 0} ms</p>` : ''}
                                </div>
                            </div>`;
                        }
                        
                        // AJOUT: Vérification des coordonnées au niveau des résultats
                        console.log("Vérification des coordonnées dans les résultats:", data.results);
                        
                        // Afficher chaque résultat
                        data.results.forEach((result, index) => {
                            const isBest = data.summary && data.summary.best_result_id === result.id;
                            
                            // AJOUT: Vérification des coordonnées dans ce résultat spécifique
                            console.log(`Vérification des coordonnées dans le résultat ${index}:`, result);
                            if (result.scoring && result.scoring.coordinates) {
                                console.log(`Coordonnées trouvées dans result.scoring.coordinates:`, result.scoring.coordinates);
                                
                                // Émettre un événement pour ces coordonnées
                                if (result.scoring.coordinates.exist) {
                                    console.log("Émission de l'événement coordinatesDetected pour les coordonnées dans result.scoring.coordinates");
                                    // Utiliser la nouvelle fonction pour émettre l'événement
                                    window.emitCoordinatesDetectedEvent(result.scoring.coordinates);
                                }
                            }
                            if (result.coordinates) {
                                console.log(`Coordonnées trouvées dans result.coordinates:`, result.coordinates);
                                
                                // Émettre un événement pour ces coordonnées
                                if (result.coordinates.exist) {
                                    console.log("Émission de l'événement coordinatesDetected pour les coordonnées dans result.coordinates");
                                    // Utiliser la nouvelle fonction pour émettre l'événement
                                    window.emitCoordinatesDetectedEvent(result.coordinates);
                                }
                            }
                            
                            resultsHtml += `
                            <div class="bg-gray-700 rounded-lg p-4 mb-4 ${isBest ? 'border-2 border-blue-500' : ''}">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="text-lg font-medium ${isBest ? 'text-blue-400' : 'text-gray-300'}">
                                        Résultat ${index + 1} ${isBest ? '(Meilleur résultat)' : ''}
                                    </h3>
                                    <div class="bg-gray-900 px-2 py-1 rounded text-sm">
                                        Confiance: <span class="font-bold ${getConfidenceColor(result.confidence)}">${Math.round(result.confidence * 100)}%</span>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-800 p-4 rounded mb-3">
                                    <textarea class="result-output w-full bg-gray-800 text-gray-300 border border-gray-700 focus:border-blue-500 p-2 rounded resize-y"
                                    data-index="${index}" data-result-id="${result.id}">${result.text_output || ''}</textarea>
                                </div>`;
                                
                            // Afficher les paramètres utilisés si présents
                            if (result.parameters && Object.keys(result.parameters).length > 0) {
                                resultsHtml += `
                                <div class="mt-2 p-2 bg-gray-800 rounded">
                                    <h4 class="text-sm font-medium text-gray-400 mb-1">Paramètres utilisés:</h4>
                                    <div class="text-xs text-gray-300 grid grid-cols-2 gap-1">
                                        ${Object.entries(result.parameters).map(([key, value]) => 
                                            `<div><span class="text-gray-500">${key}:</span> ${value}</div>`
                                        ).join('')}
                                    </div>
                                </div>`;
                            }
                            
                            // Récupérer les coordonnées à partir des différentes positions possibles
                            let coordinates = null;
                            
                            if (result.coordinates && result.coordinates.exist) {
                                coordinates = result.coordinates;
                            } else if (result.scoring && result.scoring.coordinates && result.scoring.coordinates.exist) {
                                coordinates = result.scoring.coordinates;
                            }
                            
                            if (coordinates) {
                                resultsHtml += `
                                <div class="mt-3 p-3 bg-gray-800 rounded">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-sm font-medium text-blue-400">Coordonnées GPS détectées</h4>
                                        <span class="px-3 py-1 text-xs rounded-full bg-green-600">Coordonnées trouvées</span>
                                    </div>
                                    <div class="grid grid-cols-1 gap-2">
                                        <div class="flex items-center">
                                            <span class="text-gray-400 text-sm w-20">Format DDM:</span>
                                            <span class="text-white font-medium">${coordinates.ddm || 'N/A'}</span>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="flex items-center">
                                                <span class="text-gray-400 text-sm w-20">Latitude:</span>
                                                <span class="text-white">${coordinates.ddm_lat || 'N/A'}</span>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="text-gray-400 text-sm w-20">Longitude:</span>
                                                <span class="text-white">${coordinates.ddm_lon || 'N/A'}</span>
                                            </div>
                                        </div>
                                        <div class="mt-2 flex gap-2">
                                            <button type="button" 
                                                    class="text-xs bg-blue-700 hover:bg-blue-600 text-white px-3 py-1 rounded cursor-pointer copy-coords" 
                                                    data-coords="${coordinates.ddm || ''}">
                                                Copier
                                            </button>
                                            <button type="button" 
                                                    class="text-xs bg-purple-700 hover:bg-purple-600 text-white px-3 py-1 rounded cursor-pointer create-waypoint"
                                                    data-ddm="${coordinates.ddm || ''}" 
                                                    data-lat="${coordinates.ddm_lat || ''}" 
                                                    data-lon="${coordinates.ddm_lon || ''}">
                                                Créer waypoint
                                            </button>
                                        </div>
                                    </div>
                                </div>`;
                            }
                            
                            resultsHtml += `</div>`;
                        });
                        
                        // Ajouter l'option pour afficher le JSON brut
                        resultsHtml += `
                        <div class="mt-4">
                            <button class="text-sm text-blue-400 hover:text-blue-300" id="toggle-raw-${uniqueId}">
                                Afficher le format brut
                            </button>
                            <div class="raw-output hidden mt-2 bg-gray-700 rounded-lg p-4">
                                <textarea class="w-full h-40 bg-gray-800 text-gray-300 border border-gray-700 focus:border-blue-500 p-2 rounded resize-y">${JSON.stringify(data, null, 2)}</textarea>
                            </div>
                        </div>`;
                        
                        // Bouton de débogage pour forcer l'émission de l'événement coordinatesDetected
                        resultsHtml += `
                        <div class="mt-4">
                            <button class="text-sm bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded force-coords-btn" 
                                    data-id="${uniqueId}">
                                Forcer l'émission des coordonnées
                            </button>
                        </div>`;
                        
                        // Mettre à jour le DOM avec le HTML généré
                        output.innerHTML = resultsHtml;
                        
                        // Configurer les boutons de coordination
                        setupCoordinateButtons();
                        
                        // Ajouter l'événement pour afficher/masquer le format brut
                        const toggleButton = output.querySelector(`#toggle-raw-${uniqueId}`);
                        const rawOutput = output.querySelector('.raw-output');
                        
                        if (toggleButton && rawOutput) {
                            toggleButton.addEventListener('click', function() {
                                rawOutput.classList.toggle('hidden');
                                toggleButton.textContent = rawOutput.classList.contains('hidden') 
                                    ? 'Afficher le format brut'
                                    : 'Masquer le format brut';
                            });
                        }
                        
                        // Ajouter l'événement pour le bouton de débogage des coordonnées
                        const forceCoordinatesButton = output.querySelector(`.force-coords-btn[data-id="${uniqueId}"]`);
                        if (forceCoordinatesButton) {
                            forceCoordinatesButton.addEventListener('click', function() {
                                console.log("Bouton de débogage cliqué, émission forcée des coordonnées");
                                
                                // Coordonnées extraites du log
                                const coordinates = {
                                    exist: true,
                                    ddm_lat: "N 49° 12.123'",
                                    ddm_lon: "E 006° 12.123'",
                                    ddm: "N 49° 12.123' E 006° 12.123'",
                                    decimal: {
                                        latitude: 49.20205,
                                        longitude: 6.20205
                                    },
                                    patterns: ["N 49° 12.123' E 006° 12.123'"]
                                };
                                
                                // Utiliser la fonction globale pour émettre l'événement
                                if (window.emitCoordinatesDetectedEvent) {
                                    window.emitCoordinatesDetectedEvent(coordinates);
                                    alert("Événement coordinatesDetected émis avec succès");
                                } else {
                                    console.error("La fonction emitCoordinatesDetectedEvent n'est pas disponible");
                                    alert("Erreur: La fonction d'émission n'est pas disponible");
                                }
                            });
                        }
                    }
                    // Gérer l'ancien format pour rétrocompatibilité
                    else {
                        // Normaliser la structure
                        if (data.result && data.result.text && data.result.text.text_output !== undefined) {
                            normalizedData.text_output = data.result.text.text_output;
                        } else if (data.output !== undefined) {
                            normalizedData.text_output = data.output;
                        }
                        
                        // Extraire le log
                        if (data.result && data.result.log !== undefined) {
                            normalizedData.log = data.result.log;
                        } else if (data.original_result && data.original_result.result && data.original_result.result.log) {
                            normalizedData.log = data.original_result.result.log;
                        }
                        
                        // Afficher les résultats (ancien format)
                        output.innerHTML = `
                            <div class="space-y-4">
                                <div class="bg-gray-700 rounded-lg p-4">
                                    <h3 class="text-lg font-medium text-gray-300 mb-2">Résultat</h3>
                                    <div class="bg-gray-800 p-4 rounded">
                                        <textarea class="w-full bg-gray-800 text-gray-300 border border-gray-700 focus:border-blue-500 p-2 rounded resize-y">${normalizedData.text_output || ''}</textarea>
                                    </div>
                                </div>
                                ${normalizedData.log ? `
                                <div class="bg-gray-700 rounded-lg p-4">
                                    <h3 class="text-lg font-medium text-gray-300 mb-2">Détails de la projection</h3>
                                    <div class="bg-gray-800 p-4 rounded">
                                        <pre class="w-full bg-gray-800 text-gray-300 font-mono text-sm whitespace-pre-wrap">${normalizedData.log}</pre>
                                    </div>
                                </div>
                                ` : ''}
                                
                                <!-- Affichage des coordonnées GPS si elles existent -->
                                ${normalizedData.coordinates ? `
                                <div class="bg-gray-700 rounded-lg p-4">
                                    <h3 class="text-lg font-medium text-gray-300 mb-2">Coordonnées détectées</h3>
                                    
                                    <div class="mb-3">
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="coords-exist-checkbox form-checkbox h-5 w-5 text-blue-600" 
                                                   ${normalizedData.coordinates.exist === true ? 'checked' : ''}
                                                   id="coords-exist-${uniqueId}">
                                            <span class="ml-2 text-gray-300">Coordonnées présentes</span>
                                        </label>
                                    </div>
                                    
                                    <div class="bg-gray-800 p-4 rounded grid grid-cols-1 gap-4 ${normalizedData.coordinates.exist === true ? '' : 'opacity-50'} coords-container-${uniqueId}">
                                        <div>
                                            <label for="coords-ddm-${uniqueId}" class="block text-sm font-medium text-gray-400 mb-1">Format DDM:</label>
                                            <input type="text" id="coords-ddm-${uniqueId}" class="w-full bg-gray-800 text-gray-300 border border-gray-700 focus:border-blue-500 p-2 rounded"
                                                   value="${normalizedData.coordinates.ddm || ''}" ${normalizedData.coordinates.exist === true ? '' : 'disabled'}>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label for="coords-lat-${uniqueId}" class="block text-sm font-medium text-gray-400 mb-1">Latitude:</label>
                                                <input type="text" id="coords-lat-${uniqueId}" class="w-full bg-gray-800 text-gray-300 border border-gray-700 focus:border-blue-500 p-2 rounded"
                                                       value="${normalizedData.coordinates.ddm_lat || ''}" ${normalizedData.coordinates.exist === true ? '' : 'disabled'}>
                                            </div>
                                            <div>
                                                <label for="coords-lon-${uniqueId}" class="block text-sm font-medium text-gray-400 mb-1">Longitude:</label>
                                                <input type="text" id="coords-lon-${uniqueId}" class="w-full bg-gray-800 text-gray-300 border border-gray-700 focus:border-blue-500 p-2 rounded"
                                                       value="${normalizedData.coordinates.ddm_lon || ''}" ${normalizedData.coordinates.exist === true ? '' : 'disabled'}>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                <!-- Bouton de débogage pour forcer l'émission de l'événement coordinatesDetected -->
                                <div class="mt-4">
                                    <button class="text-sm bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded force-coords-btn" 
                                            data-id="${uniqueId}">
                                        Forcer l'émission des coordonnées
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // Configurer les boutons de coordination après l'affichage des résultats
                        setupCoordinateButtons();
                        
                        // Ajouter les événements pour la gestion des coordonnées
                        const coordsExistCheckbox = output.querySelector(`#coords-exist-${uniqueId}`);
                        const coordsContainer = output.querySelector(`.coords-container-${uniqueId}`);
                        
                        if (coordsExistCheckbox && coordsContainer) {
                            coordsExistCheckbox.addEventListener('change', function() {
                                const exists = this.checked;
                                coordsContainer.classList.toggle('opacity-50', !exists);
                                
                                // Activer/désactiver les champs de saisie
                                const inputs = coordsContainer.querySelectorAll('input[type="text"]');
                                inputs.forEach(input => {
                                    input.disabled = !exists;
                                });
                                
                                // Mettre à jour la valeur dans les données normalisées
                                if (normalizedData.coordinates) {
                                    normalizedData.coordinates.exist = exists;
                                    
                                    // Mettre à jour le textarea du format brut si visible
                                    const rawTextarea = output.querySelector('.raw-output textarea');
                                    if (rawTextarea && !output.querySelector('.raw-output').classList.contains('hidden')) {
                                        rawTextarea.value = JSON.stringify(normalizedData, null, 2);
                                    }
                                }
                            });
                        }
                    }
                })
                .catch(error => {
                    if (output) {
                        output.innerHTML = `<div class="bg-red-900 text-red-100 p-4 rounded-lg">Erreur: ${error.message}</div>`;
                    }
                });
            });
        }, 100);
    })();
    
    // Fonction utilitaire pour obtenir la couleur selon le niveau de confiance
    function getConfidenceColor(confidence) {
        if (confidence >= 0.8) return 'text-green-400';
        if (confidence >= 0.5) return 'text-yellow-400';
        if (confidence >= 0.3) return 'text-orange-400';
        return 'text-red-400';
    }
    
    // Gestion des événements pour les boutons de coordonnées après le chargement des résultats
    function setupCoordinateButtons() {
        // Gestion des boutons de copie de coordonnées
        document.querySelectorAll('.copy-coords').forEach(button => {
            if (button.dataset.eventSetup) return; // Éviter la duplication des événements
            
            button.dataset.eventSetup = "true";
            button.addEventListener('click', function() {
                const coords = this.dataset.coords;
                if (coords) {
                    navigator.clipboard.writeText(coords).then(() => {
                        // Feedback visuel temporaire
                        const originalText = this.textContent;
                        this.innerHTML = '✓ Copié!';
                        this.classList.add('bg-green-600');
                        this.classList.remove('bg-blue-700', 'hover:bg-blue-600');
                        
                        setTimeout(() => {
                            this.textContent = originalText;
                            this.classList.remove('bg-green-600');
                            this.classList.add('bg-blue-700', 'hover:bg-blue-600');
                        }, 1500);
                    });
                }
            });
        });
        
        // Gestion des boutons de création de waypoint
        document.querySelectorAll('.create-waypoint').forEach(button => {
            if (button.dataset.eventSetup) return; // Éviter la duplication des événements
            
            button.dataset.eventSetup = "true";
            button.addEventListener('click', function() {
                const coords = {
                    ddm: this.dataset.ddm,
                    ddm_lat: this.dataset.lat,
                    ddm_lon: this.dataset.lon
                };
                
                // Déclencher un événement personnalisé pour la création du waypoint
                const event = new CustomEvent('createWaypointFromCoordinates', {
                    detail: coords,
                    bubbles: true
                });
                this.dispatchEvent(event);
                
                // Feedback visuel temporaire
                const originalText = this.textContent;
                this.innerHTML = '✓ Demandé!';
                this.classList.add('bg-green-600');
                this.classList.remove('bg-purple-700', 'hover:bg-purple-600');
                
                setTimeout(() => {
                    this.textContent = originalText;
                    this.classList.remove('bg-green-600');
                    this.classList.add('bg-purple-700', 'hover:bg-purple-600');
                }, 1500);
                
                // Montrer une notification
                showNotification('Création de waypoint demandée', 'bg-blue-600');
            });
        });
    }
    
    // Fonction pour afficher une notification temporaire
    function showNotification(message, bgClass = 'bg-blue-600') {
        // Créer l'élément de notification s'il n'existe pas déjà
        let notif = document.querySelector('.coordinates-notification');
        if (!notif) {
            notif = document.createElement('div');
            notif.className = `coordinates-notification fixed bottom-5 right-5 p-3 rounded-lg text-white shadow-lg transition-opacity duration-300 ${bgClass}`;
            document.body.appendChild(notif);
        }
        
        // Définir le contenu et afficher
        notif.textContent = message;
        notif.style.opacity = '1';
        
        // Cacher après 3 secondes
        setTimeout(() => {
            notif.style.opacity = '0';
            setTimeout(() => {
                if (notif.parentNode) {
                    notif.parentNode.removeChild(notif);
                }
            }, 300);
        }, 3000);
    }
</script>

<!-- Inclure le contrôleur des coordonnées -->
<script>
// Configuration directe du contrôleur des coordonnées sans tenter de charger un fichier externe
(function setupCoordinatesController() {
    console.log("Configuration du contrôleur des coordonnées directement intégré");
    
    // Configuration des gestionnaires d'événements pour les coordonnées
    document.addEventListener('coordinatesDetected', function(event) {
        const coordinates = event.detail;
        if (!coordinates || !coordinates.exist) return;
        
        console.log('Traitement des coordonnées détectées:', coordinates);
    });
    
    // AJOUT: Fonction pour émettre l'événement de coordonnées
    window.emitCoordinatesDetectedEvent = function(coordinates) {
        if (!coordinates || !coordinates.exist) return;
        
        console.log("Émission forcée de l'événement coordinatesDetected:", coordinates);
        
        // Créer et dispatcher l'événement
        const event = new CustomEvent('coordinatesDetected', {
            detail: coordinates,
            bubbles: true,
            composed: true,
            cancelable: true
        });
        
        // Émettre sur le document
        document.dispatchEvent(event);
        
        // Émettre également sur window pour une meilleure propagation
        window.dispatchEvent(event);
        
        // Émettre sur le body également
        document.body.dispatchEvent(event);
        
        return true;
    };
    
    // Le reste est géré directement par les fonctions setupCoordinateButtons
    // qui sont appelées après avoir ajouté les résultats au DOM
})();
</script>
