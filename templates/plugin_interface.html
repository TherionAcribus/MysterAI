<!-- Template pour l'interface d'un plugin -->
<div class="w-full h-full bg-gray-900 p-6" 
     data-controller="plugin-interface"
     hx-ext="json-enc">
    <div class="max-w-4xl mx-auto">
        <!-- En-tête du plugin -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-blue-400">{{ plugin.name }}</h1>
                    <p class="text-gray-400">Version {{ plugin.version }}</p>
                </div>
                <div class="text-gray-400">
                    <p>Auteur: {{ plugin.author }}</p>
                </div>
            </div>
            
            <div class="mb-6">
                <p class="text-gray-400">{{ plugin.description }}</p>
            </div>

            <div class="flex flex-wrap gap-2">
                {% for category in plugin.categories %}
                    <span class="px-3 py-1 bg-gray-700 rounded-full text-sm text-gray-300">{{ category }}</span>
                {% endfor %}
            </div>
        </div>

        <!-- Formulaire des inputs -->
        {% if not plugin.params.get('geocacheId') %}
        <form class="bg-gray-800 rounded-lg p-6 mb-6"
              id="plugin-form">
            
            {% for input_name, input_config in plugin.input_types.items() %}
                <div class="mb-4">
                    <label for="{{ input_name }}" class="block text-sm font-medium text-gray-300 mb-2">
                        {{ input_config.label }}
                    </label>

                    {% if input_config.type == "string" %}
                        <input type="text" 
                               id="{{ input_name }}"
                               name="{{ input_name }}"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="{{ input_config.placeholder|default('') }}"
                               value="{{ plugin.params.get(input_name, input_config.default|default('')) }}">
                    {% endif %}
                </div>
            {% endfor %}

            <div class="mt-6 flex justify-end space-x-4">
                <button type="button" 
                        onclick="executePlugin('decode')"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Décoder
                </button>
            </div>
        </form>
        {% else %}
        <form id="plugin-form" class="hidden">
            <input type="hidden" name="geocache_id" value="{{ plugin.params.get('geocacheId') }}">
        </form>
        {% endif %}

        <!-- Zone de résultat -->
        <div id="plugin-output" class="bg-gray-800 rounded-lg p-6">
            <div class="text-gray-400">Analyse en cours...</div>
        </div>
    </div>
</div>

<script>
    function executePlugin(mode = 'decode') {
        const form = document.getElementById('plugin-form');
        const formData = new FormData(form);
        const data = {};
        
        // Convertir FormData en objet
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }
        
        // Ajouter le mode
        data.mode = mode;
        
        // Montrer le chargement
        const output = document.getElementById('plugin-output');
        output.innerHTML = '<div class="flex items-center justify-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div>';
        
        // Exécuter le plugin
        fetch(`/api/plugins/{{ plugin.name }}/execute`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(html => {
            output.innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            output.innerHTML = `<div class="bg-red-900 text-red-100 p-4 rounded-lg">Erreur: ${error.message}</div>`;
        });
    }

    // Si on a un ID de géocache, exécuter automatiquement
    {% if plugin.params.get('geocacheId') %}
        executePlugin();
    {% endif %}
</script>
