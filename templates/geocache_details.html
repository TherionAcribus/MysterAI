<!-- Script pour intercepter le clic droit, inject√© au tout d√©but de la page -->
<script>
    // Cr√©er l'√©couteur d'√©v√©nement personnalis√© imm√©diatement
    if (!window.__actionButtonContextMenuInitialized) {
        window.__actionButtonContextMenuInitialized = true;
        
        // √âcouteur global pour notre √©v√©nement personnalis√©
        document.addEventListener('actionButtonContextMenu', function(event) {
            console.log('=== DEBUG: √âv√©nement personnalis√© actionButtonContextMenu re√ßu ===', event.detail);
            
            if (event.detail && event.detail.button) {
                // Afficher notre menu contextuel
                showActionButtonContextMenu(event.detail.x, event.detail.y, event.detail.button);
            }
        });
        
                // Fonction pour afficher le menu contextuel des boutons d'action
        window.showActionButtonContextMenu = function(clientX, clientY, button) {
            // Supprimer tout menu contextuel existant
            const existingMenu = document.querySelector('.action-button-context-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // R√©cup√©rer les informations du bouton
            const actionType = button.dataset.actionType;
            const geocacheId = button.dataset.geocacheId;
            const gcCode = button.dataset.gcCode;
            
            console.log('=== SHOW MENU: Affichage du menu pour ===', actionType);
            
            // V√©rifier la pr√©f√©rence utilisateur pour l'affichage des onglets
            let defaultBehavior = true; // Par d√©faut, ouvrir dans le m√™me onglet
            if (window.PluginGoldenLayoutIntegration && 
                typeof window.PluginGoldenLayoutIntegration.shouldOpenInSameSection === 'function') {
                // R√©cup√©rer le param√®tre configur√© par l'utilisateur
                defaultBehavior = window.PluginGoldenLayoutIntegration.shouldOpenInSameSection();
            }
            
            // Cr√©er le menu contextuel avec style Tailwind
            const menu = document.createElement('div');
            menu.className = 'action-button-context-menu fixed z-50 bg-gray-800 rounded-lg shadow-lg border border-gray-700 py-1 min-w-[200px]';
            menu.style.left = `${clientX}px`;
            menu.style.top = `${clientY}px`;
            
            // En-t√™te du menu
            const header = document.createElement('div');
            header.className = 'px-4 py-2 text-gray-400 text-sm border-b border-gray-700';
            header.textContent = `Action: ${getActionName(actionType)}`;
            menu.appendChild(header);
            
            // Option d'ouverture dans l'onglet actuel
            const sameTabOption = document.createElement('div');
            sameTabOption.className = 'px-4 py-2 text-white hover:bg-gray-700 cursor-pointer flex items-center';
            sameTabOption.innerHTML = '<i class="fas fa-exchange-alt mr-2"></i>Ouvrir dans l\'onglet actuel';
            
            // Ajouter une indication si c'est le comportement par d√©faut
            if (defaultBehavior) {
                sameTabOption.innerHTML += ' <span class="ml-2 text-xs bg-blue-600 px-1 rounded">D√©faut</span>';
            }
            
            sameTabOption.onclick = () => {
                executeButtonAction(button, 'same');
                menu.remove();
            };
            menu.appendChild(sameTabOption);
            
            // Option d'ouverture dans un nouvel onglet
            const newTabOption = document.createElement('div');
            newTabOption.className = 'px-4 py-2 text-white hover:bg-gray-700 cursor-pointer flex items-center';
            newTabOption.innerHTML = '<i class="fas fa-external-link-alt mr-2"></i>Ouvrir dans un nouvel onglet';
            
            // Ajouter une indication si c'est le comportement par d√©faut
            if (!defaultBehavior) {
                newTabOption.innerHTML += ' <span class="ml-2 text-xs bg-blue-600 px-1 rounded">D√©faut</span>';
            }
            
            newTabOption.onclick = () => {
                executeButtonAction(button, 'new');
                menu.remove();
            };
            menu.appendChild(newTabOption);
            
            // Ajouter le menu au document
            document.body.appendChild(menu);
            
            // Ajuster la position si le menu d√©passe les limites de la fen√™tre
            const menuRect = menu.getBoundingClientRect();
            if (menuRect.right > window.innerWidth) {
                menu.style.left = `${clientX - menuRect.width}px`;
            }
            if (menuRect.bottom > window.innerHeight) {
                menu.style.top = `${clientY - menuRect.height}px`;
            }
            
            // Fermer le menu contextuel sur un clic ailleurs
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            
            // Petit d√©lai pour √©viter la fermeture imm√©diate
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 50);
        };
        
        // Helper pour obtenir le nom lisible de l'action
        window.getActionName = function(actionType) {
            switch (actionType) {
                case 'analyze': return 'Analyser';
                case 'solver': return 'Solver';
                case 'formula-solver': return 'Formula Solver';
                default: return actionType;
            }
        };
    }

    // Fonction imm√©diatement ex√©cut√©e pour intercepter les clics droits le plus t√¥t possible
    (function() {
        // Notre version originale du gestionnaire contextmenu 
        const originalContextMenu = function(event) {
            // V√©rifier si c'est un de nos boutons d'action
            let target = event.target;
            while (target && target !== document) {
                if (target.classList && target.classList.contains('geocache-action-button')) {
                    // C'est un de nos boutons, pr√©venir le comportement par d√©faut
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // Stocker les donn√©es pour traitement ult√©rieur
                    window.__contextMenuData = {
                        x: event.clientX,
                        y: event.clientY,
                        button: target
                    };
                    
                    console.log('=== INTERCEPT: Clic droit sur bouton d\'action captur√© ===', target.dataset.actionType);
                    
                    // Cr√©er un √©v√©nement personnalis√© pour que notre code principal puisse g√©rer cela plus tard
                    // Appeler directement la fonction plut√¥t que d'utiliser un √©v√©nement
                    if (typeof window.showActionButtonContextMenu === 'function') {
                        window.showActionButtonContextMenu(event.clientX, event.clientY, target);
                    } else {
                        // Fallback si la fonction n'est pas encore d√©finie
                        setTimeout(function() {
                            const customEvent = new CustomEvent('actionButtonContextMenu', {
                                detail: window.__contextMenuData
                            });
                            document.dispatchEvent(customEvent);
                        }, 0);
                    }
                    
                    return false;
                }
                target = target.parentElement;
            }
        };
        
        // Ajouter notre gestionnaire le plus t√¥t possible
        document.addEventListener('contextmenu', originalContextMenu, true);
        console.log('=== INTERCEPT: Gestionnaire de clic droit inject√© avec succ√®s ===');
    })();
    
        // Script pour visualiser l'onglet actif (aide au d√©bogage)
    (function() {
        let lastLoggedMessage = '';
        let messageRepeatCount = 0;
        
        // Fonction pour mettre √† jour l'indicateur d'onglet actif
        function updateActiveTabIndicator() {
            // Supprimer d'abord tous les indicateurs existants
            document.querySelectorAll('.active-tab-indicator').forEach(el => el.remove());
            
            // Si aucun onglet actif n'est d√©fini, sortir sans erreur
            if (!window.lastActiveTab) {
                return;
            }
            
            try {
                // V√©rifier si l'objet a la structure attendue
                if (typeof window.lastActiveTab !== 'object' || !window.lastActiveTab) {
                    return;
                }
                
                // V√©rification plus robuste de la structure des objets
                // Le chemin vers l'√©l√©ment peut varier selon le type d'√©l√©ment GoldenLayout
                let tabElement = null;
                
                // Essayer diff√©rentes structures pour trouver l'√©l√©ment de l'onglet
                if (window.lastActiveTab.tab && window.lastActiveTab.tab.element) {
                    // Structure normale pour les components
                    tabElement = window.lastActiveTab.tab.element;
                } else if (window.lastActiveTab.header && window.lastActiveTab.header.tabs) {
                    // Pour les stacks, prendre le premier tab de header
                    const activeTab = window.lastActiveTab.header.tabs.find(tab => tab.isActive);
                    if (activeTab && activeTab.element) {
                        tabElement = activeTab.element;
                    }
                } else if (window.lastActiveTab.element) {
                    // Acc√®s direct √† l'√©l√©ment si disponible
                    tabElement = window.lastActiveTab.element;
                }
                
                // Si nous avons trouv√© un √©l√©ment, ajouter l'indicateur
                if (tabElement && tabElement instanceof Element) {
                    // V√©rifier que tabElement est bien un √©l√©ment DOM
                    try {
                        // S'assurer que l'√©l√©ment a une position relative
                        if (window.getComputedStyle(tabElement).position !== 'relative') {
                            tabElement.style.position = 'relative';
                        }
                        
                        // Ajouter un badge visible
                        const indicator = document.createElement('div');
                        indicator.className = 'active-tab-indicator bg-green-500 text-xs px-1 absolute top-0 right-0 rounded-bl';
                        indicator.textContent = 'Actif';
                        indicator.style.zIndex = '9999';
                        tabElement.appendChild(indicator);
                        
                        // R√©initialiser le compteur de messages r√©p√©t√©s
                        messageRepeatCount = 0;
                        lastLoggedMessage = '';
                        
                        // Ajout d'un log informatif
                        console.log('=== DEBUG: Indicateur ajout√© √† l\'onglet actif ===', 
                            window.lastActiveTab.config?.title || 'Onglet sans titre');
                    } catch (styleError) {
                        // Ne pas g√©n√©rer trop de messages d'erreur similaires
                        const errorMsg = '√âl√©ment non valide pour le DOM';
                        if (lastLoggedMessage === errorMsg) {
                            messageRepeatCount++;
                            if (messageRepeatCount > 5) {
                                return; // Ne pas continuer √† g√©n√©rer des logs
                            }
                        } else {
                            lastLoggedMessage = errorMsg;
                            messageRepeatCount = 0;
                        }
                        console.warn('=== AVERTISSEMENT: ' + errorMsg + ' ===');
                    }
                } else {
                    // Limiter les messages d'erreur r√©p√©titifs
                    const errorMsg = '√âl√©ment de l\'onglet actif non trouv√©';
                    if (lastLoggedMessage === errorMsg) {
                        messageRepeatCount++;
                        if (messageRepeatCount > 2) {
                            return; // Ne pas continuer √† g√©n√©rer des logs
                        }
                    } else {
                        lastLoggedMessage = errorMsg;
                        messageRepeatCount = 0;
                    }
                    console.warn('=== AVERTISSEMENT: ' + errorMsg + ' ===');
                }
            } catch (e) {
                console.error('Erreur lors de l\'ajout de l\'indicateur:', e);
            }
        }
        
        // Mettre √† jour l'indicateur p√©riodiquement, mais moins fr√©quemment
        setInterval(updateActiveTabIndicator, 3000);
        
        // √âcouter aussi les changements de layout
        if (window.mainLayout) {
            window.mainLayout.on('activeContentItemChanged', function() {
                setTimeout(updateActiveTabIndicator, 100);
            });
        }
    })();
</script>

<div class="w-full h-full bg-gray-900 overflow-auto p-4" 
     hx-ext="include-vals" 
     hx-headers='{"X-Layout-Component": "true"}'
     x-init="console.log('Component initialized with geocache ID:', '{{ geocache.id }}')"
     data-action="coordinatesFormLoaded@window->geocache-coordinates#formLoaded coordinatesUpdated@window->geocache-coordinates#coordinatesUpdated">
    <div class="max-w-4xl mx-auto">
        <!-- En-t√™te -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-100 mb-2">{{ geocache.name }}</h1>
            <div class="flex items-center text-gray-400 space-x-4">
                <span>{{ geocache.gc_code }}</span>
                <span>‚Ä¢</span>
                <span>{{ geocache.cache_type }}</span>
                <span>‚Ä¢</span>
                <span>Par {{ geocache.owner.name if geocache.owner else "Inconnu" }}</span>
            </div>
        </div>

        <!-- Informations principales -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Statistiques -->
            <div class="bg-gray-800 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-gray-100 mb-4">Statistiques</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span class="text-gray-400">Difficult√©</span>
                        <div class="text-yellow-400">
                            {% for _ in range(geocache.difficulty|int) %}‚òÖ{% endfor %}
                            {% for _ in range(5 - geocache.difficulty|int) %}‚òÜ{% endfor %}
                        </div>
                    </div>
                    <div>
                        <span class="text-gray-400">Terrain</span>
                        <div class="text-green-400">
                            {% for _ in range(geocache.terrain|int) %}‚òÖ{% endfor %}
                            {% for _ in range(5 - geocache.terrain|int) %}‚òÜ{% endfor %}
                        </div>
                    </div>
                    <div>
                        <span class="text-gray-400">Taille</span>
                        <div class="text-blue-400">{{ geocache.size }}</div>
                    </div>
                    <div>
                        <span class="text-gray-400">Favoris</span>
                        <div class="text-purple-400">{{ geocache.favorites_count }}</div>
                    </div>
                </div>
                
                <!-- Attributs de la g√©ocache, maintenant hors de la grille pour utiliser toute la largeur -->
                {% if geocache.attributes %}
                <div class="mt-4">
                    <span class="text-gray-400 block mb-2">Attributs</span>
                    <div class="flex flex-wrap gap-2">
                        {% for attribute in geocache.attributes %}
                        <div class="inline-block" title="{{ attribute.name }}">
                            <img src="{{ attribute.icon_full_url }}" alt="{{ attribute.name }}" 
                                 class="w-8 h-8 rounded bg-gray-700 p-1" 
                                 onerror="this.onerror=null; this.src='/static/images/attributes/{{ attribute.icon_url }}';">
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Coordonn√©es -->
            <div class="bg-gray-800 rounded-lg p-4" id="geocache-coordinates">
                <h2 class="text-lg font-semibold text-gray-100 mb-4">Coordonn√©es</h2>
                <div data-controller="geocache-coordinates" 
                     data-geocache-coordinates-geocache-id-value="{{ geocache.id }}">
                    <div id="geocache-coordinates-container" 
                         data-geocache-coordinates-target="container">
                        {% include 'partials/coordinates_display.html' %}
                    </div>
                    
                    <!-- Statut de r√©solution -->
                    <div class="mt-4 mb-4">
                        <span class="text-gray-400">Statut</span>
                        
                        <!-- Information sur l'√©tat "trouv√©" -->
                        {% if geocache.found %}
                        <div class="mt-1 mb-2 py-2 px-3 bg-green-700/30 rounded flex items-center">
                            <span class="text-green-400 text-xl mr-2">üòä</span>
                            <div>
                                <span class="text-green-300 font-medium">Cache trouv√©e</span>
                                {% if geocache.found_date %}
                                <span class="text-green-200 text-sm block">
                                    Le {{ geocache.found_date.strftime('%d/%m/%Y') }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <select class="mt-1 bg-gray-700 text-white rounded px-2 py-1 w-full"
                                data-action="change->geocache-coordinates#updateSolvedStatus"
                                name="solved_status"
                                data-previous-value="{{ geocache.solved }}">
                            <option value="not_solved" {% if geocache.solved == 'not_solved' %}selected{% endif %}>
                                Non r√©solu
                            </option>
                            <option value="in_progress" {% if geocache.solved == 'in_progress' %}selected{% endif %}>
                                En cours
                            </option>
                            <option value="solved" {% if geocache.solved == 'solved' %}selected{% endif %}>
                                R√©solu
                            </option>
                        </select>
                    </div>
                    
                    <!-- Boutons d'action pour les coordonn√©es -->
                    <div class="flex justify-end mt-3">
                        <button
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 geocache-action-button"
                            data-action="click->geocache-coordinates#openAnalysis"
                            data-geocache-id="{{ geocache.id }}"
                            data-gc-code="{{ geocache.gc_code }}"
                            data-action-type="analyze">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                            </svg>
                            Analyser
                        </button>
                        <button
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 ml-2 geocache-action-button"
                            data-geocache-id="{{ geocache.id }}"
                            data-gc-code="{{ geocache.gc_code }}"
                            data-action-type="solver">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l4.879-4.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242z" />
                            </svg>
                            Solver
                        </button>
                        <button
                            class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 ml-2 geocache-action-button"
                            data-geocache-id="{{ geocache.id }}"
                            data-gc-code="{{ geocache.gc_code }}"
                            data-action-type="formula-solver">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                            </svg>
                            Formula Solver
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold text-gray-100 mb-4 flex justify-between items-center">
                <span>Description</span>
                <div class="flex">
                    <button 
                        id="analyze-geocache-button"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm flex items-center space-x-2 geocache-action-button"
                        data-geocache-id="{{ geocache.id }}"
                        data-gc-code="{{ geocache.gc_code }}"
                        data-action-type="analyze">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0012 18.75c-1.03 0-1.96-.421-2.632-1.102l-.547-.547z" />
                        </svg>
                        <span>Analyser</span>
                    </button>
                    <button 
                        id="solver-geocache-button"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm flex items-center space-x-2 ml-2 geocache-action-button"
                        data-geocache-id="{{ geocache.id }}"
                        data-gc-code="{{ geocache.gc_code }}"
                        data-action-type="solver">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l4.879-4.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242z" />
                        </svg>
                        <span>Solver</span>
                    </button>
                    <button 
                        id="formula-solver-button"
                        class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg text-sm flex items-center space-x-2 ml-2 geocache-action-button"
                        data-geocache-id="{{ geocache.id }}"
                        data-gc-code="{{ geocache.gc_code }}"
                        data-action-type="formula-solver">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        <span>Formula Solver</span>
                    </button>
                    <button 
                        id="ai-chat-geocache-button"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm flex items-center space-x-2 ml-2"
                        data-geocache-id="{{ geocache.id }}"
                        data-gc-code="{{ geocache.gc_code }}"
                        data-geocache-name="{{ geocache.name|tojson }}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                        <span>Chat IA</span>
                    </button>
                </div>
            </h2>
            <div class="prose prose-invert max-w-none">
                {{ geocache.description|safe }}
            </div>
        </div>

        <!-- Waypoints -->
        <div class="waypoints-section" data-controller="waypoint-form">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Waypoints</h3>
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline" 
                    type="button"
                    data-action="click->waypoint-form#toggleForm">
              Ajouter un waypoint
            </button>
          </div>
          
          <!-- Formulaire d'ajout de waypoint (initialement cach√©) -->
          <div class="waypoint-form-container bg-gray-700 p-4 rounded-lg mb-4 hidden" data-waypoint-form-target="form">
            <h4 class="text-white text-md font-medium mb-3" data-waypoint-form-target="formTitle">Nouveau Waypoint</h4>
            <form data-action="submit->waypoint-form#submitForm">
              <input type="hidden" name="geocache_id" value="{{ geocache.id }}" data-waypoint-form-target="geocacheIdInput">
              <input type="hidden" name="waypoint_id" value="" data-waypoint-form-target="waypointIdInput">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-gray-300 text-sm font-bold mb-2" for="wpPrefix">
                    Pr√©fixe
                  </label>
                  <input class="bg-gray-800 text-white border border-gray-600 rounded w-full py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                         id="wpPrefix" name="prefix" type="text" placeholder="Pr√©fixe" data-waypoint-form-target="prefixInput">
                </div>
                <div>
                  <label class="block text-gray-300 text-sm font-bold mb-2" for="wpLookup">
                    Lookup
                  </label>
                  <input class="bg-gray-800 text-white border border-gray-600 rounded w-full py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                         id="wpLookup" name="lookup" type="text" placeholder="Lookup" data-waypoint-form-target="lookupInput">
                </div>
              </div>
              
              <div class="mb-4">
                <label class="block text-gray-300 text-sm font-bold mb-2" for="wpName">
                  Nom
                </label>
                <input class="bg-gray-800 text-white border border-gray-600 rounded w-full py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                       id="wpName" name="name" type="text" placeholder="Nom du waypoint" data-waypoint-form-target="nameInput">
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-gray-300 text-sm font-bold mb-2" for="wpLatitude">
                    Latitude (format GC)
                  </label>
                  <input class="bg-gray-800 text-white border border-gray-600 rounded w-full py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                         id="wpLatitude" name="gc_lat" type="text" 
                         placeholder="N 48¬∞ 51.402"
                         value="{{ geocache.gc_lat }}" data-waypoint-form-target="gcLatInput">
                </div>
                <div>
                  <label class="block text-gray-300 text-sm font-bold mb-2" for="wpLongitude">
                    Longitude (format GC)
                  </label>
                  <input class="bg-gray-800 text-white border border-gray-600 rounded w-full py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                         id="wpLongitude" name="gc_lon" type="text" 
                         placeholder="E 002¬∞ 21.048"
                         value="{{ geocache.gc_lon }}" data-waypoint-form-target="gcLonInput">
                </div>
              </div>
              
              <!-- Section de calcul d'antipode -->
              <div class="bg-gray-800 p-3 rounded-lg mb-4 border border-gray-700">
                <h5 class="text-white text-sm font-medium mb-2">Calcul d'antipode</h5>
                <div class="flex items-center justify-between">
                  <p class="text-xs text-gray-400">Calcule le point diam√©tralement oppos√© sur la Terre √† partir des coordonn√©es actuelles.</p>
                  <button class="bg-orange-600 hover:bg-orange-700 text-white text-xs font-bold py-1 px-3 rounded focus:outline-none focus:shadow-outline" 
                          type="button"
                          data-action="click->waypoint-form#calculateAntipode">
                    <i class="fas fa-globe-americas mr-1"></i> Calculer l'antipode
                  </button>
                </div>
              </div>
              
              <!-- Section de projection du waypoint -->
              <div class="bg-gray-800 p-3 rounded-lg mb-4 border border-gray-700" data-waypoint-form-target="projectionSection">
                <h5 class="text-white text-sm font-medium mb-2">Projection du waypoint</h5>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                  <div>
                    <label class="block text-gray-300 text-xs font-bold mb-1" for="wpDistance">
                      Distance
                    </label>
                    <input class="bg-gray-700 text-white border border-gray-600 rounded w-full py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           id="wpDistance" type="number" step="0.1" min="0" 
                           placeholder="100" value="100" data-waypoint-form-target="distanceInput">
                  </div>
                  <div>
                    <label class="block text-gray-300 text-xs font-bold mb-1" for="wpDistanceUnit">
                      Unit√©
                    </label>
                    <select class="bg-gray-700 text-white border border-gray-600 rounded w-full py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            id="wpDistanceUnit" data-waypoint-form-target="distanceUnitInput">
                      <option value="m">m√®tres</option>
                      <option value="km">kilom√®tres</option>
                      <option value="miles">miles</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-gray-300 text-xs font-bold mb-1" for="wpBearing">
                      Angle (0¬∞ = Nord)
                    </label>
                    <input class="bg-gray-700 text-white border border-gray-600 rounded w-full py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           id="wpBearing" type="number" step="1" min="0" max="359" 
                           placeholder="0" value="0" data-waypoint-form-target="bearingInput">
                  </div>
                </div>
                <div class="flex justify-end">
                  <button class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-3 rounded focus:outline-none focus:shadow-outline" 
                          type="button"
                          data-action="click->waypoint-form#calculateProjection">
                    <i class="fas fa-calculator mr-1"></i> Calculer
                  </button>
                </div>
              </div>

              <!-- Section des coordonn√©es calcul√©es (commune) -->
              <div class="bg-gray-800 p-3 rounded-lg mb-4 border border-gray-700">
                <h5 class="text-white text-sm font-medium mb-2">R√©sultat du calcul</h5>
                <div class="mb-3">
                  <label class="block text-gray-300 text-xs font-bold mb-1" for="wpProjectedCoords">
                    Coordonn√©es calcul√©es
                  </label>
                  <div class="flex items-center">
                    <input class="bg-gray-700 text-white border border-gray-600 rounded w-full py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           id="wpProjectedCoords" type="text" readonly
                           placeholder="Les coordonn√©es calcul√©es appara√Ætront ici" 
                           data-waypoint-form-target="projectedCoordsInput">
                    <!-- Le bouton "Appliquer" sera ajout√© ici dynamiquement par JavaScript -->
                  </div>
                  <p class="text-xs text-gray-400 mt-1">Utilisez les outils ci-dessus pour calculer de nouvelles coordonn√©es, puis cliquez sur "Appliquer" pour les utiliser.</p>
                </div>
                <div class="mb-3">
                  <div class="flex items-center">
                    <input class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded" 
                           type="checkbox" 
                           id="wpAddProjectionToNotes" 
                           data-waypoint-form-target="addToNotesCheckbox" 
                           checked>
                    <label class="text-gray-300 text-xs" for="wpAddProjectionToNotes">
                      Ajouter les informations de calcul dans les notes
                    </label>
                  </div>
                </div>
              </div>
              
              <div class="mb-4">
                <label class="block text-gray-300 text-sm font-bold mb-2" for="wpNote">
                  Note
                </label>
                <textarea class="bg-gray-800 text-white border border-gray-600 rounded w-full py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                          id="wpNote" name="note" rows="3" placeholder="Notes sur le waypoint" data-waypoint-form-target="noteInput"></textarea>
              </div>
              
              <div class="flex items-center justify-end">
                <button class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2 focus:outline-none focus:shadow-outline" 
                        type="button"
                        data-action="click->waypoint-form#toggleForm">
                  Annuler
                </button>
                <button class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" 
                        type="submit"
                        data-waypoint-form-target="submitButton">
                  Ajouter le waypoint
                </button>
                <!-- Bouton pour cr√©er un nouveau point, visible uniquement en mode √©dition -->
                <button class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline ml-2 hidden" 
                        type="button"
                        data-waypoint-form-target="createNewButton"
                        data-action="click->waypoint-form#createNewFromCurrent">
                  Cr√©er un nouveau point
                </button>
              </div>
              
              <!-- Bouton pour transformer le waypoint en coordonn√©es corrig√©es -->
              <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="flex items-center justify-between">
                  <div class="text-sm text-gray-300">
                    <i class="fas fa-map-marker-alt mr-1"></i> Transformer en coordonn√©es corrig√©es
                    <p class="text-xs text-gray-400 mt-1">
                      Utiliser ce waypoint comme coordonn√©es corrig√©es pour cette g√©ocache.
                    </p>
                  </div>
                  <button class="bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" 
                          type="button"
                          data-waypoint-form-target="useAsCorrectCoordsButton"
                          data-action="click->waypoint-form#useAsCorrectCoordinates">
                    <i class="fas fa-check-circle mr-1"></i> Utiliser comme coordonn√©es corrig√©es
                  </button>
                </div>
              </div>
            </form>
          </div>
          
          <!-- Container pour la liste des waypoints -->
          <div id="waypoints-list-container" data-waypoint-form-target="waypointsList">
            {% include 'partials/waypoints_list.html' %}
          </div>
        </div>

        <!-- Indices -->
        {% if geocache.hints %}
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold text-gray-100 mb-4">Indices</h2>
            <div class="text-gray-300 whitespace-pre-wrap">{{ geocache.hints }}</div>
        </div>
        {% endif %}

        <!-- Galerie d'images -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6"
             data-controller="geocache-gallery">
            <h2 class="text-lg font-semibold text-gray-100 mb-4">Images</h2>
            <div id="geocache-gallery-container" data-geocache-id="{{ geocache.id }}">
                {% include 'partials/geocache_gallery.html' %}
            </div>
        </div>

        <!-- Logs -->
        {% if geocache.logs_count %}
        <div class="bg-gray-800 rounded-lg p-4">
            <h2 class="text-lg font-semibold text-gray-100 mb-4">Logs</h2>
            <div class="text-gray-300">{{ geocache.logs_count }} logs enregistr√©s</div>
        </div>
        {% endif %}

    </div>
</div>

<style>
    /* Style pour les barres de d√©filement */
    ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }

    ::-webkit-scrollbar-track {
        background: #1e1e1e;
        border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
        background: #3c3c3c;
        border-radius: 5px;
        border: 2px solid #1e1e1e;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #4c4c4c;
    }

    ::-webkit-scrollbar-corner {
        background: #1e1e1e;
    }

    /* Support Firefox */
    * {
        scrollbar-width: thin;
        scrollbar-color: #3c3c3c #1e1e1e;
    }

    .geocache-image {
        cursor: pointer;
    }

    .geocache-image.selected {
        outline: 2px solid #3b82f6;
        outline-offset: -2px;
    }

    .context-menu {
        position: fixed;
        z-index: 10000;
        background: #1f2937;
        border: 1px solid #374151;
        border-radius: 0.375rem;
        padding: 0.5rem 0;
        min-width: 160px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .context-menu-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        color: #e5e7eb;
        transition: background-color 0.2s;
        user-select: none;
    }

    .context-menu-item:hover {
        background-color: #374151;
    }

    .context-menu-item i {
        margin-right: 0.5rem;
        width: 1rem;
        text-align: center;
    }
</style>

<script>
    // Fonction pour ouvrir un onglet de chat IA avec les informations de la g√©ocache
    function openGeocacheAIChat(geocacheId, gcCode, geocacheName) {
        // R√©cup√©rer la description de la g√©ocache
        const geocacheDescription = document.querySelector('.prose.prose-invert').innerText.trim();
        
        // Construire le message initial pour l'IA
        const initialMessage = `Je travaille sur la g√©ocache ${gcCode} - "${geocacheName}". Voici sa description:\n\n${geocacheDescription.substring(0, 1500)}\n\nPouvez-vous m'aider √† analyser cette g√©ocache et √† trouver des indices potentiels?`;
        
        // V√©rifier si le panneau de chat est visible
        const chatPanel = document.getElementById('chat-panel');
        const rightPanel = document.querySelector('.right-panel');
        
        // Si le panneau de droite est ferm√©, l'ouvrir
        if (rightPanel.classList.contains('collapsed')) {
            // Trouver le bouton de chat dans la barre lat√©rale droite
            const chatButton = document.querySelector('.right-sidebar .sidebar-button[data-panel="chat"]');
            if (chatButton) {
                chatButton.click();
            }
        }
        
        if (chatPanel) {
            // Cr√©er un nouvel onglet de chat ou utiliser le premier s'il n'y en a pas
            let chatId;
            const chatInstances = chatPanel.querySelectorAll('.chat-instance');
            
            if (chatInstances.length === 0) {
                // Aucun chat existant, cr√©er un nouveau
                chatId = chatPanel.addChat();
            } else {
                // V√©rifier si un onglet est d√©j√† ouvert pour cette g√©ocache
                let existingChatId = null;
                chatInstances.forEach(instance => {
                    const header = instance.querySelector('.chat-header h2');
                    if (header && header.textContent.includes(gcCode)) {
                        existingChatId = parseInt(instance.dataset.chatId);
                    }
                });
                
                if (existingChatId) {
                    // Utiliser l'onglet existant
                    chatId = existingChatId;
                    chatPanel.switchToChat(chatId);
                } else {
                    // Cr√©er un nouvel onglet
                    chatId = chatPanel.addChat();
                    
                    // Renommer l'onglet avec le code GC
                    const tabLabel = chatPanel.querySelector(`.chat-tab[data-chat-id="${chatId}"] .chat-tab-label`);
                    if (tabLabel) {
                        tabLabel.textContent = gcCode;
                    }
                    
                    // Renommer le titre du chat
                    const chatHeader = chatPanel.querySelector(`.chat-instance[data-chat-id="${chatId}"] .chat-header h2`);
                    if (chatHeader) {
                        chatHeader.textContent = `CHAT IA - ${gcCode}`;
                    }
                    
                    // Stocker l'ID de la g√©ocache dans le chat pour r√©f√©rence future
                    const chatInstance = chatPanel.querySelector(`.chat-instance[data-chat-id="${chatId}"]`);
                    if (chatInstance) {
                        chatInstance.dataset.geocacheId = geocacheId;
                    }
                }
            }
            
            // Envoyer le message initial
            const activeChat = chatPanel.querySelector(`.chat-instance[data-chat-id="${chatId}"]`);
            if (activeChat) {
                const textarea = activeChat.querySelector('.chat-input');
                if (textarea) {
                    textarea.value = initialMessage;
                    
                    // Simuler l'envoi du message
                    const sendButton = activeChat.querySelector('.chat-send-button');
                    if (sendButton) {
                        // Cr√©er et d√©clencher un √©v√©nement de clic
                        const clickEvent = new MouseEvent('click', {
                            bubbles: true,
                            cancelable: true,
                            view: window
                        });
                        sendButton.dispatchEvent(clickEvent);
                    }
                }
            }
        } else {
            console.error("Le panneau de chat n'a pas √©t√© trouv√©.");
        }
    }

    // Syst√®me pour nos propres menus contextuels des boutons d'action
    document.addEventListener('DOMContentLoaded', function() {
        setupGeocacheActionButtons();
        
        // L'√©couteur d'√©v√©nement actionButtonContextMenu est d√©j√† d√©fini au d√©but du document
        // Ne pas le red√©finir ici pour √©viter les doublons
        
        // Fermer le menu contextuel sur un clic ailleurs
        document.addEventListener('click', function(event) {
            const menu = document.querySelector('.action-button-context-menu');
            if (menu && !menu.contains(event.target)) {
                menu.remove();
            }
        });
    });
    
    // Fonction pour configurer les boutons d'action g√©ocache
    function setupGeocacheActionButtons() {
        console.log('=== DEBUG: setupGeocacheActionButtons appel√©e ===');
        
        // S√©lectionner tous les boutons qui devraient avoir des actions sp√©ciales
        const buttons = document.querySelectorAll('.geocache-action-button');
        console.log(`=== DEBUG: ${buttons.length} boutons d'action trouv√©s ===`);
        
        buttons.forEach((button, index) => {
            console.log(`=== DEBUG: Configuration du bouton ${index} de type ${button.dataset.actionType} ===`);
            
            // Supprimer tous les gestionnaires d'√©v√©nements existants
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            // Ajouter un nouveau gestionnaire de clic avec une fonction anonyme
            newButton.addEventListener('click', function(event) {
                console.log(`=== DEBUG: Clic sur le bouton de type ${this.dataset.actionType} ===`);
                
                // R√©cup√©rer les informations du bouton
                const actionType = this.dataset.actionType;
                const geocacheId = this.dataset.geocacheId;
                const gcCode = this.dataset.gcCode;
                
                if (!event.ctrlKey && !event.metaKey) {
                    // Clic gauche standard
                    console.log(`=== DEBUG: Clic gauche standard d√©tect√© ===`);
                    
                    let shouldUseExistingTab = true; // Valeur par d√©faut
                    
                    // V√©rifier si PluginGoldenLayoutIntegration est disponible
                    if (window.PluginGoldenLayoutIntegration && 
                        typeof window.PluginGoldenLayoutIntegration.shouldOpenInSameSection === 'function') {
                        // Utiliser la configuration globale
                        shouldUseExistingTab = window.PluginGoldenLayoutIntegration.shouldOpenInSameSection();
                        console.log(`=== DEBUG: shouldOpenInSameSection retourne ${shouldUseExistingTab} ===`);
                    } else {
                        console.log('=== DEBUG: window.PluginGoldenLayoutIntegration non disponible, utilisation du comportement par d√©faut ===');
                    }
                    
                    // Ex√©cuter l'action en fonction du type
                    try {
                        switch (actionType) {
                            case 'analyze':
                                console.log(`=== DEBUG: Ex√©cution de l'action analyze pour ${gcCode} ===`);
                                if (typeof window.openPluginTab === 'function') {
                                    window.openPluginTab('analysis_web_page', `Analyse ${gcCode}`, {
                                        geocacheId: geocacheId,
                                        gcCode: gcCode,
                                        openInSameTab: shouldUseExistingTab
                                    });
                                } else {
                                    console.error('=== ERREUR: La fonction openPluginTab n\'est pas disponible ===');
                                }
                                break;
                                
                            case 'solver':
                                console.log(`=== DEBUG: Ex√©cution de l'action solver pour ${gcCode} ===`);
                                if (typeof window.openSolverTab === 'function') {
                                    window.openSolverTab(geocacheId, gcCode, shouldUseExistingTab);
                                } else {
                                    console.error('=== ERREUR: La fonction openSolverTab n\'est pas disponible ===');
                                }
                                break;
                                
                            case 'formula-solver':
                                console.log(`=== DEBUG: Ex√©cution de l'action formula-solver pour ${gcCode} ===`);
                                if (typeof window.openFormulaSolverTab === 'function') {
                                    window.openFormulaSolverTab(geocacheId, gcCode, shouldUseExistingTab);
                                } else {
                                    console.error('=== ERREUR: La fonction openFormulaSolverTab n\'est pas disponible ===');
                                }
                                break;
                                
                            default:
                                console.error(`Type d'action inconnu: ${actionType}`);
                        }
                    } catch (error) {
                        console.error('=== ERREUR lors de l\'ex√©cution de l\'action ===', error);
                    }
                } else {
                    // Ctrl+Clic ou Cmd+Clic - forcer l'ouverture dans un nouvel onglet
                    console.log(`=== DEBUG: Ctrl+Clic ou Cmd+Clic d√©tect√© ===`);
                    
                    try {
                        switch (actionType) {
                            case 'analyze':
                                if (typeof window.openPluginTab === 'function') {
                                    window.openPluginTab('analysis_web_page', `Analyse ${gcCode}`, {
                                        geocacheId: geocacheId,
                                        gcCode: gcCode,
                                        openInSameTab: false
                                    });
                                }
                                break;
                                
                            case 'solver':
                                if (typeof window.openSolverTab === 'function') {
                                    window.openSolverTab(geocacheId, gcCode, false);
                                }
                                break;
                                
                            case 'formula-solver':
                                if (typeof window.openFormulaSolverTab === 'function') {
                                    window.openFormulaSolverTab(geocacheId, gcCode, false);
                                }
                                break;
                        }
                    } catch (error) {
                        console.error('=== ERREUR lors de l\'ex√©cution de l\'action ===', error);
                    }
                    
                    event.preventDefault();
                    event.stopPropagation();
                }
            });
        });
    }

    // Ajouter le gestionnaire de clic au bouton Chat IA apr√®s le chargement du DOM
    document.addEventListener('DOMContentLoaded', function() {
        const chatButton = document.getElementById('ai-chat-geocache-button');
        if (chatButton) {
            chatButton.addEventListener('click', function() {
                const geocacheId = this.dataset.geocacheId;
                const gcCode = this.dataset.gcCode;
                const geocacheName = this.dataset.geocacheName;
                openGeocacheAIChat(geocacheId, gcCode, JSON.parse(geocacheName));
            });
        }
    });

    // Script d'initialisation pour s'assurer que les d√©pendances sont charg√©es
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== DEBUG: V√©rification des d√©pendances ===');
        console.log('window.PluginGoldenLayoutIntegration disponible:', typeof window.PluginGoldenLayoutIntegration !== 'undefined');
        if (window.PluginGoldenLayoutIntegration) {
            console.log('shouldOpenInSameSection disponible:', typeof window.PluginGoldenLayoutIntegration.shouldOpenInSameSection === 'function');
        }
        console.log('window.openPluginTab disponible:', typeof window.openPluginTab === 'function');
        console.log('window.openSolverTab disponible:', typeof window.openSolverTab === 'function');
        console.log('window.openFormulaSolverTab disponible:', typeof window.openFormulaSolverTab === 'function');
        
        // Forcer une r√©initialisation des boutons apr√®s chargement complet
        setTimeout(() => {
            console.log('=== DEBUG: R√©initialisation forc√©e des boutons d\'action ===');
            if (typeof setupGeocacheActionButtons === 'function') {
                setupGeocacheActionButtons();
            } else {
                console.error('=== ERREUR: La fonction setupGeocacheActionButtons n\'est pas disponible ===');
            }
        }, 1000);
    });
</script>

<script src="{{ url_for('static', filename='js/diagnostics.js') }}"></script>

<!-- Scripts de correction des boutons -->
<script src="{{ url_for('static', filename='js/button_fix.js') }}"></script>
<script src="{{ url_for('static', filename='js/button_direct.js') }}"></script>

</div>

                // R√©cup√©rer les informations du bouton
                const actionType = this.dataset.actionType;
                const geocacheId = this.dataset.geocacheId;
                const gcCode = this.dataset.gcCode;
                
                if (!event.ctrlKey && !event.metaKey) {
                    // Clic gauche standard
                    console.log(`=== DEBUG: Clic gauche standard d√©tect√© ===`);
                    
                    let shouldUseExistingTab = true; // Valeur par d√©faut
                    
                    // V√©rifier si PluginGoldenLayoutIntegration est disponible
                    if (window.PluginGoldenLayoutIntegration && 
                        typeof window.PluginGoldenLayoutIntegration.shouldOpenInSameSection === 'function') {
                        // Utiliser la configuration globale
                        shouldUseExistingTab = window.PluginGoldenLayoutIntegration.shouldOpenInSameSection();
                        console.log(`=== DEBUG: shouldOpenInSameSection retourne ${shouldUseExistingTab} ===`);
                    } else {
                        console.log('=== DEBUG: window.PluginGoldenLayoutIntegration non disponible, utilisation du comportement par d√©faut ===');
                    }
                    
                    // Ex√©cuter l'action en fonction du type
                    try {
                        switch (actionType) {
                            case 'analyze':
                                console.log(`=== DEBUG: Ex√©cution de l'action analyze pour ${gcCode} ===`);
                                if (typeof window.openPluginTab === 'function') {
                                    window.openPluginTab('analysis_web_page', `Analyse ${gcCode}`, {
                                        geocacheId: geocacheId,
                                        gcCode: gcCode,
                                        openInSameTab: shouldUseExistingTab
                                    });
                                } else {
                                    console.error('=== ERREUR: La fonction openPluginTab n\'est pas disponible ===');
                                }
                                break;
                                
                            case 'solver':
                                console.log(`=== DEBUG: Ex√©cution de l'action solver pour ${gcCode} ===`);
                                if (typeof window.openSolverTab === 'function') {
                                    window.openSolverTab(geocacheId, gcCode, shouldUseExistingTab);
                                } else {
                                    console.error('=== ERREUR: La fonction openSolverTab n\'est pas disponible ===');
                                }
                                break;
                                
                            case 'formula-solver':
                                console.log(`=== DEBUG: Ex√©cution de l'action formula-solver pour ${gcCode} ===`);
                                if (typeof window.openFormulaSolverTab === 'function') {
                                    window.openFormulaSolverTab(geocacheId, gcCode, shouldUseExistingTab);
                                } else {
                                    console.error('=== ERREUR: La fonction openFormulaSolverTab n\'est pas disponible ===');
                                }
                                break;
                                
                            default:
                                console.error(`Type d'action inconnu: ${actionType}`);
                        }
                    } catch (error) {
                        console.error('=== ERREUR lors de l\'ex√©cution de l\'action ===', error);
                    }
                } else {
                    // Ctrl+Clic ou Cmd+Clic - forcer l'ouverture dans un nouvel onglet
                    console.log(`=== DEBUG: Ctrl+Clic ou Cmd+Clic d√©tect√© ===`);
                    
                    try {
                        switch (actionType) {
                            case 'analyze':
                                if (typeof window.openPluginTab === 'function') {
                                    window.openPluginTab('analysis_web_page', `Analyse ${gcCode}`, {
                                        geocacheId: geocacheId,
                                        gcCode: gcCode,
                                        openInSameTab: false
                                    });
                                }
                                break;
                                
                            case 'solver':
                                if (typeof window.openSolverTab === 'function') {
                                    window.openSolverTab(geocacheId, gcCode, false);
                                }
                                break;
                                
                            case 'formula-solver':
                                if (typeof window.openFormulaSolverTab === 'function') {
                                    window.openFormulaSolverTab(geocacheId, gcCode, false);
                                }
                                break;
                        }
                    } catch (error) {
                        console.error('=== ERREUR lors de l\'ex√©cution de l\'action ===', error);
                    }
                    
                    event.preventDefault();
                    event.stopPropagation();
                }
            });
        });
    }

    // Ajouter le gestionnaire de clic au bouton Chat IA apr√®s le chargement du DOM
    document.addEventListener('DOMContentLoaded', function() {
        const chatButton = document.getElementById('ai-chat-geocache-button');
        if (chatButton) {
            chatButton.addEventListener('click', function() {
                const geocacheId = this.dataset.geocacheId;
                const gcCode = this.dataset.gcCode;
                const geocacheName = this.dataset.geocacheName;
                openGeocacheAIChat(geocacheId, gcCode, JSON.parse(geocacheName));
            });
        }
    });

    // Script d'initialisation pour s'assurer que les d√©pendances sont charg√©es
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== DEBUG: V√©rification des d√©pendances ===');
        console.log('window.PluginGoldenLayoutIntegration disponible:', typeof window.PluginGoldenLayoutIntegration !== 'undefined');
        if (window.PluginGoldenLayoutIntegration) {
            console.log('shouldOpenInSameSection disponible:', typeof window.PluginGoldenLayoutIntegration.shouldOpenInSameSection === 'function');
        }
        console.log('window.openPluginTab disponible:', typeof window.openPluginTab === 'function');
        console.log('window.openSolverTab disponible:', typeof window.openSolverTab === 'function');
        console.log('window.openFormulaSolverTab disponible:', typeof window.openFormulaSolverTab === 'function');
        
        // Forcer une r√©initialisation des boutons apr√®s chargement complet
        setTimeout(() => {
            console.log('=== DEBUG: R√©initialisation forc√©e des boutons d\'action ===');
            if (typeof setupGeocacheActionButtons === 'function') {
                setupGeocacheActionButtons();
            } else {
                console.error('=== ERREUR: La fonction setupGeocacheActionButtons n\'est pas disponible ===');
            }
        }, 1000);
    });
</script>

<script src="{{ url_for('static', filename='js/diagnostics.js') }}"></script>

<!-- Scripts de correction des boutons -->
<script src="{{ url_for('static', filename='js/button_fix.js') }}"></script>
<script src="{{ url_for('static', filename='js/button_direct.js') }}"></script>

</div>
