<div class="w-full h-full bg-gray-900 overflow-auto p-4"
     hx-ext="include-vals"
     hx-headers='{"X-Layout-Component": "true"}'
     data-multi-solver="container"
     id="multi-solver-container"
     {% if geocaches %}data-geocaches='{{ geocaches|safe }}'{% endif %}>
    
    <div class="max-w-6xl mx-auto">
        <!-- En-tête -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-100 mb-2">Multi-Solver</h1>
            <div class="text-gray-400">
                Outil de résolution pour plusieurs énigmes simultanément
            </div>
        </div>

        <!-- Liste des géocaches à résoudre -->
        <div class="bg-gray-800 rounded-lg p-4 mb-4">
            <h2 class="text-lg font-semibold text-gray-100 mb-3">Géocaches sélectionnées</h2>
            <div data-multi-solver-target="geocachesList" class="space-y-2 max-h-60 overflow-y-auto">
                <!-- Cette section sera remplie dynamiquement avec les géocaches -->
                <div class="animate-pulse">
                    <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-gray-700 rounded w-1/2 mb-2"></div>
                    <div class="h-4 bg-gray-700 rounded w-2/3"></div>
                </div>
            </div>
        </div>

        <!-- Section d'outils de résolution -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Panneau MetaSolver -->
            <div class="bg-gray-800 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-gray-100 mb-3">MetaSolver</h2>
                <div class="space-y-4">
                    <div class="flex flex-col space-y-2">
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-300 mb-1">Mode</label>
                                <select id="metasolver-mode" class="w-full bg-gray-700 border border-gray-600 rounded-md text-gray-200 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="detect">Analyser</option>
                                    <option value="decode">Décrypter</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-300 mb-1">Précision</label>
                                <select id="metasolver-strict" class="w-full bg-gray-700 border border-gray-600 rounded-md text-gray-200 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="smooth">Smooth</option>
                                    <option value="strict">Strict</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-300 mb-1">Caractères autorisés</label>
                                <select id="metasolver-allowed-chars" class="w-full bg-gray-700 border border-gray-600 rounded-md text-gray-200 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="all">Tous les caractères</option>
                                    <option value="special">Caractères spéciaux (°, ., ')</option>
                                    <option value="custom">Personnalisé</option>
                                </select>
                            </div>
                            <div class="flex-1 hidden" id="metasolver-custom-chars-container">
                                <label class="block text-sm font-medium text-gray-300 mb-1">Caractères personnalisés</label>
                                <input type="text" id="metasolver-custom-chars" placeholder="Ex: °.'" class="w-full bg-gray-700 border border-gray-600 rounded-md text-gray-200 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="metasolver-embedded" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded bg-gray-700">
                            <label for="metasolver-embedded" class="ml-2 block text-sm text-gray-300">Embedded</label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="metasolver-gps-detection" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded bg-gray-700" checked>
                            <label for="metasolver-gps-detection" class="ml-2 block text-sm text-gray-300">Détecter les coordonnées GPS</label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="metasolver-apply-to-all" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded bg-gray-700" checked>
                            <label for="metasolver-apply-to-all" class="ml-2 block text-sm text-gray-300">Appliquer à toutes les géocaches</label>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button 
                            data-action="click->multi-solver#executeMetaSolver" 
                            data-mode="detect"
                            class="flex-1 flex items-center justify-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                            Analyser
                        </button>
                        <button 
                            data-action="click->multi-solver#executeMetaSolver" 
                            data-mode="decode"
                            class="flex-1 flex items-center justify-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                            </svg>
                            Décrypter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Panneau des plugins -->
            <div class="bg-gray-800 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-gray-100 mb-3 flex items-center justify-between">
                    <span>Plugins</span>
                    <button 
                        onclick="window.closePluginInterface()"
                        class="text-xs bg-blue-600 hover:bg-blue-700 text-white rounded px-2 py-1"
                        id="reload-plugins-button">
                        <i class="fas fa-sync-alt mr-1"></i> Rafraîchir
                    </button>
                </h2>
                
                <!-- Barre de recherche -->
                <div class="mb-3" id="plugin-search-container">
                    <div class="relative">
                        <input type="text" class="w-full p-2 pl-8 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" 
                               placeholder="Rechercher un plugin..." 
                               id="plugin-search-input">
                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Conteneur pour les plugins et l'interface des plugins -->
                <div class="plugin-container" id="plugin-list-container">
                    <!-- Cette partie sera remplie dynamiquement -->
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-700 rounded w-1/2"></div>
                    </div>
                </div>
                
                <!-- Options d'application -->
                <div class="mt-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="apply-to-all-geocaches" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded bg-gray-700" checked>
                        <label for="apply-to-all-geocaches" class="ml-2 block text-sm text-gray-300">Appliquer à toutes les géocaches</label>
                    </div>
                    
                    <div class="mt-2 text-center">
                        <button 
                            id="execute-plugin-button"
                            data-action="multi-solver#executePlugin"
                            data-plugin-state="unselected"
                            class="w-full py-2 bg-gray-500 text-white rounded-md text-sm font-medium transition-colors">
                            <i class="fas fa-play mr-2"></i>
                            Exécuter sur les géocaches
                        </button>
                    </div>
                    
                    <!-- Indicateur d'état pour les plugins -->
                    <div id="plugin-status" class="mt-2 text-center text-sm text-amber-400">
                        Veuillez d'abord sélectionner un plugin
                    </div>
                </div>
            </div>
        </div>

        <!-- Tableau des résultats -->
        <div class="bg-gray-800 rounded-lg p-4 mt-4">
            <h2 class="text-lg font-semibold text-gray-100 mb-3">Résultats</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                GC Code
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                Nom
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                Détections
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                Coordonnées
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody data-multi-solver-target="resultsTable" class="bg-gray-800 divide-y divide-gray-700">
                        <!-- Cette section sera remplie dynamiquement avec les résultats -->
                        <tr>
                            <td colspan="5" class="px-6 py-4">
                                <div class="text-center text-gray-400">Aucun résultat disponible</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Message d'erreur -->
        <div data-multi-solver-target="error" class="hidden mt-4">
            <div class="bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded">
                Une erreur est survenue lors du traitement des données.
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    // Fonction pour exécuter un plugin sur les géocaches
    window.executePlugin = function(pluginName) {
        console.log("%c[MultiSolver] Exécution de la fonction globale executePlugin pour:", "background:purple; color:white; font-weight:bold", pluginName);
        
        if (!pluginName) {
            console.error("%c[MultiSolver] ERREUR: Aucun nom de plugin fourni", "background:red; color:white; font-weight:bold");
            return;
        }
        
        // Récupérer les géocaches à traiter
        let geocaches = [];
        
        // Essayer d'abord de récupérer les géocaches depuis la variable globale
        if (window.injectedGeocaches && Array.isArray(window.injectedGeocaches)) {
            geocaches = window.injectedGeocaches;
            console.log("%c[MultiSolver] Utilisation des géocaches injectées:", "background:green; color:white", geocaches.length);
        } else {
            // Sinon, essayer de récupérer depuis sessionStorage
            try {
                const storedGeocaches = sessionStorage.getItem('multiSolverGeocaches');
                if (storedGeocaches) {
                    geocaches = JSON.parse(storedGeocaches);
                    console.log("%c[MultiSolver] Utilisation des géocaches depuis sessionStorage:", "background:green; color:white", geocaches.length);
                }
            } catch (error) {
                console.error("%c[MultiSolver] Erreur lors de la récupération des géocaches:", "background:red; color:white", error);
            }
        }
        
        if (!geocaches || geocaches.length === 0) {
            console.error("%c[MultiSolver] Aucune géocache disponible pour le traitement", "background:red; color:white");
            alert("Aucune géocache disponible pour appliquer le plugin.");
            return;
        }
        
        console.log("%c[MultiSolver] Démarrage du traitement pour", "background:green; color:white", {
            plugin: pluginName,
            geocaches: geocaches.length
        });
        
        // Traiter les géocaches une par une
        const results = [];
        const processGeocaches = async () => {
            try {
                // Récupérer les données du formulaire si disponible
                let formData = {};
                const formElement = document.querySelector('form');
                
                if (formElement) {
                    const formDataObj = new FormData(formElement);
                    for (const [key, value] of formDataObj.entries()) {
                        formData[key] = value;
                    }
                }
                
                // Afficher un message de chargement
                const resultsTable = document.querySelector('[data-multi-solver-target="resultsTable"]');
                if (resultsTable) {
                    resultsTable.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4">
                                <div class="flex justify-center">
                                    <div class="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                                </div>
                                <div class="text-center text-gray-400 mt-2">Application du plugin ${pluginName} sur ${geocaches.length} géocache(s)...</div>
                            </td>
                        </tr>
                    `;
                }
                
                // Traiter chaque géocache
                for (const geocache of geocaches) {
                    try {
                        // Récupérer le texte de la géocache
                        const descriptionResponse = await fetch(`/geocaches/${geocache.id}/text`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        if (!descriptionResponse.ok) {
                            throw new Error(`Erreur HTTP: ${descriptionResponse.status}`);
                        }
                        
                        const descriptionData = await descriptionResponse.json();
                        const text = descriptionData.description;
                        
                        // Appeler l'API pour exécuter le plugin
                        const response = await fetch(`/api/plugins/${pluginName}/execute`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                text: text,
                                ...formData
                            }),
                        });
                        
                        if (!response.ok) {
                            throw new Error(`Erreur HTTP: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        // Extraire le résultat
                        let resultText = '';
                        let coordinates = null;
                        
                        if (data.text_output) {
                            resultText = data.text_output;
                        } else if (data.result?.text?.text_output) {
                            resultText = data.result.text.text_output;
                        } else if (data.output) {
                            resultText = data.output;
                        } else if (typeof data.result === 'string') {
                            resultText = data.result;
                        } else if (data.result) {
                            resultText = JSON.stringify(data.result);
                        } else {
                            resultText = JSON.stringify(data);
                        }
                        
                        // Extraire les coordonnées si présentes
                        if (data.coordinates) {
                            coordinates = data.coordinates;
                        } else if (data.result?.coordinates) {
                            coordinates = data.result.coordinates;
                        }
                        
                        // Ajouter le résultat
                        results.push({
                            geocache: geocache,
                            result: resultText,
                            coordinates: coordinates,
                            plugin: pluginName,
                            timestamp: new Date().toISOString()
                        });
                        
                    } catch (error) {
                        console.error(`Erreur pour la géocache ${geocache.id}:`, error);
                        results.push({
                            geocache: geocache,
                            result: `Erreur: ${error.message}`,
                            error: true,
                            plugin: pluginName,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
                
                // Mettre à jour le tableau des résultats
                updateResultsTable(results);
                
            } catch (error) {
                console.error("Erreur globale:", error);
                alert(`Erreur lors de l'exécution du plugin: ${error.message}`);
            }
        };
        
        // Fonction pour mettre à jour le tableau des résultats
        const updateResultsTable = (results) => {
            const resultsTable = document.querySelector('[data-multi-solver-target="resultsTable"]');
            if (!resultsTable) return;
            
            let tableHtml = '';
            
            if (results.length === 0) {
                resultsTable.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4">
                            <div class="text-center text-gray-400">Aucun résultat disponible</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            results.forEach((result) => {
                const geocache = result.geocache;
                const resultClass = result.error ? 'text-red-400' : '';
                
                tableHtml += `
                    <tr class="hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-200">${geocache.gc_code || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-200">${geocache.name || 'Sans nom'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm ${resultClass} whitespace-pre-wrap max-h-20 overflow-y-auto">${result.result || 'Aucun résultat'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-200">${result.coordinates ? formatCoordinates(result.coordinates) : 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-right">
                            <button onclick="viewResult('${geocache.id}', '${result.plugin}', ${results.indexOf(result)})" class="text-blue-400 hover:text-blue-300 mr-3">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${result.coordinates ? `<button onclick="saveCoordinates('${geocache.id}', '${result.coordinates?.latitude}', '${result.coordinates?.longitude}')" class="text-green-400 hover:text-green-300">
                                <i class="fas fa-map-marker-alt"></i>
                            </button>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            resultsTable.innerHTML = tableHtml;
        };
        
        // Fonction pour formater les coordonnées
        const formatCoordinates = (coords) => {
            if (!coords) return 'N/A';
            return `${coords.latitude}, ${coords.longitude}`;
        };
        
        // Fonction pour afficher les détails d'un résultat
        window.viewResult = function(geocacheId, plugin, resultIndex) {
            alert(`Détails pour la géocache ${geocacheId} avec le plugin ${plugin}`);
            // TODO: Implémenter une meilleure vue des détails
        };
        
        // Fonction pour sauvegarder les coordonnées
        window.saveCoordinates = function(geocacheId, lat, lng) {
            alert(`Coordonnées sauvegardées pour la géocache ${geocacheId}: ${lat}, ${lng}`);
            // TODO: Implémenter la sauvegarde des coordonnées
        };
        
        // Démarrer le traitement
        processGeocaches();
    };
</script>

<script type="text/javascript">
    // Debug script - sera exécuté immédiatement
    (function() {
        console.log("%c[MultiSolver DEBUG] Exécution du script de débogage", "background:red; color:white; font-weight:bold");
        
        // Vérifier les informations sur GoldenLayout
        try {
            const layoutInfo = {
                parentExists: !!window.parent,
                parentGoldenLayout: window.parent.mainLayout ? "présent" : "absent",
                parentGoldenLayoutData: window.parent.goldenLayoutData ? "présent" : "absent",
                currentTitle: window.parent.document.title || "Inconnu",
                injectedGeocaches: window.injectedGeocaches ? `${window.injectedGeocaches.length} géocaches` : "absent"
            };
            
            console.log("%c[MultiSolver DEBUG] Informations GoldenLayout:", "background:red; color:white", layoutInfo);
            
            // Si des géocaches sont présentes dans l'objet global window, les afficher directement
            if (window.injectedGeocaches && Array.isArray(window.injectedGeocaches) && window.injectedGeocaches.length > 0) {
                console.log("%c[MultiSolver DEBUG] Utilisation des géocaches injectées", "background:green; color:white");
                displayGeocachesList(window.injectedGeocaches);
                return;
            }
            
            // Essayer d'obtenir des informations sur le composant courant
            if (window.parent.mainLayout) {
                const currentContainer = window.frameElement?.closest('.lm_content')?.parentElement;
                const containerId = currentContainer?.id;
                
                if (containerId) {
                    const containerItem = window.parent.mainLayout.root.getItemsById(containerId)[0];
                    
                    if (containerItem) {
                        console.log("%c[MultiSolver DEBUG] Information sur le composant:", "background:red; color:white", {
                            id: containerItem.id,
                            title: containerItem.config.title,
                            componentState: containerItem.config.componentState
                        });
                        
                        // Si des géocaches sont présentes dans l'état du composant, les afficher directement
                        if (containerItem.config.componentState && containerItem.config.componentState.geocaches) {
                            try {
                                const geocaches = Array.isArray(containerItem.config.componentState.geocaches) 
                                    ? containerItem.config.componentState.geocaches 
                                    : JSON.parse(containerItem.config.componentState.geocaches);
                                
                                console.log("%c[MultiSolver DEBUG] Géocaches trouvées dans componentState:", "background:red; color:white", geocaches);
                                
                                if (geocaches && geocaches.length > 0) {
                                    // Afficher directement les géocaches
                                    const geocachesListElement = document.querySelector('[data-multi-solver-target="geocachesList"]');
                                    if (geocachesListElement) {
                                        let html = '';
                                        geocaches.forEach((geocache, index) => {
                                            html += `
                                                <div class="geocache-item flex justify-between items-center p-2 bg-gray-700 rounded mb-2">
                                                    <div>
                                                        <div class="font-medium text-gray-200">${geocache.gc_code || 'Sans code'} - ${geocache.name || 'Géocache ' + (index + 1)}</div>
                                                        <div class="text-xs text-gray-400">ID: ${geocache.id}</div>
                                                    </div>
                                                    <button 
                                                        onclick="openGeocacheDetails(${geocache.id}, '${geocache.gc_code || ''}', '${geocache.name || ''}')"
                                                        class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs">
                                                        Détails
                                                    </button>
                                                </div>
                                            `;
                                        });
                                        
                                        geocachesListElement.innerHTML = html;
                                        console.log("%c[MultiSolver DEBUG] Géocaches affichées directement depuis componentState", "background:green; color:white");
                                        
                                        // Cacher le message d'erreur s'il est affiché
                                        const errorElement = document.querySelector('[data-multi-solver-target="error"]');
                                        if (errorElement) {
                                            errorElement.classList.add('hidden');
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error("%c[MultiSolver DEBUG] Erreur lors du traitement des géocaches depuis componentState:", "background:red; color:white", error);
                            }
                        }
                    }
                }
            }
        } catch (error) {
            console.error("%c[MultiSolver DEBUG] Erreur lors de l'accès aux données GoldenLayout:", "background:red; color:white", error);
        }
    })();
</script>

<script type="text/javascript">
    // Script d'initialisation simplifié sans dépendance à Stimulus
    (function() {
        console.log("%c[MultiSolver] Initialisation du script pour GoldenLayout", "background:purple; color:white");
        
        // Définir la fonction displayGeocachesList utilisée par les scripts
        window.displayGeocachesList = function(geocaches) {
            console.log("%c[MultiSolver] Affichage de la liste des géocaches:", "background:orange; color:black", geocaches.length);
            
            const geocachesListElement = document.querySelector('[data-multi-solver-target="geocachesList"]');
            
            if (!geocachesListElement) {
                console.error("%c[MultiSolver] Élément liste des géocaches non trouvé", "background:red; color:white");
                return;
            }
            
            if (!geocaches || geocaches.length === 0) {
                geocachesListElement.innerHTML = '<div class="text-gray-400">Aucune géocache sélectionnée</div>';
                return;
            }
            
            let html = '';
            geocaches.forEach((geocache, index) => {
                html += `
                    <div class="geocache-item flex justify-between items-center p-2 bg-gray-700 rounded mb-2">
                        <div>
                            <div class="font-medium text-gray-200">${geocache.gc_code || 'Sans code'} - ${geocache.name || 'Géocache ' + (index + 1)}</div>
                            <div class="text-xs text-gray-400">ID: ${geocache.id}</div>
                        </div>
                        <button 
                            onclick="openGeocacheDetails(${geocache.id}, '${geocache.gc_code || ''}', '${geocache.name || ''}')"
                            class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs">
                            Détails
                        </button>
                    </div>
                `;
            });
            
            geocachesListElement.innerHTML = html;
            
            // Masquer le message d'erreur s'il est affiché
            const errorElement = document.querySelector('[data-multi-solver-target="error"]');
            if (errorElement) {
                errorElement.classList.add('hidden');
            }
        };
        
        // Ajouter cette fonction pour mettre à jour l'état du bouton d'exécution
        window.updateExecuteButtonState = function(pluginName) {
            const executeButton = document.getElementById('execute-plugin-button');
            const pluginStatus = document.getElementById('plugin-status');
            
            if (executeButton) {
                if (pluginName) {
                    // Un plugin est sélectionné
                    executeButton.setAttribute('data-plugin-name', pluginName);
                    executeButton.setAttribute('data-plugin-state', 'selected');
                    executeButton.classList.remove('bg-gray-500');
                    executeButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    executeButton.innerHTML = `<i class="fas fa-play mr-2"></i>Exécuter ${pluginName} sur les géocaches`;
                    
                    if (pluginStatus) {
                        pluginStatus.classList.add('hidden');
                    }
                } else {
                    // Aucun plugin n'est sélectionné
                    executeButton.removeAttribute('data-plugin-name');
                    executeButton.setAttribute('data-plugin-state', 'unselected');
                    executeButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                    executeButton.classList.add('bg-gray-500');
                    executeButton.innerHTML = `<i class="fas fa-play mr-2"></i>Exécuter sur les géocaches`;
                    
                    if (pluginStatus) {
                        pluginStatus.classList.remove('hidden');
                    }
                }
            }
        };
        
        // Écouter l'événement d'injection de géocaches
        document.addEventListener('geocachesInjected', function(event) {
            console.log("%c[MultiSolver] Événement geocachesInjected reçu:", "background:purple; color:white", event.detail);
            
            if (event.detail && event.detail.geocaches && Array.isArray(event.detail.geocaches)) {
                console.log(`%c[MultiSolver] ${event.detail.geocaches.length} géocaches reçues via événement`, "background:green; color:white");
                // Stocker les géocaches pour une utilisation ultérieure
                window.injectedGeocaches = event.detail.geocaches;
                displayGeocachesList(event.detail.geocaches);
                
                // Stocker pour une utilisation future
                try {
                    sessionStorage.setItem('multiSolverGeocaches', JSON.stringify(event.detail.geocaches));
                } catch (e) {
                    console.warn("%c[MultiSolver] Impossible de stocker les géocaches dans sessionStorage", "background:orange; color:black");
                }
                
                // Masquer le message d'erreur s'il est affiché
                const errorElement = document.querySelector('[data-multi-solver-target="error"]');
                if (errorElement) {
                    errorElement.classList.add('hidden');
                }
            }
        });
        
        // Fonction pour charger les plugins manuellement
        async function fetchPluginsManually(container) {
            try {
                console.log("%c[MultiSolver] Chargement manuel des plugins via fetch API", "background:orange; color:black");
                
                // Afficher un loader
                container.innerHTML = `
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-700 rounded w-1/2 mb-2"></div>
                        <div class="h-4 bg-gray-700 rounded w-2/3"></div>
                    </div>
                `;
                
                // Rendre la barre de recherche visible
                const searchContainer = document.getElementById('plugin-search-container');
                if (searchContainer) {
                    searchContainer.style.display = 'block';
                }
                
                // Modifier le bouton de rafraîchissement
                const reloadButton = document.getElementById('reload-plugins-button');
                if (reloadButton) {
                    reloadButton.innerHTML = '<i class="fas fa-sync-alt mr-1"></i> Rafraîchir';
                    reloadButton.onclick = function() {
                        console.log("%c[MultiSolver] Rafraîchissement manuel des plugins", "background:orange; color:black");
                        fetchPluginsManually(container);
                    };
                }
                
                // Appel direct à l'API
                const response = await fetch('/api/plugins?context=solver');
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const plugins = await response.json();
                console.log(`%c[MultiSolver] ${plugins.length} plugins récupérés en mode manuel`, "background:orange; color:black");
                
                // Créer une fonction globale pour activer les plugins
                window.activatePluginManually = function(pluginName) {
                    console.log("%c[MultiSolver] Activation manuelle du plugin:", "background:orange; color:black", pluginName);
                    
                    // Mettre à jour l'état du bouton d'exécution
                    window.updateExecuteButtonState(pluginName);
                    
                    // Au lieu d'envoyer un message au parent, charger l'interface du plugin directement
                    const pluginContainer = document.getElementById('plugin-list-container');
                    if (pluginContainer) {
                        loadPluginInterface(pluginName, pluginContainer);
                        
                        // Mettre à jour le bouton d'exécution avec le bon gestionnaire d'événements
                        setTimeout(() => {
                            const execButton = document.getElementById('execute-plugin-button');
                            if (execButton) {
                                execButton.onclick = window.executePluginManually;
                            }
                        }, 500);
                    } else {
                        console.error("%c[MultiSolver] Container de plugins non trouvé lors de l'activation", "background:red; color:white");
                    }
                };
                
                // Générer le HTML pour la liste des plugins avec un style semblable à geocache_solver.html
                let pluginsHTML = '<div class="space-y-2 max-h-[400px] overflow-y-auto bg-gray-700/30 p-2 rounded">';
                plugins.forEach(plugin => {
                    pluginsHTML += `
                        <div class="plugin-item flex items-center justify-between p-2 rounded-md hover:bg-gray-700 transition-colors" data-plugin-name="${plugin.name.toLowerCase()}">
                            <div>
                                <div class="font-medium text-gray-200">${plugin.name}</div>
                                <div class="text-xs text-gray-400">${plugin.description || 'Aucune description'}</div>
                            </div>
                            <button 
                                onclick="window.activatePluginManually('${plugin.name}')"
                                class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded-md text-xs font-medium transition-colors">
                                Sélectionner
                            </button>
                        </div>
                    `;
                });
                pluginsHTML += '</div>';
                
                // Mettre à jour le container
                container.innerHTML = pluginsHTML;
                container.setAttribute('data-loaded', 'true');
                
                // Ajouter la fonctionnalité de filtrage manuel
                setupSearchFunctionality(container);
                
                // Initialiser l'état du bouton d'exécution
                window.updateExecuteButtonState(null);
                
                // Configurer le bouton d'exécution avec un gestionnaire direct
                const execButton = document.getElementById('execute-plugin-button');
                if (execButton) {
                    execButton.onclick = window.executePluginManually;
                }
                
            } catch (error) {
                console.error("%c[MultiSolver] Erreur lors du chargement manuel des plugins:", "background:red; color:white", error);
                container.innerHTML = `
                    <div class="bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded">
                        Erreur lors du chargement des plugins: ${error.message}
                    </div>
                `;
            }
        }
        
        // Configurer la fonctionnalité de recherche
        function setupSearchFunctionality(pluginContainer) {
            const searchInput = document.getElementById('plugin-search-input');
            if (searchInput) {
                console.log("%c[MultiSolver] Configuration de la recherche de plugins", "background:orange; color:black");
                
                // Supprimer les écouteurs d'événements existants pour éviter les doublons
                const newSearchInput = searchInput.cloneNode(true);
                searchInput.parentNode.replaceChild(newSearchInput, searchInput);
                
                newSearchInput.addEventListener('input', function(event) {
                    const searchTerm = event.target.value.toLowerCase();
                    console.log("%c[MultiSolver] Recherche de plugins avec terme:", "background:orange; color:black", searchTerm);
                    const pluginItems = document.querySelectorAll('.plugin-item');
                    
                    pluginItems.forEach(item => {
                        const pluginName = item.dataset.pluginName;
                        if (pluginName && pluginName.includes(searchTerm)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
        }
        
        // Configurer les écouteurs pour les caractères autorisés
        function setupAllowedCharsListener() {
            const allowedCharsSelect = document.getElementById('metasolver-allowed-chars');
            const customCharsContainer = document.getElementById('metasolver-custom-chars-container');
            
            if (allowedCharsSelect && customCharsContainer) {
                console.log("%c[MultiSolver] Configuration des écouteurs pour les caractères autorisés", "background:orange; color:black");
                
                // Supprimer les écouteurs d'événements existants pour éviter les doublons
                const newAllowedCharsSelect = allowedCharsSelect.cloneNode(true);
                allowedCharsSelect.parentNode.replaceChild(newAllowedCharsSelect, allowedCharsSelect);
                
                newAllowedCharsSelect.addEventListener('change', function(event) {
                    console.log("%c[MultiSolver] Changement de type de caractères", "background:orange; color:black", event.target.value);
                    if (event.target.value === 'custom') {
                        customCharsContainer.classList.remove('hidden');
                    } else {
                        customCharsContainer.classList.add('hidden');
                    }
                });
            }
        }
        
        // Fonction principale d'initialisation
        function initialize() {
            console.log("%c[MultiSolver] Démarrage de l'initialisation", "background:orange; color:black");
            
            // Charger les géocaches depuis l'URL
            loadGeocachesFromUrl();
            
            // Configurer les caractères autorisés
            setupAllowedCharsListener();
            
            // Configurer les plugins
            const pluginContainer = document.getElementById('plugin-list-container');
            if (pluginContainer) {
                fetchPluginsManually(pluginContainer);
            } else {
                console.error("%c[MultiSolver] Container de plugins non trouvé", "background:red; color:white");
            }
            
            // Configurer les boutons du MetaSolver
            setupMetaSolverButtons();
        }
        
        // Charger les géocaches depuis l'URL
        function loadGeocachesFromUrl() {
            console.log("%c[MultiSolver] Chargement des géocaches depuis l'URL", "background:orange; color:black; font-weight:bold");
            
            // Vérifier d'abord si des géocaches ont déjà été injectées par l'événement
            if (window.injectedGeocaches && Array.isArray(window.injectedGeocaches) && window.injectedGeocaches.length > 0) {
                console.log(`%c[MultiSolver] Utilisation des ${window.injectedGeocaches.length} géocaches déjà injectées`, "background:green; color:white");
                displayGeocachesList(window.injectedGeocaches);
                return;
            }
            
            // Vérifier toutes les méthodes pour obtenir les géocaches
            
            // Méthode 1: Paramètre URL standard
            const geocachesParam = new URLSearchParams(window.location.search).get('geocaches');
            
            // Méthode 2: Vérifier les attributs GoldenLayout
            const layoutData = window.parent.goldenLayoutData || window.goldenLayoutData;
            const componentState = layoutData?.componentState || {};
            
            // Tenter d'accéder directement au componentState via le parent et GoldenLayout
            try {
                if (window.parent.mainLayout) {
                    const currentContainer = window.frameElement?.closest('.lm_content')?.parentElement;
                    const containerId = currentContainer?.id;
                    
                    if (containerId) {
                        const containerItem = window.parent.mainLayout.root.getItemsById(containerId)[0];
                        
                        if (containerItem && containerItem.config && containerItem.config.componentState) {
                            console.log(`%c[MultiSolver] Accès direct au componentState:`, "background:green; color:white", containerItem.config.componentState);
                            
                            if (containerItem.config.componentState.geocaches) {
                                const geocachesData = containerItem.config.componentState.geocaches;
                                
                                if (Array.isArray(geocachesData) && geocachesData.length > 0) {
                                    geocaches = geocachesData;
                                    console.log(`%c[MultiSolver] ${geocaches.length} géocaches chargées depuis GoldenLayout componentState direct`, "background:green; color:white");
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error(`%c[MultiSolver] Erreur lors de l'accès direct au componentState:`, "background:red; color:white", error);
            }
            
            // Méthode 3: Vérifier les messages dans le sessionStorage
            const storedGeocaches = sessionStorage.getItem('multiSolverGeocaches');
            
            // Méthode 4: Vérifier l'attribut data-geocaches du conteneur
            const container = document.getElementById('multi-solver-container');
            const containerGeocaches = container?.dataset?.geocaches;
            
            console.log("%c[MultiSolver] Sources de données potentielles:", "background:orange; color:black", {
                "urlParam": geocachesParam ? "présent" : "absent",
                "layoutData": layoutData ? "présent" : "absent",
                "componentState": componentState ? "présent" : "absent",
                "sessionStorage": storedGeocaches ? "présent" : "absent",
                "containerData": containerGeocaches ? "présent" : "absent"
            });
            
            // Tenter d'obtenir les géocaches de toutes les sources possibles
            let geocaches = null;
            
            // Essayer d'abord l'attribut data-geocaches (passé par Flask)
            if (containerGeocaches) {
                try {
                    geocaches = JSON.parse(containerGeocaches);
                    console.log(`%c[MultiSolver] ${geocaches.length} géocaches chargées depuis data-geocaches`, "background:green; color:white");
                } catch (error) {
                    console.error("%c[MultiSolver] Erreur lors du décodage de data-geocaches:", "background:red; color:white", error);
                }
            }
            
            // Ensuite essayer le paramètre d'URL si nécessaire
            if (!geocaches && geocachesParam) {
                try {
                    geocaches = JSON.parse(decodeURIComponent(geocachesParam));
                    console.log(`%c[MultiSolver] ${geocaches.length} géocaches chargées depuis l'URL`, "background:green; color:white");
                } catch (error) {
                    console.error("%c[MultiSolver] Erreur lors du décodage du paramètre URL:", "background:red; color:white", error);
                }
            }
            
            // Si on n'a pas encore de géocaches, essayer les données de layout
            if (!geocaches && componentState.geocaches) {
                try {
                    geocaches = Array.isArray(componentState.geocaches) 
                        ? componentState.geocaches 
                        : JSON.parse(componentState.geocaches);
                    console.log(`%c[MultiSolver] ${geocaches.length} géocaches chargées depuis componentState`, "background:green; color:white");
                } catch (error) {
                    console.error("%c[MultiSolver] Erreur lors du décodage des données de layout:", "background:red; color:white", error);
                }
            }
            
            // Enfin, essayer le sessionStorage
            if (!geocaches && storedGeocaches) {
                try {
                    geocaches = JSON.parse(storedGeocaches);
                    console.log(`%c[MultiSolver] ${geocaches.length} géocaches chargées depuis sessionStorage`, "background:green; color:white");
                } catch (error) {
                    console.error("%c[MultiSolver] Erreur lors du décodage du sessionStorage:", "background:red; color:white", error);
                }
            }
            
            // Vérifier si on a trouvé des géocaches
            if (geocaches && Array.isArray(geocaches) && geocaches.length > 0) {
                console.log("%c[MultiSolver] Géocaches trouvées:", "background:green; color:white", geocaches);
                displayGeocachesList(geocaches);
                
                // Stocker pour une utilisation future
                try {
                    sessionStorage.setItem('multiSolverGeocaches', JSON.stringify(geocaches));
                } catch (e) {
                    console.warn("%c[MultiSolver] Impossible de stocker les géocaches dans sessionStorage", "background:orange; color:black");
                }
            } else {
                console.warn("%c[MultiSolver] Aucune géocache trouvée dans toutes les sources", "background:orange; color:black");
                const geocachesListElement = document.querySelector('[data-multi-solver-target="geocachesList"]');
                if (geocachesListElement) {
                    geocachesListElement.innerHTML = '<div class="text-gray-400">Aucune géocache sélectionnée</div>';
                    showError("Aucune géocache spécifiée. Vous pouvez quand même utiliser les plugins mais aucun traitement ne sera appliqué.");
                }
            }
        }
        
        // Fonction pour ouvrir les détails d'une géocache
        window.openGeocacheDetails = function(geocacheId, gcCode, name) {
            console.log("%c[MultiSolver] Ouverture des détails de la géocache:", "background:orange; color:black", {
                geocacheId, gcCode, name
            });
            
            // Envoyer un message au parent pour ouvrir les détails de la géocache
            window.parent.postMessage({
                type: 'openGeocacheDetails',
                geocacheId: geocacheId,
                gcCode: gcCode,
                name: name
            }, '*');
        };
        
        // Configurer les boutons du MetaSolver
        function setupMetaSolverButtons() {
            const metaSolverButtons = document.querySelectorAll('[data-action="click->multi-solver#executeMetaSolver"]');
            
            metaSolverButtons.forEach(button => {
                console.log("%c[MultiSolver] Configuration du bouton MetaSolver:", "background:orange; color:black", button.dataset.mode);
                
                // Supprimer les écouteurs d'événements existants pour éviter les doublons
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                newButton.addEventListener('click', function() {
                    const mode = this.dataset.mode;
                    console.log("%c[MultiSolver] Exécution du MetaSolver en mode:", "background:orange; color:black", mode);
                    executeMetaSolver(mode);
                });
            });
        }
        
        // Exécuter le MetaSolver
        function executeMetaSolver(mode) {
            console.log("%c[MultiSolver] Préparation de l'exécution du MetaSolver", "background:orange; color:black");
            
            // Récupérer les paramètres du MetaSolver
            const metasolverMode = document.getElementById('metasolver-mode').value;
            const metasolverStrict = document.getElementById('metasolver-strict').value;
            const metasolverAllowedChars = document.getElementById('metasolver-allowed-chars').value;
            const metasolverCustomChars = document.getElementById('metasolver-custom-chars').value;
            const metasolverEmbedded = document.getElementById('metasolver-embedded').checked;
            const metasolverGpsDetection = document.getElementById('metasolver-gps-detection').checked;
            const metasolverApplyToAll = document.getElementById('metasolver-apply-to-all').checked;
            
            // Afficher les paramètres dans la console
            console.log("%c[MultiSolver] Paramètres du MetaSolver:", "background:orange; color:black", {
                mode: metasolverMode,
                strict: metasolverStrict,
                allowedChars: metasolverAllowedChars,
                customChars: metasolverCustomChars,
                embedded: metasolverEmbedded,
                gpsDetection: metasolverGpsDetection,
                applyToAll: metasolverApplyToAll
            });
            
            // TODO: Implémentation de l'API pour le MetaSolver
            showMessage("Fonctionnalité MetaSolver en cours de développement.");
        }
        
        // Afficher un message d'erreur
        function showError(message) {
            const errorElement = document.querySelector('[data-multi-solver-target="error"]');
            if (errorElement) {
                errorElement.classList.remove('hidden');
                errorElement.querySelector('div').textContent = message;
            } else {
                console.error("%c[MultiSolver] Message d'erreur non affiché (élément manquant):", "background:red; color:white", message);
            }
        }
        
        // Afficher un message temporaire
        function showMessage(message) {
            console.log("%c[MultiSolver] Message:", "background:orange; color:black", message);
            
            // Créer un élément de message s'il n'existe pas
            let messageElement = document.getElementById('multi-solver-message');
            if (!messageElement) {
                messageElement = document.createElement('div');
                messageElement.id = 'multi-solver-message';
                messageElement.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded shadow-lg z-50 transform transition-transform duration-300 translate-y-0';
                document.body.appendChild(messageElement);
            }
            
            // Afficher le message
            messageElement.textContent = message;
            messageElement.classList.remove('translate-y-[-100px]');
            
            // Masquer le message après 3 secondes
            setTimeout(() => {
                messageElement.classList.add('translate-y-[-100px]');
            }, 3000);
        }
        
        // Fonction pour charger l'interface du plugin
        window.loadPluginInterface = async function(pluginName, container) {
            try {
                console.log("%c[MultiSolver] Chargement de l'interface du plugin:", "background:orange; color:black", pluginName);
                
                // Cacher la barre de recherche
                const searchContainer = document.getElementById('plugin-search-container');
                if (searchContainer) {
                    searchContainer.style.display = 'none';
                }
                
                // Modifier le bouton de rafraîchissement pour un bouton Retour
                const reloadButton = document.getElementById('reload-plugins-button');
                if (reloadButton) {
                    reloadButton.innerHTML = '<i class="fas fa-arrow-left mr-1"></i> Retour';
                    reloadButton.onclick = window.closePluginInterface;
                }
                
                // Afficher un loader
                container.innerHTML = `
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-700 rounded w-1/2 mb-2"></div>
                        <div class="h-4 bg-gray-700 rounded w-2/3"></div>
                    </div>
                `;
                
                // Charger l'interface du plugin
                const response = await fetch(`/api/plugins/${pluginName}/interface?context=solver`);
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const pluginInterface = await response.text();
                
                // Préparer le conteneur pour l'interface du plugin
                container.innerHTML = `
                    <div class="plugin-interface bg-gray-700/30 p-4 rounded">
                        <h3 class="text-lg font-semibold text-gray-100 mb-3">${pluginName}</h3>
                        <div class="plugin-content">${pluginInterface}</div>
                    </div>
                `;
                
                // Initialiser les scripts du plugin
                const scripts = container.querySelectorAll('script');
                scripts.forEach(script => {
                    if (script.src) {
                        const newScript = document.createElement('script');
                        newScript.src = script.src;
                        document.body.appendChild(newScript);
                    } else {
                        eval(script.innerText);
                    }
                });
                
            } catch (error) {
                console.error("%c[MultiSolver] Erreur lors du chargement de l'interface du plugin:", "background:red; color:white", error);
                container.innerHTML = `
                    <div class="bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded mb-3">
                        Erreur lors du chargement de l'interface du plugin: ${error.message}
                    </div>
                `;
            }
        };
        
        // Fonction pour fermer l'interface du plugin et revenir à la liste
        window.closePluginInterface = function() {
            console.log("%c[MultiSolver] Fermeture de l'interface du plugin", "background:orange; color:black");
            
            // Réinitialiser l'état du bouton d'exécution
            window.updateExecuteButtonState(null);
            
            const pluginContainer = document.getElementById('plugin-list-container');
            if (pluginContainer) {
                // Recharger la liste des plugins
                fetchPluginsManually(pluginContainer);
            } else {
                console.error("%c[MultiSolver] Container de plugins non trouvé lors de la fermeture", "background:red; color:white");
            }
        };
        
        // Fonction pour exécuter un plugin manuellement (sans passer par Stimulus)
        window.executePluginManually = function() {
            const executeButton = document.getElementById('execute-plugin-button');
            const pluginName = executeButton.dataset.pluginName;
            
            console.log("%c[MultiSolver] Exécution manuelle du plugin:", "background:purple; color:white", pluginName);
            
            // Au lieu d'essayer d'utiliser Stimulus, utiliser directement notre fonction window.executePlugin
            if (pluginName) {
                console.log("%c[MultiSolver] Appel de window.executePlugin directement", "background:purple; color:white");
                window.executePlugin(pluginName);
            } else {
                console.error("%c[MultiSolver] Erreur: Aucun plugin sélectionné", "background:red; color:white");
                alert("Veuillez d'abord sélectionner un plugin");
            }
        };
        
        // Initialiser après un court délai pour s'assurer que le DOM est complètement chargé
        setTimeout(initialize, 200);
    })();
</script>

<script type="text/javascript">
    // Script de secours pour s'assurer que le bouton d'exécution fonctionne
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            console.log("%c[MultiSolver] Script de secours pour le bouton d'exécution", "background:red; color:white");
            
            const execButton = document.getElementById('execute-plugin-button');
            if (execButton) {
                console.log("%c[MultiSolver] Configuration du gestionnaire d'événement de secours", "background:red; color:white");
                execButton.onclick = function(event) {
                    console.log("%c[MultiSolver] Clic sur le bouton d'exécution via le gestionnaire de secours", "background:red; color:white");
                    window.executePluginManually();
                    
                    // Empêcher la propagation de l'événement
                    event.preventDefault();
                    event.stopPropagation();
                    return false;
                };
            }
        }, 1000);
    });
</script>